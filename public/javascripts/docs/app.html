<!DOCTYPE html>  <html> <head>   <title>app.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               app.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-1">#</a>               </div>               <h2>ABApp</h2>

<p>ABApp is the main application namespace. Its typically customized
on a per-application basis.</p>             </td>             <td class="code">               <div class="highlight"><pre>   
<span class="kd">var</span> <span class="nx">ABApp</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">stream</span><span class="o">:</span> <span class="p">{},</span>  
  <span class="nx">cache</span><span class="o">:</span> <span class="nx">$H</span><span class="p">(),</span> </pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-2">#</a>               </div>               <p>Returns the shared instance of the StorageManager for interacting with the HTML5 localStorage API.  </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">sharedStorageManager</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
  	<span class="k">if</span> <span class="p">(</span><span class="nx">ABApp</span><span class="p">.</span><span class="nx">_sharedStorageManager</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
  		<span class="nx">ABApp</span><span class="p">.</span><span class="nx">_sharedStorageManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StorageManager</span><span class="p">();</span>
  	<span class="p">}</span>
  	<span class="k">return</span> <span class="nx">ABApp</span><span class="p">.</span><span class="nx">_sharedStorageManager</span><span class="p">;</span>
  <span class="p">},</span>                 
  </pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-3">#</a>               </div>               <p>Gets the shared instance of the FragmentManager for interacting with Javascript dynamic URL's.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">sharedFragmentManager</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fields</span><span class="p">,</span> <span class="nx">defaults</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
  	<span class="k">if</span> <span class="p">(</span><span class="nx">ABApp</span><span class="p">.</span><span class="nx">_sharedFragmentManager</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
  		<span class="nx">ABApp</span><span class="p">.</span><span class="nx">_sharedFragmentManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FragmentManager</span><span class="p">(</span><span class="nx">fields</span><span class="p">,</span> <span class="nx">defaults</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  	<span class="p">}</span>
  	<span class="k">return</span> <span class="nx">ABApp</span><span class="p">.</span><span class="nx">_sharedFragmentManager</span><span class="p">;</span>
  <span class="p">},</span>                             </pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-4">#</a>               </div>               <p>Returns the shared instance of WindowManager that keeps track of EUWindow instances, layering, and XHR.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">sharedWindowManager</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
  	<span class="k">if</span> <span class="p">(</span><span class="nx">ABApp</span><span class="p">.</span><span class="nx">_sharedWindowManager</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
  		<span class="nx">ABApp</span><span class="p">.</span><span class="nx">_sharedWindowManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WindowManager</span><span class="p">();</span>
  	<span class="p">}</span>
  	<span class="k">return</span> <span class="nx">ABApp</span><span class="p">.</span><span class="nx">_sharedWindowManager</span><span class="p">;</span> 
  <span class="p">},</span>              

  <span class="nx">generate_uuid</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-5">#</a>               </div>               <p>http://www.ietf.org/rfc/rfc4122.txt</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="kd">var</span> <span class="nx">hexDigits</span> <span class="o">=</span> <span class="s2">&quot;0123456789ABCDEF&quot;</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">s</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">hexDigits</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>           

      <span class="nx">s</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;4&quot;</span><span class="p">;</span>
      
      <span class="nx">s</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="nx">hexDigits</span><span class="p">.</span><span class="nx">substr</span><span class="p">((</span><span class="nx">s</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">uuid</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">uuid</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span> 

 </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-6">#</a>               </div>               <h3>ClientAuth</h3>

<p>An extension for subscription authentication.
 Uses a stored value from localStorage for the token  and username. </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">ClientAuth</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-7">#</a>               </div>               <p>Adds authentication information to outgoing subscription messages and calls a callback function to continue sending.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">outgoing</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">channel</span> <span class="o">==</span> <span class="s1">&#39;/meta/subscribe&#39;</span><span class="p">){</span>
      <span class="nx">message</span><span class="p">.</span><span class="nx">ext</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="nx">message</span><span class="p">.</span><span class="nx">ext</span><span class="p">.</span><span class="nx">authToken</span> <span class="o">=</span> <span class="nx">ABApp</span><span class="p">.</span><span class="nx">sharedStorageManager</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">);</span>
      <span class="nx">message</span><span class="p">.</span><span class="nx">ext</span><span class="p">.</span><span class="nx">authUser</span> <span class="o">=</span> <span class="nx">ABApp</span><span class="p">.</span><span class="nx">sharedStorageManager</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">);</span>
    <span class="p">}</span>                      
    <span class="nx">callback</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">},</span>      </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-8">#</a>               </div>               <p>Inserts welcome notification into messages resulting from a subscription. </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">incoming</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">channel</span> <span class="o">==</span> <span class="s2">&quot;/meta/subscribe&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">message</span><span class="p">.</span><span class="nx">successful</span> <span class="o">==</span> <span class="kc">false</span><span class="p">){</span>
      <span class="nx">message</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">message</span><span class="p">.</span><span class="nx">error</span><span class="p">;</span>  
      <span class="nx">ABApp</span><span class="p">.</span><span class="nx">chat_sub</span><span class="p">.</span><span class="nx">receive</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">channel</span> <span class="o">==</span> <span class="s2">&quot;/meta/subscribe&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">message</span><span class="p">.</span><span class="nx">successful</span> <span class="o">==</span> <span class="kc">true</span><span class="p">){</span>
      <span class="nx">ABApp</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">subscription</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">{</span>
        <span class="nx">text</span><span class="o">:</span><span class="p">(</span><span class="s2">&quot; joined the conversation on &quot;</span> <span class="o">+</span> <span class="nx">message</span><span class="p">.</span><span class="nx">subscription</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> 
        <span class="nx">username</span><span class="o">:</span> <span class="nx">ABApp</span><span class="p">.</span><span class="nx">chat_sub</span><span class="p">.</span><span class="nx">getUsername</span><span class="p">(),</span> 
        <span class="nx">persists</span><span class="o">:</span> <span class="s2">&quot;false&quot;</span><span class="p">});</span>
    <span class="p">}</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>       

 </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-9">#</a>               </div>               <h3>MentionHandler</h3>

<p>An extenson to pubsub providing mention detecting and processing.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">MentionHandler</span> <span class="o">=</span> <span class="p">{</span>                      
  </pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-10">#</a>               </div>               <p>Update the message count</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">incoming</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">channel</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;/mentions/&#39;</span><span class="o">+</span><span class="nx">ABApp</span><span class="p">.</span><span class="nx">sharedStorageManager</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">))</span> <span class="o">&amp;&amp;</span> 
        <span class="nx">message</span><span class="p">.</span><span class="nx">data</span> <span class="o">&amp;&amp;</span> 
        <span class="nx">message</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">persists</span> <span class="o">!=</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">mentions</span> <span class="o">=</span> <span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;.mentions .count&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">mentions</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
      <span class="nx">mentions</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">count</span><span class="p">).</span><span class="nx">addClassName</span><span class="p">(</span><span class="s1">&#39;new&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span> 
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>   
                                                       </pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-11">#</a>               </div>               <h2>StorageManager</h2>

<p>Aids in interacting with the HTML5 localStorage API.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">def</span> <span class="p">(</span><span class="s1">&#39;StorageManager&#39;</span><span class="p">)({</span>
                           
  <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){},</span>   </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-12">#</a>               </div>               <p>Returns the data associated with a key or <code>false</code> of no data exists.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">){</span>
	  <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">data</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="o">||</span> <span class="nx">data</span> <span class="o">==</span> <span class="kc">null</span><span class="p">){</span>
			<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
		<span class="p">}</span>
  <span class="p">},</span> </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-13">#</a>               </div>               <p>Sets data to a key in localStorage or overwrites it if it exists. Returns the set value to act chainable.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">){</span>
    <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">value</span><span class="p">;</span> <span class="c1">// Look how easily that chains...</span>
  <span class="p">}</span>
<span class="p">});</span>  </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-14">#</a>               </div>               <h2>SubscriptionManager</h2>

<p>Provides easy access to subscriptions and a facility for the storage and execution of callbacks.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">def</span> <span class="p">(</span><span class="s2">&quot;SubscriptionManager&quot;</span><span class="p">)({</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-15">#</a>               </div>               <ul>
<li>channels: an <em>Array</em> of channel names without the initial slashes.</li>
<li>element (optional): an <em>Element</em> for the messages to be inserted into.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">channels</span><span class="p">,</span> <span class="nx">element</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span> <span class="c1">// Shouldn&#39;t I just bind functions to the contexts I&#39;m working with :)</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">element</span> <span class="o">=</span> <span class="nx">element</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">channels</span> <span class="o">=</span> <span class="nx">channels</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">subscriptions</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">channels</span><span class="p">.</span><span class="nx">collect</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">channel</span><span class="p">){</span>
      <span class="k">return</span> <span class="nx">ABApp</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="nx">channel</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">){</span><span class="nx">self</span><span class="p">.</span><span class="nx">receive</span><span class="p">(</span><span class="nx">message</span><span class="p">);});</span>
    <span class="p">});</span>
  <span class="p">},</span>      </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-16">#</a>               </div>               <p>Stop receiving messages on this channel.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">cancel</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span><span class="k">this</span><span class="p">.</span><span class="nx">subscription</span><span class="p">.</span><span class="nx">cancel</span><span class="p">();},</span>
  <span class="nx">getUsername</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="nx">ABApp</span><span class="p">.</span><span class="nx">sharedStorageManager</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">);},</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-17">#</a>               </div>               <p>Receive a message on this subscription and insert it into an element as a <code>p</code> tag. If no element was provided
log the message.
<em>TODO</em> persist undisplayed messages in localStorage for later display.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">receive</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">){</span>    
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">element</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">persists</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">){</span><span class="nx">el</span><span class="p">.</span><span class="nx">addClassName</span><span class="p">(</span><span class="s2">&quot;persists-false&quot;</span><span class="p">);}</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span>
        <span class="p">{</span><span class="nx">top</span><span class="o">:</span> <span class="nx">el</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="s2">&quot;&lt;span class=&#39;user&#39;&gt;@&quot;</span> <span class="o">+</span> <span class="nx">message</span><span class="p">.</span><span class="nx">username</span> <span class="o">+</span> <span class="s2">&quot;&lt;/span&gt;&quot;</span> <span class="o">+</span> <span class="nx">message</span><span class="p">.</span><span class="nx">text</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">hide</span><span class="p">()</span>
                  <span class="p">.</span><span class="nx">appear</span><span class="p">()</span>
        <span class="p">});</span>      
        
      <span class="nx">Event</span><span class="p">.</span><span class="nx">addBehavior</span><span class="p">.</span><span class="nx">reload</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span> 
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Unrouted Message:&quot;</span> <span class="o">+</span> <span class="nx">message</span><span class="p">.</span><span class="nx">text</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span>  </pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-18">#</a>               </div>               <p>Send text to the server for publishing.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">send</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">send_text</span><span class="p">){</span>
    <span class="nx">ABApp</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">{</span><span class="nx">text</span><span class="o">:</span> <span class="nx">send_text</span><span class="p">,</span> <span class="nx">username</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">getUsername</span><span class="p">()});</span>
  <span class="p">},</span>
<span class="p">});</span>    </pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-19">#</a>               </div>               <h2>FragmentManager</h2>

<p>Helps manage url fragments for applications using client-side views.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">def</span><span class="p">(</span><span class="s2">&quot;FragmentManager&quot;</span><span class="p">)({</span>
	<span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">lurl</span><span class="p">,</span> <span class="nx">defaults</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span> 
		<span class="k">if</span> <span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="o">||</span> <span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">){</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">;</span>			
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-20">#</a>               </div>               <p>this.value = window.location.hash.substring(1);</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="p">}</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">template</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Template</span><span class="p">(</span><span class="nx">lurl</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">parts</span> <span class="o">=</span> <span class="nx">$H</span><span class="p">(</span><span class="nx">defaults</span><span class="p">);</span>           
		<span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">){</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">callback</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">;</span>
		<span class="p">}</span><span class="k">else</span><span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">callback</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="k">this</span><span class="p">;}</span>
		<span class="p">}</span>
		
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">setupChecker</span><span class="p">();</span>
	<span class="p">},</span>   
	<span class="nx">setupChecker</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">checker</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PeriodicalExecuter</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_checker</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">);</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">;</span>
	<span class="p">},</span>
	<span class="nx">_checker</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">!=</span> <span class="s2">&quot;#&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">!=</span> <span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">){</span>
    	<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">+</span> <span class="s2">&quot; vs. &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">checker</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">updateHash</span><span class="p">().</span><span class="nx">callback</span><span class="p">().</span><span class="nx">setupChecker</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">){</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">parts</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
		
		<span class="k">return</span> <span class="k">this</span><span class="p">;</span>
	<span class="p">},</span>
	<span class="nx">updateHash</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>  
		<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">!=</span> <span class="kc">undefined</span><span class="p">){</span>
			<span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>			
		<span class="p">}</span><span class="k">else</span><span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">;</span>
	<span class="p">},</span>
	<span class="nx">update</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>   
		<span class="k">return</span> <span class="k">this</span><span class="p">;</span>
	<span class="p">},</span>
	<span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">parts</span><span class="p">.</span><span class="nx">toTemplateReplacements</span><span class="p">()));</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">});</span>
         </pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-21">#</a>               </div>               <h2>WindowManager</h2>

<p>Manages a collection of <em>EUWindow</em> instances and controls their z-order.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">def</span><span class="p">(</span><span class="s2">&quot;WindowManager&quot;</span><span class="p">)({</span>
  <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>      
    <span class="k">this</span><span class="p">.</span><span class="nx">pool</span> <span class="o">=</span> <span class="nx">$H</span><span class="p">();</span> 
    <span class="k">this</span><span class="p">.</span><span class="nx">EUWMProxyCount</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;app_element&#39;</span><span class="p">)){</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">element</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;app_element&quot;</span><span class="p">});</span>
			<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">)</span>
		<span class="p">}</span><span class="k">else</span><span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;app_element&#39;</span><span class="p">);</span>
		<span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">add</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">instance</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">ABApp</span><span class="p">.</span><span class="nx">generate_uuid</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pool</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">instance</span><span class="p">);</span>      
    
    <span class="nx">instance</span><span class="p">.</span><span class="nx">euwindow</span><span class="p">.</span><span class="nx">writeAttribute</span><span class="p">(</span><span class="s1">&#39;data-eid&#39;</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>
  <span class="p">},</span>                              
  <span class="nx">recall</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">readAttribute</span><span class="p">(</span><span class="s1">&#39;data-eid&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">pool</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>                                  </pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-22">#</a>               </div>               <h2>Application Code</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-23">#</a>               </div>               <p>Wait for the document to be ready.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">document</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class="s1">&#39;dom:loaded&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">stopObserving</span><span class="p">(</span><span class="s1">&#39;dom:loaded&#39;</span><span class="p">);</span>
                                          </pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-24">#</a>               </div>               <p>Setup the Faye client.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">ABApp</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Faye</span><span class="p">.</span><span class="nx">Client</span><span class="p">(</span><span class="s1">&#39;http://bubbles.local/faye&#39;</span><span class="p">);</span>
  </pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-25">#</a>               </div>               <p>Add extensions</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">ABApp</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">addExtension</span><span class="p">(</span><span class="nx">ClientAuth</span><span class="p">);</span> 
  <span class="nx">ABApp</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">addExtension</span><span class="p">(</span><span class="nx">MentionHandler</span><span class="p">);</span>         
       
  </pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-26">#</a>               </div>               <h3>Event Delegation</h3>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Event</span><span class="p">.</span><span class="nx">addBehavior</span><span class="p">({</span>  </pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-27">#</a>               </div>               <p>Sets up th subscription to the main chat channel.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s2">&quot;form.login:submit&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
      <span class="nx">Event</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>      
      <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">down</span><span class="p">(</span><span class="s2">&quot;input[type=text]&quot;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">username</span> <span class="o">=</span> <span class="nx">$F</span><span class="p">(</span><span class="nx">el</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">();</span>
      <span class="nx">ABApp</span><span class="p">.</span><span class="nx">chat_sub</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SubscriptionManager</span><span class="p">(</span><span class="s2">&quot;chat&quot;</span><span class="p">,</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;main_stream&#39;</span><span class="p">));</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">fade</span><span class="p">(</span><span class="cm">/*{duration:.25, queue:&#39;end&#39;}*/</span><span class="p">);</span>
      <span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;form.publisher&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">().</span><span class="nx">appear</span><span class="p">();</span>
      
      <span class="nb">window</span><span class="p">.</span><span class="nx">onbeforeunload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(){</span>
        <span class="k">return</span> <span class="nx">ABApp</span><span class="p">.</span><span class="nx">chat_sub</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;left the chat.&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      
    <span class="p">},</span>         </pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-28">#</a>               </div>               <p>Publisher for the main chat channel. </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s2">&quot;form.publisher:submit&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
      <span class="nx">Event</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">down</span><span class="p">(</span><span class="s1">&#39;input[type=text]&#39;</span><span class="p">);</span>
      <span class="nx">ABApp</span><span class="p">.</span><span class="nx">chat_sub</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">$F</span><span class="p">(</span><span class="nx">el</span><span class="p">));</span>
      <span class="nx">el</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
    <span class="p">},</span> 
    <span class="s2">&quot;form.publisher input[type=text]:drop&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
    <span class="p">},</span>  </pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-29">#</a>               </div>               <p>Image zoomer</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s2">&quot;.messages p img:click&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">orig</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="nx">orig</span><span class="p">.</span><span class="nx">clone</span><span class="p">().</span><span class="nx">absolutize</span><span class="p">();</span>
      <span class="nx">Element</span><span class="p">.</span><span class="nx">clonePosition</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">orig</span><span class="p">,</span> <span class="p">{</span><span class="nx">setWidth</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">setHeight</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">setStyle</span><span class="p">({</span>
        <span class="s1">&#39;height&#39;</span><span class="o">:</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="s1">&#39;width&#39;</span><span class="o">:</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="s1">&#39;border&#39;</span><span class="o">:</span><span class="s1">&#39;4px solid #fff&#39;</span><span class="p">,</span>
        <span class="s1">&#39;-webkit-box-shadow&#39;</span><span class="o">:</span><span class="s1">&#39;rgba(0,0,0,.15) 0px 2px 4px 1px&#39;</span>
        <span class="p">}));</span>
      <span class="nx">orig</span><span class="p">.</span><span class="nx">morph</span><span class="p">(</span><span class="s2">&quot;opacity:0&quot;</span><span class="p">);</span>
      <span class="nx">el</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class="s1">&#39;mouseout&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
        <span class="nx">el</span><span class="p">.</span><span class="nx">fade</span><span class="p">({</span><span class="nx">duration</span><span class="o">:</span><span class="p">.</span><span class="mi">25</span><span class="p">});</span>
        <span class="nx">orig</span><span class="p">.</span><span class="nx">morph</span><span class="p">(</span><span class="s2">&quot;opacity:1&quot;</span><span class="p">,{</span><span class="nx">duration</span><span class="o">:</span><span class="p">.</span><span class="mi">25</span><span class="p">});</span>
      <span class="p">})</span>
    <span class="p">},</span>     </pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-30">#</a>               </div>               <p>Save the auth token.
* To be replaced by actual login system.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s2">&quot;form.save_auth_token:submit&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>     
      <span class="nx">Event</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">$F</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">down</span><span class="p">(</span><span class="s2">&quot;input[type=text][name=token]&quot;</span><span class="p">));</span>
      <span class="kd">var</span> <span class="nx">username</span> <span class="o">=</span> <span class="nx">$F</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">down</span><span class="p">(</span><span class="s2">&quot;input[type=text][name=username]&quot;</span><span class="p">));</span>
      <span class="nx">ABApp</span><span class="p">.</span><span class="nx">sharedStorageManager</span><span class="p">().</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>
      <span class="nx">ABApp</span><span class="p">.</span><span class="nx">sharedStorageManager</span><span class="p">().</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="nx">username</span><span class="p">);</span>

      <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="p">;</span>
    <span class="p">},</span>                                          </pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-31">#</a>               </div>               <p>Pre-fill publisher when a user replys to a message.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s2">&quot;.messages p span.user:click&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(){</span>
      <span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;form.publisher&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">().</span><span class="nx">down</span><span class="p">(</span><span class="s2">&quot;input[type=text]&quot;</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">.</span><span class="nx">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">;</span>
      <span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;form.publisher&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">().</span><span class="nx">down</span><span class="p">(</span><span class="s2">&quot;input[type=text]&quot;</span><span class="p">).</span><span class="nx">focus</span><span class="p">();</span>
    <span class="p">},</span>    
    </pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-32">#</a>               </div>               <p>Open the mentions panel.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s2">&quot;li.mentions:click&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(){</span>
      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="nx">Element</span><span class="p">.</span><span class="nx">clonePosition</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;mention_stream&#39;</span><span class="p">),</span> <span class="nx">self</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">setWidth</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span>
        <span class="nx">setHeight</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span>
        <span class="nx">offsetTop</span><span class="o">:</span> <span class="mi">35</span><span class="p">,</span>
        <span class="nx">offsetLeft</span><span class="o">:</span> <span class="o">-</span><span class="mi">255</span><span class="p">});</span>
        
      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">hasClassName</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">)){</span><span class="nx">self</span><span class="p">.</span><span class="nx">removeClassName</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">);}</span>
      <span class="k">else</span><span class="p">{</span><span class="nx">self</span><span class="p">.</span><span class="nx">addClassName</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">);}</span>
      
      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;mention_stream&#39;</span><span class="p">).</span><span class="nx">toggle</span><span class="p">();</span>
    <span class="p">},</span>         </pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-33">#</a>               </div>               <p>Load additional mentions.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s2">&quot;#mention_stream .command a:click&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
      <span class="nx">Event</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="nx">ABApp</span><span class="p">.</span><span class="nx">sharedStorageManager</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;last_mention_pull&#39;</span><span class="p">);</span>
                
      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">mentions</span> <span class="o">=</span> <span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;.mentions .count&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">mentions</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
     
      <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="s2">&quot;Please wait&amp;hellip;&quot;</span><span class="p">);</span>
      
      <span class="k">new</span> <span class="nx">Ajax</span><span class="p">.</span><span class="nx">Request</span><span class="p">(</span><span class="s2">&quot;/mentions/&quot;</span><span class="o">+</span><span class="nx">ABApp</span><span class="p">.</span><span class="nx">sharedStorageManager</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">),</span> <span class="p">{</span>
        <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span>
        <span class="nx">parameters</span><span class="o">:</span> <span class="p">{</span><span class="nx">since</span><span class="o">:</span> <span class="nx">date</span><span class="p">},</span>
        <span class="nx">onSuccess</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">transport</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">transport</span><span class="p">.</span><span class="nx">responseText</span><span class="p">.</span><span class="nx">evalJSON</span><span class="p">();</span>
          <span class="nx">data</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">){</span>
            <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
            <span class="nx">mentions</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">count</span><span class="p">).</span><span class="nx">addClassName</span><span class="p">(</span><span class="s1">&#39;new&#39;</span><span class="p">);</span>
            <span class="nx">ABApp</span><span class="p">.</span><span class="nx">metion_sub</span><span class="p">.</span><span class="nx">receive</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
          <span class="p">});</span>
          <span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
          <span class="nx">ABApp</span><span class="p">.</span><span class="nx">sharedStorageManager</span><span class="p">().</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;last_mention_pull&#39;</span><span class="p">,</span> <span class="nx">date</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
        <span class="p">},</span> 
        <span class="nx">onComplete</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="s2">&quot;you&#39;re seeing everything&quot;</span><span class="p">).</span><span class="nx">addClassName</span><span class="p">(</span><span class="s1">&#39;inactive&#39;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">},</span>            
    
    <span class="s2">&quot;form.remote:submit&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
			<span class="nx">Event</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
			<span class="nx">self</span><span class="p">.</span><span class="nx">request</span><span class="p">({</span>
				<span class="nx">onSuccess</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">transport</span><span class="p">){</span>          
				  <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">hasClassName</span><span class="p">(</span><span class="s1">&#39;closes&#39;</span><span class="p">)){</span>
  					<span class="nx">self</span><span class="p">.</span><span class="nx">up</span><span class="p">(</span><span class="s1">&#39;.form&#39;</span><span class="p">).</span><span class="nx">fade</span><span class="p">({</span><span class="nx">duration</span><span class="o">:</span> <span class="p">.</span><span class="mi">15</span><span class="p">});</span>				    
				  <span class="p">}</span>
          <span class="k">new</span> <span class="nx">ABMessage</span><span class="p">(</span><span class="nx">transport</span><span class="p">.</span><span class="nx">responseText</span><span class="p">,</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;success&#39;</span><span class="p">});</span>
				<span class="p">},</span>
				<span class="nx">onFailure</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">transport</span><span class="p">){</span>
          <span class="k">new</span> <span class="nx">ABMessage</span><span class="p">(</span><span class="nx">transport</span><span class="p">.</span><span class="nx">responseText</span><span class="p">,</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;error&#39;</span><span class="p">});</span>
				<span class="p">}</span>
			<span class="p">});</span>
		<span class="p">},</span>  
		</pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-34">#</a>               </div>               <p>General handler for popup links. Utilizes an <em>EUWindow</em></p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="s2">&quot;a.popup:click&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="nx">Event</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">euw</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EUWindow</span><span class="p">();</span>
      <span class="nx">euw</span><span class="p">.</span><span class="nx">insertWithMessage</span><span class="p">();</span>
      <span class="nx">euw</span><span class="p">.</span><span class="nx">insertFromURL</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readAttribute</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">hasClassName</span><span class="p">(</span><span class="s2">&quot;_sender_closes&quot;</span><span class="p">)){</span>
        <span class="nx">EUWindow</span><span class="p">.</span><span class="nx">destroyWindow</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">up</span><span class="p">(</span><span class="s2">&quot;.EUWindow&quot;</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
                      </pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-35">#</a>               </div>               <h3>Run at Load Time</h3>             </td>             <td class="code">               <div class="highlight"><pre>                                 </pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-36">#</a>               </div>               <p>Automatically logs a user in if their token is saves.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">ABApp</span><span class="p">.</span><span class="nx">sharedStorageManager</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">){</span>
    <span class="nx">ABApp</span><span class="p">.</span><span class="nx">chat_sub</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SubscriptionManager</span><span class="p">([</span><span class="s2">&quot;chat&quot;</span><span class="p">],</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;main_stream&#39;</span><span class="p">));</span>  
    <span class="k">if</span> <span class="p">(</span><span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;.login&#39;</span><span class="p">).</span><span class="nx">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
      <span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;.login&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">().</span><span class="nx">fade</span><span class="p">();</span>
      <span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;form.publisher&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">().</span><span class="nx">appear</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
      </pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-37">#</a>               </div>               <p>This checks to see if there are any mentions in the mention stream container.
If there aren't, it'll run XHR to get all the mentions since the last time
the user pulled from this browser. Presently the server does not persist
a user's access history, although that is also planned. </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;mention_stream&#39;</span><span class="p">).</span><span class="nx">childElements</span><span class="p">().</span><span class="nx">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="nx">ABApp</span><span class="p">.</span><span class="nx">sharedStorageManager</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;last_mention_pull&#39;</span><span class="p">);</span>
    
    <span class="kd">var</span> <span class="nx">mentions</span> <span class="o">=</span> <span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;.mentions .count&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">mentions</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
    
    <span class="k">new</span> <span class="nx">Ajax</span><span class="p">.</span><span class="nx">Request</span><span class="p">(</span><span class="s2">&quot;/mentions/&quot;</span><span class="o">+</span><span class="nx">ABApp</span><span class="p">.</span><span class="nx">sharedStorageManager</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">),</span> <span class="p">{</span>
      <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span>
      <span class="nx">parameters</span><span class="o">:</span> <span class="p">{</span><span class="nx">since</span><span class="o">:</span> <span class="nx">date</span><span class="p">},</span>
      <span class="nx">onSuccess</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">transport</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">transport</span><span class="p">.</span><span class="nx">responseText</span><span class="p">.</span><span class="nx">evalJSON</span><span class="p">();</span>  
        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
          <span class="nx">Sound</span><span class="p">.</span><span class="nx">play</span><span class="p">(</span><span class="s1">&#39;/NewMail.aiff&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">){</span>
          <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
          <span class="nx">mentions</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">count</span><span class="p">).</span><span class="nx">addClassName</span><span class="p">(</span><span class="s1">&#39;new&#39;</span><span class="p">);</span>
          <span class="nx">ABApp</span><span class="p">.</span><span class="nx">metion_sub</span><span class="p">.</span><span class="nx">receive</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
        <span class="nx">ABApp</span><span class="p">.</span><span class="nx">sharedStorageManager</span><span class="p">().</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;last_mention_pull&#39;</span><span class="p">,</span> <span class="nx">date</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
      <span class="p">},</span> 
    <span class="p">});</span>
  <span class="p">}</span>
  </pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-38">#</a>               </div>               <p>Create an instance of SubscritionManager to watch for and handle mentions.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">ABApp</span><span class="p">.</span><span class="nx">metion_sub</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SubscriptionManager</span><span class="p">([</span><span class="s1">&#39;mentions/&#39;</span><span class="o">+</span><span class="nx">ABApp</span><span class="p">.</span><span class="nx">sharedStorageManager</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)],</span>
                                              <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;mention_stream&#39;</span><span class="p">));</span>
  
<span class="p">});</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 