<!DOCTYPE html>  <html> <head>   <title>app.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="abapp.html">                 abapp.js               </a>                                           <a class="source" href="abmessage.html">                 abmessage.js               </a>                                           <a class="source" href="app.html">                 app.js               </a>                                           <a class="source" href="compiler.html">                 compiler.js               </a>                                           <a class="source" href="def.html">                 def.js               </a>                                           <a class="source" href="euwindow.html">                 euwindow.js               </a>                                           <a class="source" href="faye_ext.html">                 faye_ext.js               </a>                                           <a class="source" href="handlebars.html">                 handlebars.js               </a>                                           <a class="source" href="lowpro.html">                 lowpro.js               </a>                                           <a class="source" href="managers.html">                 managers.js               </a>                                           <a class="source" href="mustache.html">                 mustache.js               </a>                                           <a class="source" href="protoaculous.min.html">                 protoaculous.min.js               </a>                                           <a class="source" href="prototype.html">                 prototype.js               </a>                                           <a class="source" href="prototype.s2.min.html">                 prototype.s2.min.js               </a>                                           <a class="source" href="sha1.html">                 sha1.js               </a>                                           <a class="source" href="templates.html">                 templates.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               app.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h2>Application Code</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Wait for the document to be ready.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">document</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class="s1">&#39;dom:loaded&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>

	<span class="nx">ABApp</span><span class="p">.</span><span class="nx">behaviors</span><span class="p">[</span><span class="s1">&#39;SubscriptionManager#popstream&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
		<span class="k">return</span> <span class="p">(</span><span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>We want to add specific behavior for the beginning of this pull.
This stuff should be abstracted into a module, since it applies to any streams with a reload button.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="p">.</span><span class="nx">addHook</span><span class="p">(</span><span class="s1">&#39;pullBegin&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">down</span><span class="p">(</span><span class="s2">&quot;.command a&quot;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="s2">&quot;Fetching messages&amp;hellip;&quot;</span><span class="p">);})</span>
    <span class="p">.</span><span class="nx">addHook</span><span class="p">(</span><span class="s1">&#39;pullComplete&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">down</span><span class="p">(</span><span class="s2">&quot;.command a.pull&quot;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="s2">&quot;Load More&quot;</span><span class="p">);})</span>
    <span class="p">.</span><span class="nx">addHook</span><span class="p">(</span><span class="s1">&#39;pull500&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">down</span><span class="p">(</span><span class="s2">&quot;.command&quot;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="s2">&quot;Unable to connect to archive.&quot;</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">addHook</span><span class="p">(</span><span class="s1">&#39;pulledContent&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">getCounter</span><span class="p">().</span><span class="nx">addClassName</span><span class="p">(</span><span class="s1">&#39;new&#39;</span><span class="p">);})</span>
		<span class="p">.</span><span class="nx">pull</span><span class="p">()</span>
		<span class="p">);</span>
	<span class="p">};</span>
	
  <span class="nb">document</span><span class="p">.</span><span class="nx">stopObserving</span><span class="p">(</span><span class="s1">&#39;dom:loaded&#39;</span><span class="p">);</span>   

	<span class="nb">window</span><span class="p">.</span><span class="nx">onresize</span> <span class="o">=</span> <span class="nx">ABMessageResizer</span><span class="p">;</span>	
	<span class="nb">window</span><span class="p">.</span><span class="nx">onscroll</span> <span class="o">=</span> <span class="nx">ABMessageResizer</span><span class="p">;</span>
                                          </pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Setup the Faye client.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">ABApp</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Faye</span><span class="p">.</span><span class="nx">Client</span><span class="p">(</span><span class="s1">&#39;http://desk.austinbales.com/faye&#39;</span><span class="p">);</span>
  </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Add extensions</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">ABApp</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">addExtension</span><span class="p">(</span><span class="nx">ClientAuth</span><span class="p">);</span> 
  <span class="nx">ABApp</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">addExtension</span><span class="p">(</span><span class="nx">MentionHandler</span><span class="p">);</span>
  <span class="nx">ABApp</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">addExtension</span><span class="p">(</span><span class="nx">GroupFilter</span><span class="p">);</span>   
  
  
  <span class="k">if</span><span class="p">(</span><span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;.save_auth_token&#39;</span><span class="p">).</span><span class="nx">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// End of if logged in block.</span>
    <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span><span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;.save_auth_token&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">$F</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">down</span><span class="p">(</span><span class="s2">&quot;input[type=text][name=token]&quot;</span><span class="p">));</span>
    <span class="kd">var</span> <span class="nx">username</span> <span class="o">=</span> <span class="nx">$F</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">down</span><span class="p">(</span><span class="s2">&quot;input[type=text][name=username]&quot;</span><span class="p">));</span>
    <span class="kd">var</span> <span class="nx">userid</span> <span class="o">=</span> <span class="nx">$F</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">down</span><span class="p">(</span><span class="s2">&quot;input[type=text][name=userid]&quot;</span><span class="p">));</span>
    <span class="nx">ABApp</span><span class="p">.</span><span class="nx">sharedStorageManager</span><span class="p">().</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>
    <span class="nx">ABApp</span><span class="p">.</span><span class="nx">sharedStorageManager</span><span class="p">().</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="nx">username</span><span class="p">);</span>
    <span class="nx">ABApp</span><span class="p">.</span><span class="nx">sharedStorageManager</span><span class="p">().</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;userid&#39;</span><span class="p">,</span> <span class="nx">userid</span><span class="p">);</span>

    <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="p">;</span>
  <span class="p">}</span>     
       
  </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h3>Event Delegation</h3>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Event</span><span class="p">.</span><span class="nx">addBehavior</span><span class="p">({</span>  </pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Sets up th subscription to the main chat channel.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s2">&quot;form.login:submit&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
      <span class="nx">Event</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>      
      <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">down</span><span class="p">(</span><span class="s2">&quot;input[type=text]&quot;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">username</span> <span class="o">=</span> <span class="nx">$F</span><span class="p">(</span><span class="nx">el</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">();</span>
      <span class="nx">ABApp</span><span class="p">.</span><span class="nx">channels</span><span class="p">[</span><span class="s1">&#39;chat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SubscriptionManager</span><span class="p">(</span><span class="s2">&quot;chat&quot;</span><span class="p">,</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;main_stream&#39;</span><span class="p">));</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">fade</span><span class="p">(</span><span class="cm">/*{duration:.25, queue:&#39;end&#39;}*/</span><span class="p">);</span>
      <span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;form.publisher&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">().</span><span class="nx">appear</span><span class="p">();</span>
      
      <span class="nb">window</span><span class="p">.</span><span class="nx">onbeforeunload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(){</span>
        <span class="k">return</span> <span class="nx">ABApp</span><span class="p">.</span><span class="nx">channels</span><span class="p">[</span><span class="s1">&#39;chat&#39;</span><span class="p">].</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;left the chat.&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      
    <span class="p">},</span> 
    <span class="s2">&quot;button.local_popup:click&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
      <span class="nx">EUWindowWaker</span><span class="p">.</span><span class="nx">wake</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
    <span class="p">},</span>        </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Publisher for the main chat channel. </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s2">&quot;form.publisher:submit&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
      <span class="nx">Event</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">down</span><span class="p">(</span><span class="s1">&#39;input[type=text]&#39;</span><span class="p">);</span>
      <span class="nx">ABApp</span><span class="p">.</span><span class="nx">channels</span><span class="p">[</span><span class="s1">&#39;chat&#39;</span><span class="p">].</span><span class="nx">send</span><span class="p">(</span><span class="nx">$F</span><span class="p">(</span><span class="nx">el</span><span class="p">));</span>
      <span class="nx">el</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
    <span class="p">},</span> 
    <span class="s2">&quot;form.publisher input[type=text]:drop&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
    <span class="p">},</span>  </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Image zoomer</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s2">&quot;.messages p img:click&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">orig</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="nx">orig</span><span class="p">.</span><span class="nx">clone</span><span class="p">().</span><span class="nx">absolutize</span><span class="p">();</span>
      <span class="nx">Element</span><span class="p">.</span><span class="nx">clonePosition</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">orig</span><span class="p">,</span> <span class="p">{</span><span class="nx">setWidth</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">setHeight</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">setStyle</span><span class="p">({</span>
        <span class="s1">&#39;height&#39;</span><span class="o">:</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="s1">&#39;width&#39;</span><span class="o">:</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="s1">&#39;border&#39;</span><span class="o">:</span><span class="s1">&#39;4px solid #fff&#39;</span><span class="p">,</span>
        <span class="s1">&#39;-webkit-box-shadow&#39;</span><span class="o">:</span><span class="s1">&#39;rgba(0,0,0,.15) 0px 2px 4px 1px&#39;</span>
        <span class="p">}));</span>
      <span class="nx">orig</span><span class="p">.</span><span class="nx">morph</span><span class="p">(</span><span class="s2">&quot;opacity:0&quot;</span><span class="p">);</span>
      <span class="nx">el</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class="s1">&#39;mouseout&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
        <span class="nx">el</span><span class="p">.</span><span class="nx">fade</span><span class="p">({</span><span class="nx">duration</span><span class="o">:</span><span class="p">.</span><span class="mi">25</span><span class="p">});</span>
        <span class="nx">orig</span><span class="p">.</span><span class="nx">morph</span><span class="p">(</span><span class="s2">&quot;opacity:1&quot;</span><span class="p">,{</span><span class="nx">duration</span><span class="o">:</span><span class="p">.</span><span class="mi">25</span><span class="p">});</span>
      <span class="p">})</span>
    <span class="p">},</span> 
    <span class="cm">/*&quot;form.publisher input[type=text]:keypress&quot;:function(event){</span>
<span class="cm">	  	console.log(event.keyCode);</span>
<span class="cm">		},*/</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Save the auth token.
* To be replaced by actual login system.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s2">&quot;input[name=channel[name]]:blur&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(){</span>
      <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">sub</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)){</span>
        <span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">sub</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="s2">&quot;form:submit&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(){</span>
       <span class="nx">chan</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">down</span><span class="p">(</span><span class="s1">&#39;input[name=channel[name]]&#39;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">chan</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">chan</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">sub</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)){</span>
          <span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">sub</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">chan</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">},</span>                                       </pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Pre-fill publisher when a user replys to a message.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s2">&quot;.messages p span.user:click&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(){</span>
      <span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;form.publisher&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">().</span><span class="nx">down</span><span class="p">(</span><span class="s2">&quot;input[type=text]&quot;</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">.</span><span class="nx">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">;</span>
      <span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;form.publisher&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">().</span><span class="nx">down</span><span class="p">(</span><span class="s2">&quot;input[type=text]&quot;</span><span class="p">).</span><span class="nx">focus</span><span class="p">();</span>
    <span class="p">},</span>    
    </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Open the mentions panel.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s2">&quot;li.tracker:click&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(){</span>
      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">channel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">readAttribute</span><span class="p">(</span><span class="s1">&#39;data-channel&#39;</span><span class="p">);</span>
      <span class="nx">ABApp</span><span class="p">.</span><span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">showStreamContainer</span><span class="p">(</span><span class="nx">self</span><span class="p">);</span>
    <span class="p">},</span>         </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Load additional mentions.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s2">&quot;.command a.pull:click&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
      <span class="nx">Event</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">channel_name</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">up</span><span class="p">(</span><span class="s1">&#39;.messages&#39;</span><span class="p">).</span><span class="nx">readAttribute</span><span class="p">(</span><span class="s2">&quot;data-channel&quot;</span><span class="p">);</span>
      <span class="nx">ABApp</span><span class="p">.</span><span class="nx">channels</span><span class="p">[</span><span class="nx">channel_name</span><span class="p">].</span><span class="nx">pull</span><span class="p">();</span>      
    <span class="p">},</span>            
    <span class="s2">&quot;.command a.focus:click&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
      <span class="nx">Event</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">channel_name</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">up</span><span class="p">(</span><span class="s1">&#39;.messages&#39;</span><span class="p">).</span><span class="nx">readAttribute</span><span class="p">(</span><span class="s2">&quot;data-channel&quot;</span><span class="p">);</span>
			<span class="kd">var</span> <span class="nx">old_channel_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;main_stream&#39;</span><span class="p">).</span><span class="nx">readAttribute</span><span class="p">(</span><span class="s2">&quot;data-channel&quot;</span><span class="p">);</span>
			<span class="nx">ABApp</span><span class="p">.</span><span class="nx">channels</span><span class="p">[</span><span class="nx">old_channel_name</span><span class="p">].</span><span class="nx">createTracker</span><span class="p">().</span><span class="nx">createStreamContainer</span><span class="p">().</span><span class="nx">addBehavior</span><span class="p">(</span><span class="s2">&quot;popstream&quot;</span><span class="p">);</span>
			<span class="nx">ABApp</span><span class="p">.</span><span class="nx">channels</span><span class="p">[</span><span class="nx">channel_name</span><span class="p">].</span><span class="nx">unregisterElements</span><span class="p">().</span><span class="nx">setStreamContainer</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;main_stream&#39;</span><span class="p">));</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>ABApp.channels[channel<em>name].unregisterTracker().swapStreamContainers(ABApp.channels[old</em>channel_name].createTracker());</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">Event</span><span class="p">.</span><span class="nx">addBehavior</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span>
		<span class="p">},</span>
		<span class="s1">&#39;.command a.leave:click&#39;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
      <span class="nx">Event</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">channel_name</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">up</span><span class="p">(</span><span class="s1">&#39;.messages&#39;</span><span class="p">).</span><span class="nx">readAttribute</span><span class="p">(</span><span class="s2">&quot;data-channel&quot;</span><span class="p">);</span>
      <span class="nx">ABApp</span><span class="p">.</span><span class="nx">channels</span><span class="p">[</span><span class="nx">channel_name</span><span class="p">].</span><span class="nx">cancel</span><span class="p">();</span>
		<span class="p">},</span>
    <span class="s2">&quot;form.remote:submit&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">up</span><span class="p">(</span><span class="s1">&#39;.EUWindow&#39;</span><span class="p">)){</span>
  			<span class="nx">Event</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  			<span class="nx">$$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">identify</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; input.from_ls&#39;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">s</span><span class="p">){</span> 
  				<span class="nx">s</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">ABApp</span><span class="p">.</span><span class="nx">sharedStorageManager</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">readAttribute</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">));</span>
  			<span class="p">});</span>
  			<span class="nx">self</span><span class="p">.</span><span class="nx">request</span><span class="p">({</span>
  				<span class="nx">onSuccess</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">transport</span><span class="p">){</span>          
  				  <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">hasClassName</span><span class="p">(</span><span class="s1">&#39;closes&#39;</span><span class="p">)){</span>
    					<span class="nx">self</span><span class="p">.</span><span class="nx">up</span><span class="p">(</span><span class="s1">&#39;.form&#39;</span><span class="p">).</span><span class="nx">fade</span><span class="p">({</span><span class="nx">duration</span><span class="o">:</span> <span class="p">.</span><span class="mi">35</span><span class="p">});</span>				    
  				  <span class="p">}</span>
            <span class="k">new</span> <span class="nx">ABMessage</span><span class="p">(</span><span class="nx">transport</span><span class="p">.</span><span class="nx">responseText</span><span class="p">,</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;success&#39;</span><span class="p">});</span>
  				<span class="p">},</span>
  				<span class="nx">onFailure</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">transport</span><span class="p">){</span>
            <span class="k">new</span> <span class="nx">ABMessage</span><span class="p">(</span><span class="nx">transport</span><span class="p">.</span><span class="nx">responseText</span><span class="p">,</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;error&#39;</span><span class="p">});</span>
  				<span class="p">}</span>
  			<span class="p">});</span>
		  <span class="p">}</span>
		<span class="p">},</span>  
		</pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>General handler for popup links. Utilizes an <em>EUWindow</em></p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="s2">&quot;a.popup:click&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="nx">Event</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">euw</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EUWindow</span><span class="p">();</span>
      <span class="nx">euw</span><span class="p">.</span><span class="nx">insertWithMessage</span><span class="p">();</span>
      <span class="nx">euw</span><span class="p">.</span><span class="nx">insertFromURL</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readAttribute</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">hasClassName</span><span class="p">(</span><span class="s2">&quot;_sender_closes&quot;</span><span class="p">)){</span>
        <span class="nx">EUWindow</span><span class="p">.</span><span class="nx">destroyWindow</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">up</span><span class="p">(</span><span class="s2">&quot;.EUWindow&quot;</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
                      </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h3>Run at Load Time</h3>             </td>             <td class="code">               <div class="highlight"><pre>                                 </pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Automatically logs a user in if their token is saves.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">ABApp</span><span class="p">.</span><span class="nx">sharedStorageManager</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">){</span>
    <span class="nx">ABApp</span><span class="p">.</span><span class="nx">channels</span><span class="p">[</span><span class="s1">&#39;chat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SubscriptionManager</span><span class="p">([</span><span class="s2">&quot;chat&quot;</span><span class="p">]).</span><span class="nx">setStreamContainer</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;main_stream&#39;</span><span class="p">)).</span><span class="nx">addBehavior</span><span class="p">(</span><span class="s1">&#39;popstream&#39;</span><span class="p">);</span>  
    <span class="k">if</span> <span class="p">(</span><span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;.login&#39;</span><span class="p">).</span><span class="nx">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
      <span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;.login&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">().</span><span class="nx">fade</span><span class="p">();</span>
      <span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;form.publisher&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">().</span><span class="nx">appear</span><span class="p">();</span>
    <span class="p">}</span>
      </pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>This checks to see if there are any mentions in the mention stream container.
If there aren't, it'll run XHR to get all the mentions since the last time
the user pulled from this browser. Presently the server does not persist
a user's access history, although that is also planned. </p>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Create an instance of SubscritionManager to watch for and handle mentions.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">ABApp</span><span class="p">.</span><span class="nx">channels</span><span class="p">[</span><span class="s1">&#39;mentions/&#39;</span><span class="o">+</span><span class="nx">ABApp</span><span class="p">.</span><span class="nx">sharedStorageManager</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SubscriptionManager</span><span class="p">([</span><span class="s1">&#39;mentions/&#39;</span><span class="o">+</span><span class="nx">ABApp</span><span class="p">.</span><span class="nx">sharedStorageManager</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)]);</span>
      <span class="nx">ABApp</span><span class="p">.</span><span class="nx">channels</span><span class="p">[</span><span class="s1">&#39;mentions/&#39;</span><span class="o">+</span><span class="nx">ABApp</span><span class="p">.</span><span class="nx">sharedStorageManager</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)]</span>
					 <span class="p">.</span><span class="nx">aka</span><span class="p">(</span><span class="s1">&#39;mentions&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Register a tracker element for the channel.</p>             </td>             <td class="code">               <div class="highlight"><pre>			     <span class="p">.</span><span class="nx">createTracker</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>This creates an element from an HBS template that handles the streams.</p>             </td>             <td class="code">               <div class="highlight"><pre>			     <span class="p">.</span><span class="nx">createStreamContainer</span><span class="p">()</span>
					 <span class="p">.</span><span class="nx">addBehavior</span><span class="p">(</span><span class="s1">&#39;popstream&#39;</span><span class="p">);</span>
                                            
    <span class="nx">SubscriptionWaker</span><span class="p">();</span>
  <span class="p">}</span>
  
<span class="p">});</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 