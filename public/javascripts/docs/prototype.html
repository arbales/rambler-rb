<!DOCTYPE html>  <html> <head>   <title>prototype.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="abapp.html">                 abapp.js               </a>                                           <a class="source" href="abmessage.html">                 abmessage.js               </a>                                           <a class="source" href="app.html">                 app.js               </a>                                           <a class="source" href="compiler.html">                 compiler.js               </a>                                           <a class="source" href="def.html">                 def.js               </a>                                           <a class="source" href="euwindow.html">                 euwindow.js               </a>                                           <a class="source" href="faye_ext.html">                 faye_ext.js               </a>                                           <a class="source" href="handlebars.html">                 handlebars.js               </a>                                           <a class="source" href="lowpro.html">                 lowpro.js               </a>                                           <a class="source" href="managers.html">                 managers.js               </a>                                           <a class="source" href="mustache.html">                 mustache.js               </a>                                           <a class="source" href="protoaculous.min.html">                 protoaculous.min.js               </a>                                           <a class="source" href="prototype.html">                 prototype.js               </a>                                           <a class="source" href="prototype.s2.min.html">                 prototype.s2.min.js               </a>                                           <a class="source" href="sha1.html">                 sha1.js               </a>                                           <a class="source" href="templates.html">                 templates.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               prototype.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/*  Prototype JavaScript framework, version 1.7_rc3</span>
<span class="cm"> *  (c) 2005-2010 Sam Stephenson</span>
<span class="cm"> *</span>
<span class="cm"> *  Prototype is freely distributable under the terms of an MIT-style license.</span>
<span class="cm"> *  For details, see the Prototype web site: http://www.prototypejs.org/</span>
<span class="cm"> *</span>
<span class="cm"> *--------------------------------------------------------------------------*/</span>

<span class="kd">var</span> <span class="nx">Prototype</span> <span class="o">=</span> <span class="p">{</span>

  <span class="nx">Version</span><span class="o">:</span> <span class="s1">&#39;1.7_rc3&#39;</span><span class="p">,</span>

  <span class="nx">Browser</span><span class="o">:</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">ua</span> <span class="o">=</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">isOpera</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">opera</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;[object Opera]&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">IE</span><span class="o">:</span>             <span class="o">!!</span><span class="nb">window</span><span class="p">.</span><span class="nx">attachEvent</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isOpera</span><span class="p">,</span>
      <span class="nx">Opera</span><span class="o">:</span>          <span class="nx">isOpera</span><span class="p">,</span>
      <span class="nx">WebKit</span><span class="o">:</span>         <span class="nx">ua</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;AppleWebKit/&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
      <span class="nx">Gecko</span><span class="o">:</span>          <span class="nx">ua</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;Gecko&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">ua</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;KHTML&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
      <span class="nx">MobileSafari</span><span class="o">:</span>   <span class="sr">/Apple.*Mobile/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">ua</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">})(),</span>

  <span class="nx">BrowserFeatures</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">XPath</span><span class="o">:</span> <span class="o">!!</span><span class="nb">document</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">,</span>

    <span class="nx">SelectorsAPI</span><span class="o">:</span> <span class="o">!!</span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">,</span>

    <span class="nx">ElementExtensions</span><span class="o">:</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">constructor</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Element</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">HTMLElement</span><span class="p">;</span>
      <span class="k">return</span> <span class="o">!!</span><span class="p">(</span><span class="nx">constructor</span> <span class="o">&amp;&amp;</span> <span class="nx">constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>
    <span class="p">})(),</span>
    <span class="nx">SpecificElementExtensions</span><span class="o">:</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nb">window</span><span class="p">.</span><span class="nx">HTMLDivElement</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">),</span>
          <span class="nx">form</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">),</span>
          <span class="nx">isSupported</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">div</span><span class="p">[</span><span class="s1">&#39;__proto__&#39;</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">div</span><span class="p">[</span><span class="s1">&#39;__proto__&#39;</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">form</span><span class="p">[</span><span class="s1">&#39;__proto__&#39;</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nx">isSupported</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">div</span> <span class="o">=</span> <span class="nx">form</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

      <span class="k">return</span> <span class="nx">isSupported</span><span class="p">;</span>
    <span class="p">})()</span>
  <span class="p">},</span>

  <span class="nx">ScriptFragment</span><span class="o">:</span> <span class="s1">&#39;&lt;script[^&gt;]*&gt;([\\S\\s]*?)&lt;\/script&gt;&#39;</span><span class="p">,</span>
  <span class="nx">JSONFilter</span><span class="o">:</span> <span class="sr">/^\/\*-secure-([\s\S]*)\*\/\s*$/</span><span class="p">,</span>

  <span class="nx">emptyFunction</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="p">},</span>

  <span class="nx">K</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">Prototype</span><span class="p">.</span><span class="nx">Browser</span><span class="p">.</span><span class="nx">MobileSafari</span><span class="p">)</span>
  <span class="nx">Prototype</span><span class="p">.</span><span class="nx">BrowserFeatures</span><span class="p">.</span><span class="nx">SpecificElementExtensions</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>


<span class="kd">var</span> <span class="nx">Abstract</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>


<span class="kd">var</span> <span class="nx">Try</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">these</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">returnValue</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">lambda</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">returnValue</span> <span class="o">=</span> <span class="nx">lambda</span><span class="p">();</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">returnValue</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Based on Alex Arnell&#39;s inheritance implementation. */</span>

<span class="kd">var</span> <span class="nx">Class</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">IS_DONTENUM_BUGGY</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">p</span> <span class="k">in</span> <span class="p">{</span> <span class="nx">toString</span><span class="o">:</span> <span class="mi">1</span> <span class="p">})</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span> <span class="o">===</span> <span class="s1">&#39;toString&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">})();</span>

  <span class="kd">function</span> <span class="nx">subclass</span><span class="p">()</span> <span class="p">{};</span>
  <span class="kd">function</span> <span class="nx">create</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">properties</span> <span class="o">=</span> <span class="nx">$A</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">properties</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
      <span class="nx">parent</span> <span class="o">=</span> <span class="nx">properties</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>

    <span class="kd">function</span> <span class="nx">klass</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">klass</span><span class="p">,</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">Methods</span><span class="p">);</span>
    <span class="nx">klass</span><span class="p">.</span><span class="nx">superclass</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">;</span>
    <span class="nx">klass</span><span class="p">.</span><span class="nx">subclasses</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">subclass</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
      <span class="nx">klass</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">subclass</span><span class="p">;</span>
      <span class="nx">parent</span><span class="p">.</span><span class="nx">subclasses</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">klass</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">properties</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
      <span class="nx">klass</span><span class="p">.</span><span class="nx">addMethods</span><span class="p">(</span><span class="nx">properties</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">klass</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span><span class="p">)</span>
      <span class="nx">klass</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span> <span class="o">=</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">emptyFunction</span><span class="p">;</span>

    <span class="nx">klass</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">klass</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">klass</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">addMethods</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ancestor</span>   <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superclass</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">superclass</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span>
        <span class="nx">properties</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">source</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">IS_DONTENUM_BUGGY</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">toString</span> <span class="o">!=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">)</span>
        <span class="nx">properties</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;toString&quot;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">valueOf</span> <span class="o">!=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">valueOf</span><span class="p">)</span>
        <span class="nx">properties</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;valueOf&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">properties</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">property</span> <span class="o">=</span> <span class="nx">properties</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">source</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ancestor</span> <span class="o">&amp;&amp;</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
          <span class="nx">value</span><span class="p">.</span><span class="nx">argumentNames</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$super&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">method</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
        <span class="nx">value</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">ancestor</span><span class="p">[</span><span class="nx">m</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="p">};</span>
        <span class="p">})(</span><span class="nx">property</span><span class="p">).</span><span class="nx">wrap</span><span class="p">(</span><span class="nx">method</span><span class="p">);</span>

        <span class="nx">value</span><span class="p">.</span><span class="nx">valueOf</span> <span class="o">=</span> <span class="nx">method</span><span class="p">.</span><span class="nx">valueOf</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">method</span><span class="p">);</span>
        <span class="nx">value</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="nx">method</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">method</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">create</span><span class="o">:</span> <span class="nx">create</span><span class="p">,</span>
    <span class="nx">Methods</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">addMethods</span><span class="o">:</span> <span class="nx">addMethods</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">})();</span>
<span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">_toString</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">,</span>
      <span class="nx">NULL_TYPE</span> <span class="o">=</span> <span class="s1">&#39;Null&#39;</span><span class="p">,</span>
      <span class="nx">UNDEFINED_TYPE</span> <span class="o">=</span> <span class="s1">&#39;Undefined&#39;</span><span class="p">,</span>
      <span class="nx">BOOLEAN_TYPE</span> <span class="o">=</span> <span class="s1">&#39;Boolean&#39;</span><span class="p">,</span>
      <span class="nx">NUMBER_TYPE</span> <span class="o">=</span> <span class="s1">&#39;Number&#39;</span><span class="p">,</span>
      <span class="nx">STRING_TYPE</span> <span class="o">=</span> <span class="s1">&#39;String&#39;</span><span class="p">,</span>
      <span class="nx">OBJECT_TYPE</span> <span class="o">=</span> <span class="s1">&#39;Object&#39;</span><span class="p">,</span>
      <span class="nx">BOOLEAN_CLASS</span> <span class="o">=</span> <span class="s1">&#39;[object Boolean]&#39;</span><span class="p">,</span>
      <span class="nx">NUMBER_CLASS</span> <span class="o">=</span> <span class="s1">&#39;[object Number]&#39;</span><span class="p">,</span>
      <span class="nx">STRING_CLASS</span> <span class="o">=</span> <span class="s1">&#39;[object String]&#39;</span><span class="p">,</span>
      <span class="nx">ARRAY_CLASS</span> <span class="o">=</span> <span class="s1">&#39;[object Array]&#39;</span><span class="p">,</span>
      <span class="nx">NATIVE_JSON_STRINGIFY_SUPPORT</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">JSON</span> <span class="o">&amp;&amp;</span>
        <span class="k">typeof</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span>
        <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;0&#39;</span> <span class="o">&amp;&amp;</span>
        <span class="k">typeof</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">Prototype</span><span class="p">.</span><span class="nx">K</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">Type</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="kc">null</span><span class="o">:</span> <span class="k">return</span> <span class="nx">NULL_TYPE</span><span class="p">;</span>
      <span class="k">case</span> <span class="p">(</span><span class="k">void</span> <span class="mi">0</span><span class="p">)</span><span class="o">:</span> <span class="k">return</span> <span class="nx">UNDEFINED_TYPE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">o</span><span class="p">;</span>
    <span class="k">switch</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s1">&#39;boolean&#39;</span><span class="o">:</span> <span class="k">return</span> <span class="nx">BOOLEAN_TYPE</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;number&#39;</span><span class="o">:</span>  <span class="k">return</span> <span class="nx">NUMBER_TYPE</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;string&#39;</span><span class="o">:</span>  <span class="k">return</span> <span class="nx">STRING_TYPE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">OBJECT_TYPE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">extend</span><span class="p">(</span><span class="nx">destination</span><span class="p">,</span> <span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">property</span> <span class="k">in</span> <span class="nx">source</span><span class="p">)</span>
      <span class="nx">destination</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">=</span> <span class="nx">source</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
    <span class="k">return</span> <span class="nx">destination</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">inspect</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">object</span><span class="p">))</span> <span class="k">return</span> <span class="s1">&#39;undefined&#39;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">object</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;null&#39;</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">object</span><span class="p">.</span><span class="nx">inspect</span> <span class="o">?</span> <span class="nx">object</span><span class="p">.</span><span class="nx">inspect</span><span class="p">()</span> <span class="o">:</span> <span class="nb">String</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">e</span> <span class="k">instanceof</span> <span class="nx">RangeError</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;...&#39;</span><span class="p">;</span>
      <span class="k">throw</span> <span class="nx">e</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">toJSON</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Str</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="s1">&#39;&#39;</span><span class="o">:</span> <span class="nx">value</span> <span class="p">},</span> <span class="p">[]);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">Str</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">holder</span><span class="p">,</span> <span class="nx">stack</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">holder</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">value</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">Type</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">===</span> <span class="nx">OBJECT_TYPE</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toJSON</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">_class</span> <span class="o">=</span> <span class="nx">_toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>

    <span class="k">switch</span> <span class="p">(</span><span class="nx">_class</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nx">NUMBER_CLASS</span><span class="o">:</span>
      <span class="k">case</span> <span class="nx">BOOLEAN_CLASS</span><span class="o">:</span>
      <span class="k">case</span> <span class="nx">STRING_CLASS</span><span class="o">:</span>
        <span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">valueOf</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">switch</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="kc">null</span><span class="o">:</span> <span class="k">return</span> <span class="s1">&#39;null&#39;</span><span class="p">;</span>
      <span class="k">case</span> <span class="kc">true</span><span class="o">:</span> <span class="k">return</span> <span class="s1">&#39;true&#39;</span><span class="p">;</span>
      <span class="k">case</span> <span class="kc">false</span><span class="o">:</span> <span class="k">return</span> <span class="s1">&#39;false&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">type</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">value</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s1">&#39;string&#39;</span><span class="o">:</span>
        <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">inspect</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
      <span class="k">case</span> <span class="s1">&#39;number&#39;</span><span class="o">:</span>
        <span class="k">return</span> <span class="nb">isFinite</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">?</span> <span class="nb">String</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">:</span> <span class="s1">&#39;null&#39;</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;object&#39;</span><span class="o">:</span>

        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">stack</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">();</span> <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">partial</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_class</span> <span class="o">===</span> <span class="nx">ARRAY_CLASS</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="nx">Str</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">stack</span><span class="p">);</span>
            <span class="nx">partial</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">str</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">?</span> <span class="s1">&#39;null&#39;</span> <span class="o">:</span> <span class="nx">str</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="nx">partial</span> <span class="o">=</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="nx">partial</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">str</span> <span class="o">=</span> <span class="nx">Str</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">stack</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">str</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">partial</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">.</span><span class="nx">inspect</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">str</span><span class="p">);</span>
             <span class="p">}</span>
          <span class="p">}</span>
          <span class="nx">partial</span> <span class="o">=</span> <span class="s1">&#39;{&#39;</span> <span class="o">+</span> <span class="nx">partial</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">partial</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">stringify</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">toQueryString</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">$H</span><span class="p">(</span><span class="nx">object</span><span class="p">).</span><span class="nx">toQueryString</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">toHTML</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">object</span> <span class="o">&amp;&amp;</span> <span class="nx">object</span><span class="p">.</span><span class="nx">toHTML</span> <span class="o">?</span> <span class="nx">object</span><span class="p">.</span><span class="nx">toHTML</span><span class="p">()</span> <span class="o">:</span> <span class="nb">String</span><span class="p">.</span><span class="nx">interpret</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">keys</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">Type</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="o">!==</span> <span class="nx">OBJECT_TYPE</span><span class="p">)</span> <span class="p">{</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">();</span> <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">property</span> <span class="k">in</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">property</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">property</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">values</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">property</span> <span class="k">in</span> <span class="nx">object</span><span class="p">)</span>
      <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">object</span><span class="p">[</span><span class="nx">property</span><span class="p">]);</span>
    <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">clone</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">extend</span><span class="p">({</span> <span class="p">},</span> <span class="nx">object</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">isElement</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">!!</span><span class="p">(</span><span class="nx">object</span> <span class="o">&amp;&amp;</span> <span class="nx">object</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">isArray</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">_toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="o">===</span> <span class="nx">ARRAY_CLASS</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">hasNativeIsArray</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span>
    <span class="o">&amp;&amp;</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">([])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">({});</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">hasNativeIsArray</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">isArray</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">isHash</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">Hash</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">isFunction</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">typeof</span> <span class="nx">object</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">isString</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">_toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="o">===</span> <span class="nx">STRING_CLASS</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">isNumber</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">_toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="o">===</span> <span class="nx">NUMBER_CLASS</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">isUndefined</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">typeof</span> <span class="nx">object</span> <span class="o">===</span> <span class="s2">&quot;undefined&quot;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">extend</span><span class="p">(</span><span class="nb">Object</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">extend</span><span class="o">:</span>        <span class="nx">extend</span><span class="p">,</span>
    <span class="nx">inspect</span><span class="o">:</span>       <span class="nx">inspect</span><span class="p">,</span>
    <span class="nx">toJSON</span><span class="o">:</span>        <span class="nx">NATIVE_JSON_STRINGIFY_SUPPORT</span> <span class="o">?</span> <span class="nx">stringify</span> <span class="o">:</span> <span class="nx">toJSON</span><span class="p">,</span>
    <span class="nx">toQueryString</span><span class="o">:</span> <span class="nx">toQueryString</span><span class="p">,</span>
    <span class="nx">toHTML</span><span class="o">:</span>        <span class="nx">toHTML</span><span class="p">,</span>
    <span class="nx">keys</span><span class="o">:</span>          <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span> <span class="o">||</span> <span class="nx">keys</span><span class="p">,</span>
    <span class="nx">values</span><span class="o">:</span>        <span class="nx">values</span><span class="p">,</span>
    <span class="nx">clone</span><span class="o">:</span>         <span class="nx">clone</span><span class="p">,</span>
    <span class="nx">isElement</span><span class="o">:</span>     <span class="nx">isElement</span><span class="p">,</span>
    <span class="nx">isArray</span><span class="o">:</span>       <span class="nx">isArray</span><span class="p">,</span>
    <span class="nx">isHash</span><span class="o">:</span>        <span class="nx">isHash</span><span class="p">,</span>
    <span class="nx">isFunction</span><span class="o">:</span>    <span class="nx">isFunction</span><span class="p">,</span>
    <span class="nx">isString</span><span class="o">:</span>      <span class="nx">isString</span><span class="p">,</span>
    <span class="nx">isNumber</span><span class="o">:</span>      <span class="nx">isNumber</span><span class="p">,</span>
    <span class="nx">isUndefined</span><span class="o">:</span>   <span class="nx">isUndefined</span>
  <span class="p">});</span>
<span class="p">})();</span>
<span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nb">Function</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">slice</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">update</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">arrayLength</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">length</span><span class="o">--</span><span class="p">)</span> <span class="nx">array</span><span class="p">[</span><span class="nx">arrayLength</span> <span class="o">+</span> <span class="nx">length</span><span class="p">]</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="nx">length</span><span class="p">];</span>
    <span class="k">return</span> <span class="nx">array</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">merge</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">array</span> <span class="o">=</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">update</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">argumentNames</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">names</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^[\s\(]*function[^(]*\(([^)]*)\)/</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
      <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/\/.*?[\r\n]|\/\*(?:.|[\r\n])*?\*\//g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s+/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">names</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="p">[]</span> <span class="o">:</span> <span class="nx">names</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">bind</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">__method</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">merge</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">__method</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">a</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">bindAsEventListener</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">__method</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">update</span><span class="p">([</span><span class="nx">event</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">event</span><span class="p">],</span> <span class="nx">args</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">__method</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">a</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">curry</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">__method</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">merge</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">__method</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">a</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">delay</span><span class="p">(</span><span class="nx">timeout</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">__method</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="nx">timeout</span> <span class="o">=</span> <span class="nx">timeout</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">__method</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">__method</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
    <span class="p">},</span> <span class="nx">timeout</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">defer</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">update</span><span class="p">([</span><span class="mf">0.01</span><span class="p">],</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">delay</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">wrap</span><span class="p">(</span><span class="nx">wrapper</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">__method</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">update</span><span class="p">([</span><span class="nx">__method</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)],</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">wrapper</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">a</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">methodize</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_methodized</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_methodized</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">__method</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_methodized</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">update</span><span class="p">([</span><span class="k">this</span><span class="p">],</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">__method</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">a</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">argumentNames</span><span class="o">:</span>       <span class="nx">argumentNames</span><span class="p">,</span>
    <span class="nx">bind</span><span class="o">:</span>                <span class="nx">bind</span><span class="p">,</span>
    <span class="nx">bindAsEventListener</span><span class="o">:</span> <span class="nx">bindAsEventListener</span><span class="p">,</span>
    <span class="nx">curry</span><span class="o">:</span>               <span class="nx">curry</span><span class="p">,</span>
    <span class="nx">delay</span><span class="o">:</span>               <span class="nx">delay</span><span class="p">,</span>
    <span class="nx">defer</span><span class="o">:</span>               <span class="nx">defer</span><span class="p">,</span>
    <span class="nx">wrap</span><span class="o">:</span>                <span class="nx">wrap</span><span class="p">,</span>
    <span class="nx">methodize</span><span class="o">:</span>           <span class="nx">methodize</span>
  <span class="p">}</span>
<span class="p">})());</span>



<span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">proto</span><span class="p">)</span> <span class="p">{</span>


  <span class="kd">function</span> <span class="nx">toISOString</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getUTCFullYear</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span>
      <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getUTCMonth</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">).</span><span class="nx">toPaddedString</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">getUTCDate</span><span class="p">().</span><span class="nx">toPaddedString</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;T&#39;</span> <span class="o">+</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">getUTCHours</span><span class="p">().</span><span class="nx">toPaddedString</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">getUTCMinutes</span><span class="p">().</span><span class="nx">toPaddedString</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">getUTCSeconds</span><span class="p">().</span><span class="nx">toPaddedString</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Z&#39;</span><span class="p">;</span>
  <span class="p">}</span>


  <span class="kd">function</span> <span class="nx">toJSON</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">toISOString</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">proto</span><span class="p">.</span><span class="nx">toISOString</span><span class="p">)</span> <span class="nx">proto</span><span class="p">.</span><span class="nx">toISOString</span> <span class="o">=</span> <span class="nx">toISOString</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">proto</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">)</span> <span class="nx">proto</span><span class="p">.</span><span class="nx">toJSON</span> <span class="o">=</span> <span class="nx">toJSON</span><span class="p">;</span>

<span class="p">})(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>


<span class="nb">RegExp</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">match</span> <span class="o">=</span> <span class="nb">RegExp</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">test</span><span class="p">;</span>

<span class="nb">RegExp</span><span class="p">.</span><span class="nx">escape</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">String</span><span class="p">(</span><span class="nx">str</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([.*+?^=!:${}()|[\]\/\\])/g</span><span class="p">,</span> <span class="s1">&#39;\\$1&#39;</span><span class="p">);</span>
<span class="p">};</span>
<span class="kd">var</span> <span class="nx">PeriodicalExecuter</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">frequency</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">callback</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">frequency</span> <span class="o">=</span> <span class="nx">frequency</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">currentlyExecuting</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">registerCallback</span><span class="p">();</span>
  <span class="p">},</span>

  <span class="nx">registerCallback</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">timer</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">onTimerEvent</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">frequency</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">execute</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">callback</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">stop</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">timer</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">clearInterval</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">timer</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">timer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">onTimerEvent</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">currentlyExecuting</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">currentlyExecuting</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">execute</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">currentlyExecuting</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">currentlyExecuting</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">throw</span> <span class="nx">e</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nb">String</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">interpret</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">value</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span> <span class="o">:</span> <span class="nb">String</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">specialChar</span><span class="o">:</span> <span class="p">{</span>
    <span class="s1">&#39;\b&#39;</span><span class="o">:</span> <span class="s1">&#39;\\b&#39;</span><span class="p">,</span>
    <span class="s1">&#39;\t&#39;</span><span class="o">:</span> <span class="s1">&#39;\\t&#39;</span><span class="p">,</span>
    <span class="s1">&#39;\n&#39;</span><span class="o">:</span> <span class="s1">&#39;\\n&#39;</span><span class="p">,</span>
    <span class="s1">&#39;\f&#39;</span><span class="o">:</span> <span class="s1">&#39;\\f&#39;</span><span class="p">,</span>
    <span class="s1">&#39;\r&#39;</span><span class="o">:</span> <span class="s1">&#39;\\r&#39;</span><span class="p">,</span>
    <span class="s1">&#39;\\&#39;</span><span class="o">:</span> <span class="s1">&#39;\\\\&#39;</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nb">String</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">NATIVE_JSON_PARSE_SUPPORT</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">JSON</span> <span class="o">&amp;&amp;</span>
    <span class="k">typeof</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span>
    <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="s1">&#39;{&quot;test&quot;: true}&#39;</span><span class="p">).</span><span class="nx">test</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">prepareReplacement</span><span class="p">(</span><span class="nx">replacement</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">replacement</span><span class="p">))</span> <span class="k">return</span> <span class="nx">replacement</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">template</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Template</span><span class="p">(</span><span class="nx">replacement</span><span class="p">);</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">template</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">gsub</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span> <span class="nx">replacement</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">source</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">match</span><span class="p">;</span>
    <span class="nx">replacement</span> <span class="o">=</span> <span class="nx">prepareReplacement</span><span class="p">(</span><span class="nx">replacement</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">pattern</span><span class="p">))</span>
      <span class="nx">pattern</span> <span class="o">=</span> <span class="nb">RegExp</span><span class="p">.</span><span class="nx">escape</span><span class="p">(</span><span class="nx">pattern</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">pattern</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">source</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">replacement</span> <span class="o">=</span> <span class="nx">replacement</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">replacement</span> <span class="o">+</span> <span class="nx">source</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="nx">replacement</span><span class="p">)</span> <span class="o">+</span> <span class="nx">replacement</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">while</span> <span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">match</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">pattern</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">+=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">match</span><span class="p">.</span><span class="nx">index</span><span class="p">);</span>
        <span class="nx">result</span> <span class="o">+=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">interpret</span><span class="p">(</span><span class="nx">replacement</span><span class="p">(</span><span class="nx">match</span><span class="p">));</span>
        <span class="nx">source</span>  <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">match</span><span class="p">.</span><span class="nx">index</span> <span class="o">+</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">+=</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">source</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">sub</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span> <span class="nx">replacement</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">replacement</span> <span class="o">=</span> <span class="nx">prepareReplacement</span><span class="p">(</span><span class="nx">replacement</span><span class="p">);</span>
    <span class="nx">count</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">count</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="nx">count</span><span class="p">;</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">gsub</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="nx">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="k">return</span> <span class="nx">replacement</span><span class="p">(</span><span class="nx">match</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">scan</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">gsub</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">String</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">truncate</span><span class="p">(</span><span class="nx">length</span><span class="p">,</span> <span class="nx">truncation</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">length</span> <span class="o">=</span> <span class="nx">length</span> <span class="o">||</span> <span class="mi">30</span><span class="p">;</span>
    <span class="nx">truncation</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">truncation</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;...&#39;</span> <span class="o">:</span> <span class="nx">truncation</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">length</span> <span class="o">?</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">length</span> <span class="o">-</span> <span class="nx">truncation</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">+</span> <span class="nx">truncation</span> <span class="o">:</span> <span class="nb">String</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">strip</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\s+/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s+$/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">stripTags</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;\w+(\s+(&quot;[^&quot;]*&quot;|&#39;[^&#39;]*&#39;|[^&gt;])+)?&gt;|&lt;\/\w+&gt;/gi</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">stripScripts</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">Prototype</span><span class="p">.</span><span class="nx">ScriptFragment</span><span class="p">,</span> <span class="s1">&#39;img&#39;</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">extractScripts</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">matchAll</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">Prototype</span><span class="p">.</span><span class="nx">ScriptFragment</span><span class="p">,</span> <span class="s1">&#39;img&#39;</span><span class="p">),</span>
        <span class="nx">matchOne</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">Prototype</span><span class="p">.</span><span class="nx">ScriptFragment</span><span class="p">,</span> <span class="s1">&#39;im&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">matchAll</span><span class="p">)</span> <span class="o">||</span> <span class="p">[]).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">scriptTag</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="nx">scriptTag</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">matchOne</span><span class="p">)</span> <span class="o">||</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">])[</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">evalScripts</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">extractScripts</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">script</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="nx">script</span><span class="p">)</span> <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">escapeHTML</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;/g</span><span class="p">,</span><span class="s1">&#39;&amp;amp;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;/g</span><span class="p">,</span><span class="s1">&#39;&amp;lt;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&gt;/g</span><span class="p">,</span><span class="s1">&#39;&amp;gt;&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">unescapeHTML</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">stripTags</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;lt;/g</span><span class="p">,</span><span class="s1">&#39;&lt;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;gt;/g</span><span class="p">,</span><span class="s1">&#39;&gt;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;amp;/g</span><span class="p">,</span><span class="s1">&#39;&amp;&#39;</span><span class="p">);</span>
  <span class="p">}</span>


  <span class="kd">function</span> <span class="nx">toQueryParams</span><span class="p">(</span><span class="nx">separator</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">strip</span><span class="p">().</span><span class="nx">match</span><span class="p">(</span><span class="sr">/([^?#]*)(#.*)?$/</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">match</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span> <span class="p">};</span>

    <span class="k">return</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="nx">separator</span> <span class="o">||</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">).</span><span class="nx">inject</span><span class="p">({</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">hash</span><span class="p">,</span> <span class="nx">pair</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="nx">pair</span> <span class="o">=</span> <span class="nx">pair</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">pair</span><span class="p">.</span><span class="nx">shift</span><span class="p">()),</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">pair</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="nx">pair</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="nx">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">!=</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">value</span> <span class="o">=</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">hash</span><span class="p">[</span><span class="nx">key</span><span class="p">]))</span> <span class="nx">hash</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">hash</span><span class="p">[</span><span class="nx">key</span><span class="p">]];</span>
          <span class="nx">hash</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="nx">hash</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">hash</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">toArray</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">succ</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
      <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">times</span><span class="p">(</span><span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">count</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span> <span class="o">:</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">camelize</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/-+(.)?/g</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">chr</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">chr</span> <span class="o">?</span> <span class="nx">chr</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">capitalize</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">underscore</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/::/g</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
               <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([A-Z]+)([A-Z][a-z])/g</span><span class="p">,</span> <span class="s1">&#39;$1_$2&#39;</span><span class="p">)</span>
               <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([a-z\d])([A-Z])/g</span><span class="p">,</span> <span class="s1">&#39;$1_$2&#39;</span><span class="p">)</span>
               <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/-/g</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
               <span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">dasherize</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/_/g</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">inspect</span><span class="p">(</span><span class="nx">useDoubleQuotes</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">escapedString</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[\x00-\x1f\\]/g</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">character</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">character</span> <span class="k">in</span> <span class="nb">String</span><span class="p">.</span><span class="nx">specialChar</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">specialChar</span><span class="p">[</span><span class="nx">character</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="s1">&#39;\\u00&#39;</span> <span class="o">+</span> <span class="nx">character</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">().</span><span class="nx">toPaddedString</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">useDoubleQuotes</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="nx">escapedString</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&quot;/g</span><span class="p">,</span> <span class="s1">&#39;\\&quot;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="nx">escapedString</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&#39;/g</span><span class="p">,</span> <span class="s1">&#39;\\\&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">unfilterJSON</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">filter</span> <span class="o">||</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">JSONFilter</span><span class="p">,</span> <span class="s1">&#39;$1&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">isJSON</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">blank</span><span class="p">())</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">str</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\(?:[&quot;\\\/bfnrt]|u[0-9a-fA-F]{4})/g</span><span class="p">,</span> <span class="s1">&#39;@&#39;</span><span class="p">);</span>
    <span class="nx">str</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&quot;[^&quot;\\\n\r]*&quot;|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">);</span>
    <span class="nx">str</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(?:^|:|,)(?:\s*\[)+/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="sr">/^[\],:{}\s]*$/</span><span class="p">).</span><span class="nx">test</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">evalJSON</span><span class="p">(</span><span class="nx">sanitize</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">unfilterJSON</span><span class="p">(),</span>
        <span class="nx">cx</span> <span class="o">=</span> <span class="sr">/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cx</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">json</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">json</span> <span class="o">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">cx</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;\\u&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;0000&#39;</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)).</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">sanitize</span> <span class="o">||</span> <span class="nx">json</span><span class="p">.</span><span class="nx">isJSON</span><span class="p">())</span> <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="nx">json</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nx">SyntaxError</span><span class="p">(</span><span class="s1">&#39;Badly formed JSON string: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">inspect</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">parseJSON</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">unfilterJSON</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">include</span><span class="p">(</span><span class="nx">pattern</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">pattern</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">startsWith</span><span class="p">(</span><span class="nx">pattern</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">endsWith</span><span class="p">(</span><span class="nx">pattern</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">d</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span> <span class="o">===</span> <span class="nx">d</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">empty</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">blank</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="sr">/^\s*$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">interpolate</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">pattern</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Template</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">pattern</span><span class="p">).</span><span class="nx">evaluate</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">gsub</span><span class="o">:</span>           <span class="nx">gsub</span><span class="p">,</span>
    <span class="nx">sub</span><span class="o">:</span>            <span class="nx">sub</span><span class="p">,</span>
    <span class="nx">scan</span><span class="o">:</span>           <span class="nx">scan</span><span class="p">,</span>
    <span class="nx">truncate</span><span class="o">:</span>       <span class="nx">truncate</span><span class="p">,</span>
    <span class="nx">strip</span><span class="o">:</span>          <span class="nb">String</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">trim</span> <span class="o">||</span> <span class="nx">strip</span><span class="p">,</span>
    <span class="nx">stripTags</span><span class="o">:</span>      <span class="nx">stripTags</span><span class="p">,</span>
    <span class="nx">stripScripts</span><span class="o">:</span>   <span class="nx">stripScripts</span><span class="p">,</span>
    <span class="nx">extractScripts</span><span class="o">:</span> <span class="nx">extractScripts</span><span class="p">,</span>
    <span class="nx">evalScripts</span><span class="o">:</span>    <span class="nx">evalScripts</span><span class="p">,</span>
    <span class="nx">escapeHTML</span><span class="o">:</span>     <span class="nx">escapeHTML</span><span class="p">,</span>
    <span class="nx">unescapeHTML</span><span class="o">:</span>   <span class="nx">unescapeHTML</span><span class="p">,</span>
    <span class="nx">toQueryParams</span><span class="o">:</span>  <span class="nx">toQueryParams</span><span class="p">,</span>
    <span class="nx">parseQuery</span><span class="o">:</span>     <span class="nx">toQueryParams</span><span class="p">,</span>
    <span class="nx">toArray</span><span class="o">:</span>        <span class="nx">toArray</span><span class="p">,</span>
    <span class="nx">succ</span><span class="o">:</span>           <span class="nx">succ</span><span class="p">,</span>
    <span class="nx">times</span><span class="o">:</span>          <span class="nx">times</span><span class="p">,</span>
    <span class="nx">camelize</span><span class="o">:</span>       <span class="nx">camelize</span><span class="p">,</span>
    <span class="nx">capitalize</span><span class="o">:</span>     <span class="nx">capitalize</span><span class="p">,</span>
    <span class="nx">underscore</span><span class="o">:</span>     <span class="nx">underscore</span><span class="p">,</span>
    <span class="nx">dasherize</span><span class="o">:</span>      <span class="nx">dasherize</span><span class="p">,</span>
    <span class="nx">inspect</span><span class="o">:</span>        <span class="nx">inspect</span><span class="p">,</span>
    <span class="nx">unfilterJSON</span><span class="o">:</span>   <span class="nx">unfilterJSON</span><span class="p">,</span>
    <span class="nx">isJSON</span><span class="o">:</span>         <span class="nx">isJSON</span><span class="p">,</span>
    <span class="nx">evalJSON</span><span class="o">:</span>       <span class="nx">NATIVE_JSON_PARSE_SUPPORT</span> <span class="o">?</span> <span class="nx">parseJSON</span> <span class="o">:</span> <span class="nx">evalJSON</span><span class="p">,</span>
    <span class="nx">include</span><span class="o">:</span>        <span class="nx">include</span><span class="p">,</span>
    <span class="nx">startsWith</span><span class="o">:</span>     <span class="nx">startsWith</span><span class="p">,</span>
    <span class="nx">endsWith</span><span class="o">:</span>       <span class="nx">endsWith</span><span class="p">,</span>
    <span class="nx">empty</span><span class="o">:</span>          <span class="nx">empty</span><span class="p">,</span>
    <span class="nx">blank</span><span class="o">:</span>          <span class="nx">blank</span><span class="p">,</span>
    <span class="nx">interpolate</span><span class="o">:</span>    <span class="nx">interpolate</span>
  <span class="p">};</span>
<span class="p">})());</span>

<span class="kd">var</span> <span class="nx">Template</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">template</span><span class="p">,</span> <span class="nx">pattern</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">template</span> <span class="o">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pattern</span> <span class="o">=</span> <span class="nx">pattern</span> <span class="o">||</span> <span class="nx">Template</span><span class="p">.</span><span class="nx">Pattern</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">evaluate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">object</span> <span class="o">&amp;&amp;</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">toTemplateReplacements</span><span class="p">))</span>
      <span class="nx">object</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">toTemplateReplacements</span><span class="p">();</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">.</span><span class="nx">gsub</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pattern</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">object</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">before</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">before</span> <span class="o">==</span> <span class="s1">&#39;\\&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

      <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">expr</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
          <span class="nx">pattern</span> <span class="o">=</span> <span class="sr">/^([^.[]+|\[((?:.*?[^\\])?)\])(\.|\[|$)/</span><span class="p">;</span>

      <span class="nx">match</span> <span class="o">=</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">expr</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">match</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">before</span><span class="p">;</span>

      <span class="k">while</span> <span class="p">(</span><span class="nx">match</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">comp</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\\\]/g</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">[</span><span class="nx">comp</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">==</span> <span class="nx">ctx</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span> <span class="o">==</span> <span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">break</span><span class="p">;</span>
        <span class="nx">expr</span> <span class="o">=</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="s1">&#39;[&#39;</span> <span class="o">==</span> <span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">?</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">length</span> <span class="o">:</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">);</span>
        <span class="nx">match</span> <span class="o">=</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">expr</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">before</span> <span class="o">+</span> <span class="nb">String</span><span class="p">.</span><span class="nx">interpret</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="nx">Template</span><span class="p">.</span><span class="nx">Pattern</span> <span class="o">=</span> <span class="sr">/(^|.|\r|\n)(#\{(.*?)\})/</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">$break</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>

<span class="kd">var</span> <span class="nx">Enumerable</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">function</span> <span class="nx">each</span><span class="p">(</span><span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="o">++</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">e</span> <span class="o">!=</span> <span class="nx">$break</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">e</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">eachSlice</span><span class="p">(</span><span class="nx">number</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="o">-</span><span class="nx">number</span><span class="p">,</span> <span class="nx">slices</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">array</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">toArray</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">number</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="nx">array</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">((</span><span class="nx">index</span> <span class="o">+=</span> <span class="nx">number</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
      <span class="nx">slices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">array</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">index</span><span class="o">+</span><span class="nx">number</span><span class="p">));</span>
    <span class="k">return</span> <span class="nx">slices</span><span class="p">.</span><span class="nx">collect</span><span class="p">(</span><span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">all</span><span class="p">(</span><span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">iterator</span> <span class="o">=</span> <span class="nx">iterator</span> <span class="o">||</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">K</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nx">result</span> <span class="o">&amp;&amp;</span> <span class="o">!!</span><span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">$break</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">any</span><span class="p">(</span><span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">iterator</span> <span class="o">=</span> <span class="nx">iterator</span> <span class="o">||</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">K</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">result</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">))</span>
        <span class="k">throw</span> <span class="nx">$break</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">collect</span><span class="p">(</span><span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">iterator</span> <span class="o">=</span> <span class="nx">iterator</span> <span class="o">||</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">K</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">));</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">detect</span><span class="p">(</span><span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
        <span class="k">throw</span> <span class="nx">$break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">findAll</span><span class="p">(</span><span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">))</span>
        <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">grep</span><span class="p">(</span><span class="nx">filter</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">iterator</span> <span class="o">=</span> <span class="nx">iterator</span> <span class="o">||</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">K</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">filter</span><span class="p">))</span>
      <span class="nx">filter</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nb">RegExp</span><span class="p">.</span><span class="nx">escape</span><span class="p">(</span><span class="nx">filter</span><span class="p">));</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">filter</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span>
        <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">));</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">include</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">))</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">found</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">throw</span> <span class="nx">$break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">found</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">inGroupsOf</span><span class="p">(</span><span class="nx">number</span><span class="p">,</span> <span class="nx">fillWith</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fillWith</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">fillWith</span><span class="p">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nx">fillWith</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">eachSlice</span><span class="p">(</span><span class="nx">number</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">slice</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">while</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">number</span><span class="p">)</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">fillWith</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">slice</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">inject</span><span class="p">(</span><span class="nx">memo</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">memo</span> <span class="o">=</span> <span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">memo</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">memo</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">invoke</span><span class="p">(</span><span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">$A</span><span class="p">(</span><span class="nx">arguments</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">value</span><span class="p">[</span><span class="nx">method</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">max</span><span class="p">(</span><span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">iterator</span> <span class="o">=</span> <span class="nx">iterator</span> <span class="o">||</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">K</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">result</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">value</span> <span class="o">=</span> <span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">result</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">value</span> <span class="o">&gt;=</span> <span class="nx">result</span><span class="p">)</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">min</span><span class="p">(</span><span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">iterator</span> <span class="o">=</span> <span class="nx">iterator</span> <span class="o">||</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">K</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">result</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">value</span> <span class="o">=</span> <span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">result</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">value</span> <span class="o">&lt;</span> <span class="nx">result</span><span class="p">)</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">partition</span><span class="p">(</span><span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">iterator</span> <span class="o">=</span> <span class="nx">iterator</span> <span class="o">||</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">K</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">trues</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">falses</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">(</span><span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">?</span>
        <span class="nx">trues</span> <span class="o">:</span> <span class="nx">falses</span><span class="p">).</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">trues</span><span class="p">,</span> <span class="nx">falses</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">pluck</span><span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="nx">property</span><span class="p">]);</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">))</span>
        <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">sortBy</span><span class="p">(</span><span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="nx">value</span><span class="o">:</span> <span class="nx">value</span><span class="p">,</span>
        <span class="nx">criteria</span><span class="o">:</span> <span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span>
      <span class="p">};</span>
    <span class="p">}).</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span> <span class="nx">right</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">left</span><span class="p">.</span><span class="nx">criteria</span><span class="p">,</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">right</span><span class="p">.</span><span class="nx">criteria</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">a</span> <span class="o">&lt;</span> <span class="nx">b</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="nx">a</span> <span class="o">&gt;</span> <span class="nx">b</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}).</span><span class="nx">pluck</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">toArray</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">zip</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">iterator</span> <span class="o">=</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">K</span><span class="p">,</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">$A</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">last</span><span class="p">()))</span>
      <span class="nx">iterator</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">collections</span> <span class="o">=</span> <span class="p">[</span><span class="k">this</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">args</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">$A</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">iterator</span><span class="p">(</span><span class="nx">collections</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="nx">index</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">size</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">toArray</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">inspect</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">&#39;#&lt;Enumerable:&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">toArray</span><span class="p">().</span><span class="nx">inspect</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">;</span>
  <span class="p">}</span>









  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">each</span><span class="o">:</span>       <span class="nx">each</span><span class="p">,</span>
    <span class="nx">eachSlice</span><span class="o">:</span>  <span class="nx">eachSlice</span><span class="p">,</span>
    <span class="nx">all</span><span class="o">:</span>        <span class="nx">all</span><span class="p">,</span>
    <span class="nx">every</span><span class="o">:</span>      <span class="nx">all</span><span class="p">,</span>
    <span class="nx">any</span><span class="o">:</span>        <span class="nx">any</span><span class="p">,</span>
    <span class="nx">some</span><span class="o">:</span>       <span class="nx">any</span><span class="p">,</span>
    <span class="nx">collect</span><span class="o">:</span>    <span class="nx">collect</span><span class="p">,</span>
    <span class="nx">map</span><span class="o">:</span>        <span class="nx">collect</span><span class="p">,</span>
    <span class="nx">detect</span><span class="o">:</span>     <span class="nx">detect</span><span class="p">,</span>
    <span class="nx">findAll</span><span class="o">:</span>    <span class="nx">findAll</span><span class="p">,</span>
    <span class="nx">select</span><span class="o">:</span>     <span class="nx">findAll</span><span class="p">,</span>
    <span class="nx">filter</span><span class="o">:</span>     <span class="nx">findAll</span><span class="p">,</span>
    <span class="nx">grep</span><span class="o">:</span>       <span class="nx">grep</span><span class="p">,</span>
    <span class="nx">include</span><span class="o">:</span>    <span class="nx">include</span><span class="p">,</span>
    <span class="nx">member</span><span class="o">:</span>     <span class="nx">include</span><span class="p">,</span>
    <span class="nx">inGroupsOf</span><span class="o">:</span> <span class="nx">inGroupsOf</span><span class="p">,</span>
    <span class="nx">inject</span><span class="o">:</span>     <span class="nx">inject</span><span class="p">,</span>
    <span class="nx">invoke</span><span class="o">:</span>     <span class="nx">invoke</span><span class="p">,</span>
    <span class="nx">max</span><span class="o">:</span>        <span class="nx">max</span><span class="p">,</span>
    <span class="nx">min</span><span class="o">:</span>        <span class="nx">min</span><span class="p">,</span>
    <span class="nx">partition</span><span class="o">:</span>  <span class="nx">partition</span><span class="p">,</span>
    <span class="nx">pluck</span><span class="o">:</span>      <span class="nx">pluck</span><span class="p">,</span>
    <span class="nx">reject</span><span class="o">:</span>     <span class="nx">reject</span><span class="p">,</span>
    <span class="nx">sortBy</span><span class="o">:</span>     <span class="nx">sortBy</span><span class="p">,</span>
    <span class="nx">toArray</span><span class="o">:</span>    <span class="nx">toArray</span><span class="p">,</span>
    <span class="nx">entries</span><span class="o">:</span>    <span class="nx">toArray</span><span class="p">,</span>
    <span class="nx">zip</span><span class="o">:</span>        <span class="nx">zip</span><span class="p">,</span>
    <span class="nx">size</span><span class="o">:</span>       <span class="nx">size</span><span class="p">,</span>
    <span class="nx">inspect</span><span class="o">:</span>    <span class="nx">inspect</span><span class="p">,</span>
    <span class="nx">find</span><span class="o">:</span>       <span class="nx">detect</span>
  <span class="p">};</span>
<span class="p">})();</span>

<span class="kd">function</span> <span class="nx">$A</span><span class="p">(</span><span class="nx">iterable</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">iterable</span><span class="p">)</span> <span class="k">return</span> <span class="p">[];</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;toArray&#39;</span> <span class="k">in</span> <span class="nb">Object</span><span class="p">(</span><span class="nx">iterable</span><span class="p">))</span> <span class="k">return</span> <span class="nx">iterable</span><span class="p">.</span><span class="nx">toArray</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">iterable</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">results</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">length</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">length</span><span class="o">--</span><span class="p">)</span> <span class="nx">results</span><span class="p">[</span><span class="nx">length</span><span class="p">]</span> <span class="o">=</span> <span class="nx">iterable</span><span class="p">[</span><span class="nx">length</span><span class="p">];</span>
  <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
<span class="p">}</span>


<span class="kd">function</span> <span class="nx">$w</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">string</span><span class="p">))</span> <span class="k">return</span> <span class="p">[];</span>
  <span class="nx">string</span> <span class="o">=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">strip</span><span class="p">();</span>
  <span class="k">return</span> <span class="nx">string</span> <span class="o">?</span> <span class="nx">string</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">)</span> <span class="o">:</span> <span class="p">[];</span>
<span class="p">}</span>

<span class="nb">Array</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="nx">$A</span><span class="p">;</span>


<span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">arrayProto</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span>
      <span class="nx">slice</span> <span class="o">=</span> <span class="nx">arrayProto</span><span class="p">.</span><span class="nx">slice</span><span class="p">,</span>
      <span class="nx">_each</span> <span class="o">=</span> <span class="nx">arrayProto</span><span class="p">.</span><span class="nx">forEach</span><span class="p">;</span> <span class="c1">// use native browser JS 1.6 implementation if available</span>

  <span class="kd">function</span> <span class="nx">each</span><span class="p">(</span><span class="nx">iterator</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">length</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
      <span class="nx">iterator</span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_each</span><span class="p">)</span> <span class="nx">_each</span> <span class="o">=</span> <span class="nx">each</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">clear</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">first</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">last</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">compact</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">value</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">flatten</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">inject</span><span class="p">([],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="nx">array</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">flatten</span><span class="p">());</span>
      <span class="nx">array</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">array</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">without</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="o">!</span><span class="nx">values</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">reverse</span><span class="p">(</span><span class="nx">inline</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">inline</span> <span class="o">===</span> <span class="kc">false</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">toArray</span><span class="p">()</span> <span class="o">:</span> <span class="k">this</span><span class="p">).</span><span class="nx">_reverse</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">uniq</span><span class="p">(</span><span class="nx">sorted</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">inject</span><span class="p">([],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="nx">index</span> <span class="o">||</span> <span class="p">(</span><span class="nx">sorted</span> <span class="o">?</span> <span class="nx">array</span><span class="p">.</span><span class="nx">last</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">value</span> <span class="o">:</span> <span class="o">!</span><span class="nx">array</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="nx">value</span><span class="p">)))</span>
        <span class="nx">array</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">array</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">intersect</span><span class="p">(</span><span class="nx">array</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">uniq</span><span class="p">().</span><span class="nx">findAll</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">array</span><span class="p">.</span><span class="nx">detect</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">item</span> <span class="o">===</span> <span class="nx">value</span> <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>


  <span class="kd">function</span> <span class="nx">clone</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">size</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">inspect</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">inspect</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">indexOf</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">i</span> <span class="o">||</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">length</span> <span class="o">+</span> <span class="nx">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">item</span><span class="p">)</span> <span class="k">return</span> <span class="nx">i</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">lastIndexOf</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">i</span> <span class="o">=</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">:</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">:</span> <span class="nx">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i</span><span class="p">).</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="nx">n</span> <span class="o">:</span> <span class="nx">i</span> <span class="o">-</span> <span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">concat</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">array</span> <span class="o">=</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nx">item</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">item</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="s1">&#39;callee&#39;</span> <span class="k">in</span> <span class="nx">item</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">arrayLength</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">arrayLength</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span>
          <span class="nx">array</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">item</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">array</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">array</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">arrayProto</span><span class="p">,</span> <span class="nx">Enumerable</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arrayProto</span><span class="p">.</span><span class="nx">_reverse</span><span class="p">)</span>
    <span class="nx">arrayProto</span><span class="p">.</span><span class="nx">_reverse</span> <span class="o">=</span> <span class="nx">arrayProto</span><span class="p">.</span><span class="nx">reverse</span><span class="p">;</span>

  <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">arrayProto</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">_each</span><span class="o">:</span>     <span class="nx">_each</span><span class="p">,</span>
    <span class="nx">clear</span><span class="o">:</span>     <span class="nx">clear</span><span class="p">,</span>
    <span class="nx">first</span><span class="o">:</span>     <span class="nx">first</span><span class="p">,</span>
    <span class="nx">last</span><span class="o">:</span>      <span class="nx">last</span><span class="p">,</span>
    <span class="nx">compact</span><span class="o">:</span>   <span class="nx">compact</span><span class="p">,</span>
    <span class="nx">flatten</span><span class="o">:</span>   <span class="nx">flatten</span><span class="p">,</span>
    <span class="nx">without</span><span class="o">:</span>   <span class="nx">without</span><span class="p">,</span>
    <span class="nx">reverse</span><span class="o">:</span>   <span class="nx">reverse</span><span class="p">,</span>
    <span class="nx">uniq</span><span class="o">:</span>      <span class="nx">uniq</span><span class="p">,</span>
    <span class="nx">intersect</span><span class="o">:</span> <span class="nx">intersect</span><span class="p">,</span>
    <span class="nx">clone</span><span class="o">:</span>     <span class="nx">clone</span><span class="p">,</span>
    <span class="nx">toArray</span><span class="o">:</span>   <span class="nx">clone</span><span class="p">,</span>
    <span class="nx">size</span><span class="o">:</span>      <span class="nx">size</span><span class="p">,</span>
    <span class="nx">inspect</span><span class="o">:</span>   <span class="nx">inspect</span>
  <span class="p">});</span>

  <span class="kd">var</span> <span class="nx">CONCAT_ARGUMENTS_BUGGY</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">arguments</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!==</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">})(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">CONCAT_ARGUMENTS_BUGGY</span><span class="p">)</span> <span class="nx">arrayProto</span><span class="p">.</span><span class="nx">concat</span> <span class="o">=</span> <span class="nx">concat</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arrayProto</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">)</span> <span class="nx">arrayProto</span><span class="p">.</span><span class="nx">indexOf</span> <span class="o">=</span> <span class="nx">indexOf</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arrayProto</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">)</span> <span class="nx">arrayProto</span><span class="p">.</span><span class="nx">lastIndexOf</span> <span class="o">=</span> <span class="nx">lastIndexOf</span><span class="p">;</span>
<span class="p">})();</span>
<span class="kd">function</span> <span class="nx">$H</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">Hash</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">Hash</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">Enumerable</span><span class="p">,</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">function</span> <span class="nx">initialize</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_object</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">isHash</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="o">?</span> <span class="nx">object</span><span class="p">.</span><span class="nx">toObject</span><span class="p">()</span> <span class="o">:</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
  <span class="p">}</span>


  <span class="kd">function</span> <span class="nx">_each</span><span class="p">(</span><span class="nx">iterator</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_object</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_object</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">pair</span> <span class="o">=</span> <span class="p">[</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">];</span>
      <span class="nx">pair</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
      <span class="nx">pair</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="nx">iterator</span><span class="p">(</span><span class="nx">pair</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_object</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_object</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">!==</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_object</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">unset</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_object</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
    <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">_object</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
    <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">toObject</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_object</span><span class="p">);</span>
  <span class="p">}</span>



  <span class="kd">function</span> <span class="nx">keys</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">values</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">index</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">detect</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">pair</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">pair</span><span class="p">.</span><span class="nx">value</span> <span class="o">===</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">match</span> <span class="o">&amp;&amp;</span> <span class="nx">match</span><span class="p">.</span><span class="nx">key</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">merge</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">clone</span><span class="p">().</span><span class="nx">update</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">update</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Hash</span><span class="p">(</span><span class="nx">object</span><span class="p">).</span><span class="nx">inject</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">pair</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">pair</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">pair</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">toQueryPair</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="k">return</span> <span class="nx">key</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">key</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nb">String</span><span class="p">.</span><span class="nx">interpret</span><span class="p">(</span><span class="nx">value</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">toQueryString</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">inject</span><span class="p">([],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="nx">pair</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">pair</span><span class="p">.</span><span class="nx">key</span><span class="p">),</span> <span class="nx">values</span> <span class="o">=</span> <span class="nx">pair</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">values</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">values</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">values</span><span class="p">))</span>
          <span class="k">return</span> <span class="nx">results</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">toQueryPair</span><span class="p">.</span><span class="nx">curry</span><span class="p">(</span><span class="nx">key</span><span class="p">)));</span>
      <span class="p">}</span> <span class="k">else</span> <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">toQueryPair</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">values</span><span class="p">));</span>
      <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
    <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">inspect</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">&#39;#&lt;Hash:{&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">pair</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">pair</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">inspect</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;: &#39;</span><span class="p">);</span>
    <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;}&gt;&#39;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">clone</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Hash</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">initialize</span><span class="o">:</span>             <span class="nx">initialize</span><span class="p">,</span>
    <span class="nx">_each</span><span class="o">:</span>                  <span class="nx">_each</span><span class="p">,</span>
    <span class="nx">set</span><span class="o">:</span>                    <span class="nx">set</span><span class="p">,</span>
    <span class="nx">get</span><span class="o">:</span>                    <span class="nx">get</span><span class="p">,</span>
    <span class="nx">unset</span><span class="o">:</span>                  <span class="nx">unset</span><span class="p">,</span>
    <span class="nx">toObject</span><span class="o">:</span>               <span class="nx">toObject</span><span class="p">,</span>
    <span class="nx">toTemplateReplacements</span><span class="o">:</span> <span class="nx">toObject</span><span class="p">,</span>
    <span class="nx">keys</span><span class="o">:</span>                   <span class="nx">keys</span><span class="p">,</span>
    <span class="nx">values</span><span class="o">:</span>                 <span class="nx">values</span><span class="p">,</span>
    <span class="nx">index</span><span class="o">:</span>                  <span class="nx">index</span><span class="p">,</span>
    <span class="nx">merge</span><span class="o">:</span>                  <span class="nx">merge</span><span class="p">,</span>
    <span class="nx">update</span><span class="o">:</span>                 <span class="nx">update</span><span class="p">,</span>
    <span class="nx">toQueryString</span><span class="o">:</span>          <span class="nx">toQueryString</span><span class="p">,</span>
    <span class="nx">inspect</span><span class="o">:</span>                <span class="nx">inspect</span><span class="p">,</span>
    <span class="nx">toJSON</span><span class="o">:</span>                 <span class="nx">toObject</span><span class="p">,</span>
    <span class="nx">clone</span><span class="o">:</span>                  <span class="nx">clone</span>
  <span class="p">};</span>
<span class="p">})());</span>

<span class="nx">Hash</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="nx">$H</span><span class="p">;</span>
<span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nb">Number</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">function</span> <span class="nx">toColorPart</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">toPaddedString</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">succ</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">times</span><span class="p">(</span><span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$R</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="kc">true</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">toPaddedString</span><span class="p">(</span><span class="nx">length</span><span class="p">,</span> <span class="nx">radix</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">string</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="nx">radix</span> <span class="o">||</span> <span class="mi">10</span><span class="p">);</span>
    <span class="k">return</span> <span class="s1">&#39;0&#39;</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">string</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">+</span> <span class="nx">string</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">abs</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">round</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">ceil</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">floor</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">toColorPart</span><span class="o">:</span>    <span class="nx">toColorPart</span><span class="p">,</span>
    <span class="nx">succ</span><span class="o">:</span>           <span class="nx">succ</span><span class="p">,</span>
    <span class="nx">times</span><span class="o">:</span>          <span class="nx">times</span><span class="p">,</span>
    <span class="nx">toPaddedString</span><span class="o">:</span> <span class="nx">toPaddedString</span><span class="p">,</span>
    <span class="nx">abs</span><span class="o">:</span>            <span class="nx">abs</span><span class="p">,</span>
    <span class="nx">round</span><span class="o">:</span>          <span class="nx">round</span><span class="p">,</span>
    <span class="nx">ceil</span><span class="o">:</span>           <span class="nx">ceil</span><span class="p">,</span>
    <span class="nx">floor</span><span class="o">:</span>          <span class="nx">floor</span>
  <span class="p">};</span>
<span class="p">})());</span>

<span class="kd">function</span> <span class="nx">$R</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">,</span> <span class="nx">exclusive</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">ObjectRange</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">,</span> <span class="nx">exclusive</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">ObjectRange</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">Enumerable</span><span class="p">,</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">function</span> <span class="nx">initialize</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">,</span> <span class="nx">exclusive</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="nx">start</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">end</span> <span class="o">=</span> <span class="nx">end</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">exclusive</span> <span class="o">=</span> <span class="nx">exclusive</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">_each</span><span class="p">(</span><span class="nx">iterator</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">start</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">iterator</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
      <span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">succ</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">include</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">start</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">exclusive</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">value</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">end</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">value</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">end</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="nx">initialize</span><span class="p">,</span>
    <span class="nx">_each</span><span class="o">:</span>      <span class="nx">_each</span><span class="p">,</span>
    <span class="nx">include</span><span class="o">:</span>    <span class="nx">include</span>
  <span class="p">};</span>
<span class="p">})());</span>



<span class="kd">var</span> <span class="nx">Ajax</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">getTransport</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Try</span><span class="p">.</span><span class="nx">these</span><span class="p">(</span>
      <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">()},</span>
      <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="k">new</span> <span class="nx">ActiveXObject</span><span class="p">(</span><span class="s1">&#39;Msxml2.XMLHTTP&#39;</span><span class="p">)},</span>
      <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="k">new</span> <span class="nx">ActiveXObject</span><span class="p">(</span><span class="s1">&#39;Microsoft.XMLHTTP&#39;</span><span class="p">)}</span>
    <span class="p">)</span> <span class="o">||</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">activeRequestCount</span><span class="o">:</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="nx">Ajax</span><span class="p">.</span><span class="nx">Responders</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">responders</span><span class="o">:</span> <span class="p">[],</span>

  <span class="nx">_each</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">iterator</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">responders</span><span class="p">.</span><span class="nx">_each</span><span class="p">(</span><span class="nx">iterator</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">register</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">responder</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="nx">responder</span><span class="p">))</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">responders</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">responder</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">unregister</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">responder</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">responders</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">responders</span><span class="p">.</span><span class="nx">without</span><span class="p">(</span><span class="nx">responder</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">dispatch</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">transport</span><span class="p">,</span> <span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">responder</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">responder</span><span class="p">[</span><span class="nx">callback</span><span class="p">]))</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="nx">responder</span><span class="p">[</span><span class="nx">callback</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="nx">responder</span><span class="p">,</span> <span class="p">[</span><span class="nx">request</span><span class="p">,</span> <span class="nx">transport</span><span class="p">,</span> <span class="nx">json</span><span class="p">]);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Ajax</span><span class="p">.</span><span class="nx">Responders</span><span class="p">,</span> <span class="nx">Enumerable</span><span class="p">);</span>

<span class="nx">Ajax</span><span class="p">.</span><span class="nx">Responders</span><span class="p">.</span><span class="nx">register</span><span class="p">({</span>
  <span class="nx">onCreate</span><span class="o">:</span>   <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">Ajax</span><span class="p">.</span><span class="nx">activeRequestCount</span><span class="o">++</span> <span class="p">},</span>
  <span class="nx">onComplete</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">Ajax</span><span class="p">.</span><span class="nx">activeRequestCount</span><span class="o">--</span> <span class="p">}</span>
<span class="p">});</span>
<span class="nx">Ajax</span><span class="p">.</span><span class="nx">Base</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">method</span><span class="o">:</span>       <span class="s1">&#39;post&#39;</span><span class="p">,</span>
      <span class="nx">asynchronous</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">contentType</span><span class="o">:</span>  <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span><span class="p">,</span>
      <span class="nx">encoding</span><span class="o">:</span>     <span class="s1">&#39;UTF-8&#39;</span><span class="p">,</span>
      <span class="nx">parameters</span><span class="o">:</span>   <span class="s1">&#39;&#39;</span><span class="p">,</span>
      <span class="nx">evalJSON</span><span class="o">:</span>     <span class="kc">true</span><span class="p">,</span>
      <span class="nx">evalJS</span><span class="o">:</span>       <span class="kc">true</span>
    <span class="p">};</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">,</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{</span> <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">method</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isHash</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">parameters</span><span class="p">))</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">parameters</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">parameters</span><span class="p">.</span><span class="nx">toObject</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="nx">Ajax</span><span class="p">.</span><span class="nx">Request</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">Ajax</span><span class="p">.</span><span class="nx">Base</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">_complete</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>

  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$super</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$super</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">transport</span> <span class="o">=</span> <span class="nx">Ajax</span><span class="p">.</span><span class="nx">getTransport</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">request</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">method</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">parameters</span><span class="p">)</span> <span class="o">?</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">parameters</span> <span class="o">:</span>
          <span class="nb">Object</span><span class="p">.</span><span class="nx">toQueryString</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">parameters</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">].</span><span class="nx">include</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">params</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">params</span> <span class="o">?</span> <span class="s1">&#39;&amp;&#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_method=&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="s1">&#39;post&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">method</span> <span class="o">==</span> <span class="s1">&#39;get&#39;</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">+=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&amp;&#39;</span> <span class="o">:</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">params</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="sr">/Konqueror|Safari|KHTML/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">))</span>
        <span class="nx">params</span> <span class="o">+=</span> <span class="s1">&#39;&amp;_=&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">parameters</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">toQueryParams</span><span class="p">();</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Ajax</span><span class="p">.</span><span class="nx">Response</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onCreate</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onCreate</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
      <span class="nx">Ajax</span><span class="p">.</span><span class="nx">Responders</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="s1">&#39;onCreate&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">(),</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">asynchronous</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">asynchronous</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">respondToReadyState</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">defer</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">onStateChange</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setRequestHeaders</span><span class="p">();</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">method</span> <span class="o">==</span> <span class="s1">&#39;post&#39;</span> <span class="o">?</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">postBody</span> <span class="o">||</span> <span class="nx">params</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>

      <span class="cm">/* Force Firefox to handle ready state 4 for synchronous requests */</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">asynchronous</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">overrideMimeType</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">onStateChange</span><span class="p">();</span>

    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">dispatchException</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">onStateChange</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">readyState</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">readyState</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">readyState</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">((</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_complete</span><span class="p">))</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">respondToReadyState</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">readyState</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">setRequestHeaders</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">headers</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;X-Requested-With&#39;</span><span class="o">:</span> <span class="s1">&#39;XMLHttpRequest&#39;</span><span class="p">,</span>
      <span class="s1">&#39;X-Prototype-Version&#39;</span><span class="o">:</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">Version</span><span class="p">,</span>
      <span class="s1">&#39;Accept&#39;</span><span class="o">:</span> <span class="s1">&#39;text/javascript, text/html, application/xml, text/xml, */*&#39;</span>
    <span class="p">};</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">method</span> <span class="o">==</span> <span class="s1">&#39;post&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Content-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">contentType</span> <span class="o">+</span>
        <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">encoding</span> <span class="o">?</span> <span class="s1">&#39;; charset=&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">encoding</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>

      <span class="cm">/* Force &quot;Connection: close&quot; for older Mozilla browsers to work</span>
<span class="cm">       * around a bug where XMLHttpRequest sends an incorrect</span>
<span class="cm">       * Content-length header. See Mozilla Bugzilla #246651.</span>
<span class="cm">       */</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">overrideMimeType</span> <span class="o">&amp;&amp;</span>
          <span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/Gecko\/(\d{4})/</span><span class="p">)</span> <span class="o">||</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2005</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2005</span><span class="p">)</span>
            <span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Connection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;close&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">requestHeaders</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">extras</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">requestHeaders</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">extras</span><span class="p">.</span><span class="nx">push</span><span class="p">))</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">extras</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
          <span class="nx">headers</span><span class="p">[</span><span class="nx">extras</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">extras</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
      <span class="k">else</span>
        <span class="nx">$H</span><span class="p">(</span><span class="nx">extras</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">pair</span><span class="p">)</span> <span class="p">{</span> <span class="nx">headers</span><span class="p">[</span><span class="nx">pair</span><span class="p">.</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pair</span><span class="p">.</span><span class="nx">value</span> <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">headers</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">headers</span><span class="p">[</span><span class="nx">name</span><span class="p">]);</span>
  <span class="p">},</span>

  <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">status</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getStatus</span><span class="p">();</span>
    <span class="k">return</span> <span class="o">!</span><span class="nx">status</span> <span class="o">||</span> <span class="p">(</span><span class="nx">status</span> <span class="o">&gt;=</span> <span class="mi">200</span> <span class="o">&amp;&amp;</span> <span class="nx">status</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">getStatus</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">status</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span> <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">respondToReadyState</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">readyState</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">Ajax</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Events</span><span class="p">[</span><span class="nx">readyState</span><span class="p">],</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Ajax</span><span class="p">.</span><span class="nx">Response</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">state</span> <span class="o">==</span> <span class="s1">&#39;Complete&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_complete</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="s1">&#39;on&#39;</span> <span class="o">+</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">]</span>
         <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="s1">&#39;on&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">success</span><span class="p">()</span> <span class="o">?</span> <span class="s1">&#39;Success&#39;</span> <span class="o">:</span> <span class="s1">&#39;Failure&#39;</span><span class="p">)]</span>
         <span class="o">||</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">emptyFunction</span><span class="p">)(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">headerJSON</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">dispatchException</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">contentType</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">getHeader</span><span class="p">(</span><span class="s1">&#39;Content-type&#39;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">evalJS</span> <span class="o">==</span> <span class="s1">&#39;force&#39;</span>
          <span class="o">||</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">evalJS</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">isSameOrigin</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">contentType</span>
          <span class="o">&amp;&amp;</span> <span class="nx">contentType</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^\s*(text|application)\/(x-)?(java|ecma)script(;.*)?\s*$/i</span><span class="p">)))</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">evalResponse</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="s1">&#39;on&#39;</span> <span class="o">+</span> <span class="nx">state</span><span class="p">]</span> <span class="o">||</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">emptyFunction</span><span class="p">)(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">headerJSON</span><span class="p">);</span>
      <span class="nx">Ajax</span><span class="p">.</span><span class="nx">Responders</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="s1">&#39;on&#39;</span> <span class="o">+</span> <span class="nx">state</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">headerJSON</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">dispatchException</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">state</span> <span class="o">==</span> <span class="s1">&#39;Complete&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">emptyFunction</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">isSameOrigin</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^\s*https?:\/\/[^\/]*/</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">!</span><span class="nx">m</span> <span class="o">||</span> <span class="p">(</span><span class="nx">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#{protocol}//#{domain}#{port}&#39;</span><span class="p">.</span><span class="nx">interpolate</span><span class="p">({</span>
      <span class="nx">protocol</span><span class="o">:</span> <span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span><span class="p">,</span>
      <span class="nx">domain</span><span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">domain</span><span class="p">,</span>
      <span class="nx">port</span><span class="o">:</span> <span class="nx">location</span><span class="p">.</span><span class="nx">port</span> <span class="o">?</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">location</span><span class="p">.</span><span class="nx">port</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span>
    <span class="p">}));</span>
  <span class="p">},</span>

  <span class="nx">getHeader</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">getResponseHeader</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">evalResponse</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">eval</span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">responseText</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">unfilterJSON</span><span class="p">());</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">dispatchException</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">dispatchException</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">exception</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onException</span> <span class="o">||</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">emptyFunction</span><span class="p">)(</span><span class="k">this</span><span class="p">,</span> <span class="nx">exception</span><span class="p">);</span>
    <span class="nx">Ajax</span><span class="p">.</span><span class="nx">Responders</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="s1">&#39;onException&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">exception</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Ajax</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Events</span> <span class="o">=</span>
  <span class="p">[</span><span class="s1">&#39;Uninitialized&#39;</span><span class="p">,</span> <span class="s1">&#39;Loading&#39;</span><span class="p">,</span> <span class="s1">&#39;Loaded&#39;</span><span class="p">,</span> <span class="s1">&#39;Interactive&#39;</span><span class="p">,</span> <span class="s1">&#39;Complete&#39;</span><span class="p">];</span>








<span class="nx">Ajax</span><span class="p">.</span><span class="nx">Response</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">request</span> <span class="o">=</span> <span class="nx">request</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">transport</span>  <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">transport</span>  <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">transport</span><span class="p">,</span>
        <span class="nx">readyState</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="nx">transport</span><span class="p">.</span><span class="nx">readyState</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="nx">readyState</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">Prototype</span><span class="p">.</span><span class="nx">Browser</span><span class="p">.</span><span class="nx">IE</span><span class="p">)</span> <span class="o">||</span> <span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">status</span>       <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getStatus</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">statusText</span>   <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getStatusText</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">responseText</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">interpret</span><span class="p">(</span><span class="nx">transport</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">headerJSON</span>   <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getHeaderJSON</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">xml</span> <span class="o">=</span> <span class="nx">transport</span><span class="p">.</span><span class="nx">responseXML</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">responseXML</span>  <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">xml</span><span class="p">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nx">xml</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">responseJSON</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getResponseJSON</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">status</span><span class="o">:</span>      <span class="mi">0</span><span class="p">,</span>

  <span class="nx">statusText</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>

  <span class="nx">getStatus</span><span class="o">:</span> <span class="nx">Ajax</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getStatus</span><span class="p">,</span>

  <span class="nx">getStatusText</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">statusText</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="s1">&#39;&#39;</span> <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">getHeader</span><span class="o">:</span> <span class="nx">Ajax</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getHeader</span><span class="p">,</span>

  <span class="nx">getAllHeaders</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getAllResponseHeaders</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">null</span> <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">getResponseHeader</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">getResponseHeader</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">getAllResponseHeaders</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">getAllResponseHeaders</span><span class="p">();</span>
  <span class="p">},</span>

  <span class="nx">_getHeaderJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getHeader</span><span class="p">(</span><span class="s1">&#39;X-JSON&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">json</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="nx">json</span> <span class="o">=</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">escape</span><span class="p">(</span><span class="nx">json</span><span class="p">));</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">json</span><span class="p">.</span><span class="nx">evalJSON</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">sanitizeJSON</span> <span class="o">||</span>
        <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">isSameOrigin</span><span class="p">());</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">dispatchException</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">_getResponseJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">options</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">evalJSON</span> <span class="o">||</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">evalJSON</span> <span class="o">!=</span> <span class="s1">&#39;force&#39;</span> <span class="o">&amp;&amp;</span>
      <span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getHeader</span><span class="p">(</span><span class="s1">&#39;Content-type&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">include</span><span class="p">(</span><span class="s1">&#39;application/json&#39;</span><span class="p">))</span> <span class="o">||</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">responseText</span><span class="p">.</span><span class="nx">blank</span><span class="p">())</span>
          <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">responseText</span><span class="p">.</span><span class="nx">evalJSON</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">sanitizeJSON</span> <span class="o">||</span>
        <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">isSameOrigin</span><span class="p">());</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">dispatchException</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Ajax</span><span class="p">.</span><span class="nx">Updater</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">Ajax</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$super</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">container</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">success</span><span class="o">:</span> <span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nx">success</span> <span class="o">||</span> <span class="nx">container</span><span class="p">),</span>
      <span class="nx">failure</span><span class="o">:</span> <span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nx">failure</span> <span class="o">||</span> <span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nx">success</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nx">container</span><span class="p">))</span>
    <span class="p">};</span>

    <span class="nx">options</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">onComplete</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">onComplete</span><span class="p">;</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">onComplete</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">updateContent</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">onComplete</span><span class="p">))</span> <span class="nx">onComplete</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">json</span><span class="p">);</span>
    <span class="p">}).</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

    <span class="nx">$super</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">updateContent</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">responseText</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">receiver</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">container</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">success</span><span class="p">()</span> <span class="o">?</span> <span class="s1">&#39;success&#39;</span> <span class="o">:</span> <span class="s1">&#39;failure&#39;</span><span class="p">],</span>
        <span class="nx">options</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">evalScripts</span><span class="p">)</span> <span class="nx">responseText</span> <span class="o">=</span> <span class="nx">responseText</span><span class="p">.</span><span class="nx">stripScripts</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">receiver</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">receiver</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">insertion</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">insertion</span><span class="p">))</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">insertion</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span> <span class="nx">insertion</span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">insertion</span><span class="p">]</span> <span class="o">=</span> <span class="nx">responseText</span><span class="p">;</span>
          <span class="nx">receiver</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">insertion</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="nx">options</span><span class="p">.</span><span class="nx">insertion</span><span class="p">(</span><span class="nx">receiver</span><span class="p">,</span> <span class="nx">responseText</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="nx">receiver</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">responseText</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Ajax</span><span class="p">.</span><span class="nx">PeriodicalUpdater</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">Ajax</span><span class="p">.</span><span class="nx">Base</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$super</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$super</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">onComplete</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onComplete</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">frequency</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">frequency</span> <span class="o">||</span> <span class="mi">2</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">decay</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">decay</span> <span class="o">||</span> <span class="mi">1</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">updater</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">container</span> <span class="o">=</span> <span class="nx">container</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
  <span class="p">},</span>

  <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onComplete</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">updateComplete</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">onTimerEvent</span><span class="p">();</span>
  <span class="p">},</span>

  <span class="nx">stop</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">updater</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onComplete</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="nx">clearTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">timer</span><span class="p">);</span>
    <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">onComplete</span> <span class="o">||</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">emptyFunction</span><span class="p">).</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">updateComplete</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">decay</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">decay</span> <span class="o">=</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">responseText</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">lastText</span> <span class="o">?</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">decay</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">decay</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">lastText</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">timer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">onTimerEvent</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">delay</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">decay</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">frequency</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">onTimerEvent</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">updater</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Ajax</span><span class="p">.</span><span class="nx">Updater</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">container</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>


<span class="kd">function</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">elements</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
      <span class="nx">elements</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">]));</span>
    <span class="k">return</span> <span class="nx">elements</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">element</span><span class="p">))</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">Prototype</span><span class="p">.</span><span class="nx">BrowserFeatures</span><span class="p">.</span><span class="nx">XPath</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">_getElementsByXPath</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">expression</span><span class="p">,</span> <span class="nx">parentElement</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(</span><span class="nx">expression</span><span class="p">,</span> <span class="nx">$</span><span class="p">(</span><span class="nx">parentElement</span><span class="p">)</span> <span class="o">||</span> <span class="nb">document</span><span class="p">,</span>
      <span class="kc">null</span><span class="p">,</span> <span class="nx">XPathResult</span><span class="p">.</span><span class="nx">ORDERED_NODE_SNAPSHOT_TYPE</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">query</span><span class="p">.</span><span class="nx">snapshotLength</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
      <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">query</span><span class="p">.</span><span class="nx">snapshotItem</span><span class="p">(</span><span class="nx">i</span><span class="p">)));</span>
    <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="cm">/*--------------------------------------------------------------------------*/</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Node</span><span class="p">)</span> <span class="kd">var</span> <span class="nx">Node</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Node</span><span class="p">.</span><span class="nx">ELEMENT_NODE</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Node</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">ELEMENT_NODE</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nx">ATTRIBUTE_NODE</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="nx">TEXT_NODE</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="nx">CDATA_SECTION_NODE</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="nx">ENTITY_REFERENCE_NODE</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="nx">ENTITY_NODE</span><span class="o">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="nx">PROCESSING_INSTRUCTION_NODE</span><span class="o">:</span> <span class="mi">7</span><span class="p">,</span>
    <span class="nx">COMMENT_NODE</span><span class="o">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="nx">DOCUMENT_NODE</span><span class="o">:</span> <span class="mi">9</span><span class="p">,</span>
    <span class="nx">DOCUMENT_TYPE_NODE</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="nx">DOCUMENT_FRAGMENT_NODE</span><span class="o">:</span> <span class="mi">11</span><span class="p">,</span>
    <span class="nx">NOTATION_NODE</span><span class="o">:</span> <span class="mi">12</span>
  <span class="p">});</span>
<span class="p">}</span>



<span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">global</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">HAS_EXTENDED_CREATE_ELEMENT_SYNTAX</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;&lt;input name=&quot;x&quot;&gt;&#39;</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">el</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;input&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">el</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;x&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">})();</span>

  <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">Element</span><span class="p">;</span>

  <span class="nx">global</span><span class="p">.</span><span class="nx">Element</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tagName</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">attributes</span> <span class="o">||</span> <span class="p">{</span> <span class="p">};</span>
    <span class="nx">tagName</span> <span class="o">=</span> <span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">cache</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">cache</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">HAS_EXTENDED_CREATE_ELEMENT_SYNTAX</span> <span class="o">&amp;&amp;</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">tagName</span> <span class="o">=</span> <span class="s1">&#39;&lt;&#39;</span> <span class="o">+</span> <span class="nx">tagName</span> <span class="o">+</span> <span class="s1">&#39; name=&quot;&#39;</span> <span class="o">+</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&#39;</span><span class="p">;</span>
      <span class="k">delete</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">writeAttribute</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">tagName</span><span class="p">),</span> <span class="nx">attributes</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cache</span><span class="p">[</span><span class="nx">tagName</span><span class="p">])</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">tagName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">tagName</span><span class="p">));</span>

    <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;type&#39;</span> <span class="k">in</span> <span class="nx">attributes</span><span class="p">)</span> <span class="o">?</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">tagName</span><span class="p">)</span> <span class="o">:</span>
     <span class="nx">cache</span><span class="p">[</span><span class="nx">tagName</span><span class="p">].</span><span class="nx">cloneNode</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">writeAttribute</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">Element</span><span class="p">,</span> <span class="nx">element</span> <span class="o">||</span> <span class="p">{</span> <span class="p">});</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="nx">global</span><span class="p">.</span><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>

<span class="p">})(</span><span class="k">this</span><span class="p">);</span>

<span class="nx">Element</span><span class="p">.</span><span class="nx">idCounter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">cache</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>

<span class="nx">Element</span><span class="p">.</span><span class="nx">_purgeElement</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">uid</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">_prototypeUID</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">uid</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Element</span><span class="p">.</span><span class="nx">stopObserving</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">_prototypeUID</span> <span class="o">=</span> <span class="k">void</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">delete</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Storage</span><span class="p">[</span><span class="nx">uid</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">visible</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">toggle</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="nx">Element</span><span class="p">[</span><span class="nx">Element</span><span class="p">.</span><span class="nx">visible</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;hide&#39;</span> <span class="o">:</span> <span class="s1">&#39;show&#39;</span><span class="p">](</span><span class="nx">element</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">hide</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">show</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">remove</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">update</span><span class="o">:</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>

    <span class="kd">var</span> <span class="nx">SELECT_ELEMENT_INNERHTML_BUGGY</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
      <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;select&quot;</span><span class="p">),</span>
          <span class="nx">isBuggy</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">el</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&lt;option value=\&quot;test\&quot;&gt;test&lt;/option&gt;&quot;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">options</span> <span class="o">&amp;&amp;</span> <span class="nx">el</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">isBuggy</span> <span class="o">=</span> <span class="nx">el</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">!==</span> <span class="s2">&quot;OPTION&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">el</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">isBuggy</span><span class="p">;</span>
    <span class="p">})();</span>

    <span class="kd">var</span> <span class="nx">TABLE_ELEMENT_INNERHTML_BUGGY</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;table&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">el</span> <span class="o">&amp;&amp;</span> <span class="nx">el</span><span class="p">.</span><span class="nx">tBodies</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">el</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;test&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&quot;</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">isBuggy</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">el</span><span class="p">.</span><span class="nx">tBodies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">;</span>
          <span class="nx">el</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="k">return</span> <span class="nx">isBuggy</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">})();</span>

    <span class="kd">var</span> <span class="nx">SCRIPT_ELEMENT_REJECTS_TEXTNODE_APPENDING</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;script&quot;</span><span class="p">),</span>
          <span class="nx">isBuggy</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">s</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">));</span>
        <span class="nx">isBuggy</span> <span class="o">=</span> <span class="o">!</span><span class="nx">s</span><span class="p">.</span><span class="nx">firstChild</span> <span class="o">||</span>
          <span class="nx">s</span><span class="p">.</span><span class="nx">firstChild</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">!==</span> <span class="mi">3</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">isBuggy</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">s</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">isBuggy</span><span class="p">;</span>
    <span class="p">})();</span>

    <span class="kd">function</span> <span class="nx">update</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">purgeElement</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">_purgeElement</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">descendants</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">),</span>
       <span class="nx">i</span> <span class="o">=</span> <span class="nx">descendants</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="nx">purgeElement</span><span class="p">(</span><span class="nx">descendants</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">content</span> <span class="o">&amp;&amp;</span> <span class="nx">content</span><span class="p">.</span><span class="nx">toElement</span><span class="p">)</span>
        <span class="nx">content</span> <span class="o">=</span> <span class="nx">content</span><span class="p">.</span><span class="nx">toElement</span><span class="p">();</span>

      <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isElement</span><span class="p">(</span><span class="nx">content</span><span class="p">))</span>
        <span class="k">return</span> <span class="nx">element</span><span class="p">.</span><span class="nx">update</span><span class="p">().</span><span class="nx">insert</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>

      <span class="nx">content</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">toHTML</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">tagName</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">();</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">tagName</span> <span class="o">===</span> <span class="s1">&#39;SCRIPT&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">SCRIPT_ELEMENT_REJECTS_TEXTNODE_APPENDING</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">content</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">SELECT_ELEMENT_INNERHTML_BUGGY</span> <span class="o">||</span> <span class="nx">TABLE_ELEMENT_INNERHTML_BUGGY</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">tagName</span> <span class="k">in</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">_insertionTranslations</span><span class="p">.</span><span class="nx">tags</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">while</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">element</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="nx">Element</span><span class="p">.</span><span class="nx">_getContentFromAnonymousElement</span><span class="p">(</span><span class="nx">tagName</span><span class="p">,</span> <span class="nx">content</span><span class="p">.</span><span class="nx">stripScripts</span><span class="p">())</span>
            <span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">element</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
            <span class="p">});</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">element</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">content</span><span class="p">.</span><span class="nx">stripScripts</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">content</span><span class="p">.</span><span class="nx">stripScripts</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="nx">content</span><span class="p">.</span><span class="nx">evalScripts</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">content</span><span class="p">).</span><span class="nx">defer</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">update</span><span class="p">;</span>
  <span class="p">})(),</span>

  <span class="nx">replace</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">content</span> <span class="o">&amp;&amp;</span> <span class="nx">content</span><span class="p">.</span><span class="nx">toElement</span><span class="p">)</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">content</span><span class="p">.</span><span class="nx">toElement</span><span class="p">();</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isElement</span><span class="p">(</span><span class="nx">content</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">content</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">toHTML</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">range</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">ownerDocument</span><span class="p">.</span><span class="nx">createRange</span><span class="p">();</span>
      <span class="nx">range</span><span class="p">.</span><span class="nx">selectNode</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
      <span class="nx">content</span><span class="p">.</span><span class="nx">evalScripts</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">content</span><span class="p">).</span><span class="nx">defer</span><span class="p">();</span>
      <span class="nx">content</span> <span class="o">=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">createContextualFragment</span><span class="p">(</span><span class="nx">content</span><span class="p">.</span><span class="nx">stripScripts</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">replaceChild</span><span class="p">(</span><span class="nx">content</span><span class="p">,</span> <span class="nx">element</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">insert</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">insertions</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">insertions</span><span class="p">)</span> <span class="o">||</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">isNumber</span><span class="p">(</span><span class="nx">insertions</span><span class="p">)</span> <span class="o">||</span>
        <span class="nb">Object</span><span class="p">.</span><span class="nx">isElement</span><span class="p">(</span><span class="nx">insertions</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">insertions</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">insertions</span><span class="p">.</span><span class="nx">toElement</span> <span class="o">||</span> <span class="nx">insertions</span><span class="p">.</span><span class="nx">toHTML</span><span class="p">)))</span>
          <span class="nx">insertions</span> <span class="o">=</span> <span class="p">{</span><span class="nx">bottom</span><span class="o">:</span><span class="nx">insertions</span><span class="p">};</span>

    <span class="kd">var</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">insert</span><span class="p">,</span> <span class="nx">tagName</span><span class="p">,</span> <span class="nx">childNodes</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">position</span> <span class="k">in</span> <span class="nx">insertions</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">content</span>  <span class="o">=</span> <span class="nx">insertions</span><span class="p">[</span><span class="nx">position</span><span class="p">];</span>
      <span class="nx">position</span> <span class="o">=</span> <span class="nx">position</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
      <span class="nx">insert</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">_insertionTranslations</span><span class="p">[</span><span class="nx">position</span><span class="p">];</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">content</span> <span class="o">&amp;&amp;</span> <span class="nx">content</span><span class="p">.</span><span class="nx">toElement</span><span class="p">)</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">content</span><span class="p">.</span><span class="nx">toElement</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isElement</span><span class="p">(</span><span class="nx">content</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">insert</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">content</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">content</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">toHTML</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>

      <span class="nx">tagName</span> <span class="o">=</span> <span class="p">((</span><span class="nx">position</span> <span class="o">==</span> <span class="s1">&#39;before&#39;</span> <span class="o">||</span> <span class="nx">position</span> <span class="o">==</span> <span class="s1">&#39;after&#39;</span><span class="p">)</span>
        <span class="o">?</span> <span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">:</span> <span class="nx">element</span><span class="p">).</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">();</span>

      <span class="nx">childNodes</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">_getContentFromAnonymousElement</span><span class="p">(</span><span class="nx">tagName</span><span class="p">,</span> <span class="nx">content</span><span class="p">.</span><span class="nx">stripScripts</span><span class="p">());</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">position</span> <span class="o">==</span> <span class="s1">&#39;top&#39;</span> <span class="o">||</span> <span class="nx">position</span> <span class="o">==</span> <span class="s1">&#39;after&#39;</span><span class="p">)</span> <span class="nx">childNodes</span><span class="p">.</span><span class="nx">reverse</span><span class="p">();</span>
      <span class="nx">childNodes</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">insert</span><span class="p">.</span><span class="nx">curry</span><span class="p">(</span><span class="nx">element</span><span class="p">));</span>

      <span class="nx">content</span><span class="p">.</span><span class="nx">evalScripts</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">content</span><span class="p">).</span><span class="nx">defer</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">wrap</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">wrapper</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isElement</span><span class="p">(</span><span class="nx">wrapper</span><span class="p">))</span>
      <span class="nx">$</span><span class="p">(</span><span class="nx">wrapper</span><span class="p">).</span><span class="nx">writeAttribute</span><span class="p">(</span><span class="nx">attributes</span> <span class="o">||</span> <span class="p">{</span> <span class="p">});</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">wrapper</span><span class="p">))</span> <span class="nx">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">(</span><span class="nx">wrapper</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">);</span>
    <span class="k">else</span> <span class="nx">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="nx">wrapper</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">)</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">replaceChild</span><span class="p">(</span><span class="nx">wrapper</span><span class="p">,</span> <span class="nx">element</span><span class="p">);</span>
    <span class="nx">wrapper</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">wrapper</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">inspect</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="s1">&#39;&lt;&#39;</span> <span class="o">+</span> <span class="nx">element</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
    <span class="nx">$H</span><span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;className&#39;</span><span class="o">:</span> <span class="s1">&#39;class&#39;</span><span class="p">}).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">pair</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">property</span> <span class="o">=</span> <span class="nx">pair</span><span class="p">.</span><span class="nx">first</span><span class="p">(),</span>
          <span class="nx">attribute</span> <span class="o">=</span> <span class="nx">pair</span><span class="p">.</span><span class="nx">last</span><span class="p">(),</span>
          <span class="nx">value</span> <span class="o">=</span> <span class="p">(</span><span class="nx">element</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="nx">result</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">attribute</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="nx">value</span><span class="p">.</span><span class="nx">inspect</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">result</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">recursivelyCollect</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">maximumLength</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="nx">maximumLength</span> <span class="o">=</span> <span class="nx">maximumLength</span> <span class="o">||</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">elements</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">while</span> <span class="p">(</span><span class="nx">element</span> <span class="o">=</span> <span class="nx">element</span><span class="p">[</span><span class="nx">property</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nx">elements</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">element</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">elements</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="nx">maximumLength</span><span class="p">)</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">elements</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">ancestors</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">recursivelyCollect</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;parentNode&#39;</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">descendants</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">firstDescendant</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">firstChild</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">element</span> <span class="o">&amp;&amp;</span> <span class="nx">element</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">immediateDescendants</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">child</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">firstChild</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">child</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">child</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="nx">child</span> <span class="o">=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">previousSiblings</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">maximumLength</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">recursivelyCollect</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;previousSibling&#39;</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">nextSiblings</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">recursivelyCollect</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;nextSibling&#39;</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">siblings</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">previousSiblings</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">reverse</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">nextSiblings</span><span class="p">(</span><span class="nx">element</span><span class="p">));</span>
  <span class="p">},</span>

  <span class="nx">match</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">selector</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">selector</span><span class="p">))</span>
      <span class="k">return</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">Selector</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">selector</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">selector</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">up</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">expression</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">ancestors</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">ancestors</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">isNumber</span><span class="p">(</span><span class="nx">expression</span><span class="p">)</span> <span class="o">?</span> <span class="nx">ancestors</span><span class="p">[</span><span class="nx">expression</span><span class="p">]</span> <span class="o">:</span>
      <span class="nx">Prototype</span><span class="p">.</span><span class="nx">Selector</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">ancestors</span><span class="p">,</span> <span class="nx">expression</span><span class="p">,</span> <span class="nx">index</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">down</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">expression</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">firstDescendant</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">isNumber</span><span class="p">(</span><span class="nx">expression</span><span class="p">)</span> <span class="o">?</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">descendants</span><span class="p">(</span><span class="nx">element</span><span class="p">)[</span><span class="nx">expression</span><span class="p">]</span> <span class="o">:</span>
      <span class="nx">Element</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">expression</span><span class="p">)[</span><span class="nx">index</span> <span class="o">||</span> <span class="mi">0</span><span class="p">];</span>
  <span class="p">},</span>

  <span class="nx">previous</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">expression</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isNumber</span><span class="p">(</span><span class="nx">expression</span><span class="p">))</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">expression</span><span class="p">,</span> <span class="nx">expression</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isNumber</span><span class="p">(</span><span class="nx">index</span><span class="p">))</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">expression</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">Selector</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">previousSiblings</span><span class="p">(),</span> <span class="nx">expression</span><span class="p">,</span> <span class="nx">index</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">element</span><span class="p">.</span><span class="nx">recursivelyCollect</span><span class="p">(</span><span class="s2">&quot;previousSibling&quot;</span><span class="p">,</span> <span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[</span><span class="nx">index</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">next</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">expression</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isNumber</span><span class="p">(</span><span class="nx">expression</span><span class="p">))</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">expression</span><span class="p">,</span> <span class="nx">expression</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isNumber</span><span class="p">(</span><span class="nx">index</span><span class="p">))</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">expression</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">Selector</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">nextSiblings</span><span class="p">(),</span> <span class="nx">expression</span><span class="p">,</span> <span class="nx">index</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">maximumLength</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">isNumber</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="o">?</span> <span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">element</span><span class="p">.</span><span class="nx">recursivelyCollect</span><span class="p">(</span><span class="s2">&quot;nextSibling&quot;</span><span class="p">,</span> <span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[</span><span class="nx">index</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">},</span>


  <span class="nx">select</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">expressions</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">Selector</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">expressions</span><span class="p">,</span> <span class="nx">element</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">adjacent</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">expressions</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">Selector</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">expressions</span><span class="p">,</span> <span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">).</span><span class="nx">without</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">identify</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">readAttribute</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="k">return</span> <span class="nx">id</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span> <span class="nx">id</span> <span class="o">=</span> <span class="s1">&#39;anonymous_element_&#39;</span> <span class="o">+</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">idCounter</span><span class="o">++</span> <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">id</span><span class="p">));</span>
    <span class="nx">Element</span><span class="p">.</span><span class="nx">writeAttribute</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">id</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">readAttribute</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">Prototype</span><span class="p">.</span><span class="nx">Browser</span><span class="p">.</span><span class="nx">IE</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">_attributeTranslations</span><span class="p">.</span><span class="nx">read</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span> <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">name</span><span class="p">](</span><span class="nx">element</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">names</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">names</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="nx">element</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">||</span> <span class="o">!</span><span class="nx">element</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span>
         <span class="nx">element</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">writeAttribute</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="p">{</span> <span class="p">},</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">_attributeTranslations</span><span class="p">.</span><span class="nx">write</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="k">else</span> <span class="nx">attributes</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">?</span> <span class="kc">true</span> <span class="o">:</span> <span class="nx">value</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">attr</span> <span class="k">in</span> <span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">name</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">names</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span> <span class="o">||</span> <span class="nx">attr</span><span class="p">;</span>
      <span class="nx">value</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">[</span><span class="nx">attr</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">attr</span><span class="p">])</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">attr</span><span class="p">](</span><span class="nx">element</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="kc">false</span> <span class="o">||</span> <span class="nx">value</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">removeAttribute</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
      <span class="k">else</span> <span class="nx">element</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">getHeight</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">getDimensions</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">height</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">getWidth</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">getDimensions</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">width</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">classNames</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">ClassNames</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">hasClassName</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">className</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">)))</span> <span class="k">return</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">elementClassName</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">className</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">elementClassName</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">elementClassName</span> <span class="o">==</span> <span class="nx">className</span> <span class="o">||</span>
      <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;(^|\\s)&quot;</span> <span class="o">+</span> <span class="nx">className</span> <span class="o">+</span> <span class="s2">&quot;(\\s|$)&quot;</span><span class="p">).</span><span class="nx">test</span><span class="p">(</span><span class="nx">elementClassName</span><span class="p">)));</span>
  <span class="p">},</span>

  <span class="nx">addClassName</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">className</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">)))</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Element</span><span class="p">.</span><span class="nx">hasClassName</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">className</span><span class="p">))</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">className</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">className</span> <span class="o">?</span> <span class="s1">&#39; &#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">className</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">removeClassName</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">className</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">)))</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">className</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span>
      <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;(^|\\s+)&quot;</span> <span class="o">+</span> <span class="nx">className</span> <span class="o">+</span> <span class="s2">&quot;(\\s+|$)&quot;</span><span class="p">),</span> <span class="s1">&#39; &#39;</span><span class="p">).</span><span class="nx">strip</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">toggleClassName</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">className</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">)))</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">Element</span><span class="p">[</span><span class="nx">Element</span><span class="p">.</span><span class="nx">hasClassName</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">className</span><span class="p">)</span> <span class="o">?</span>
      <span class="s1">&#39;removeClassName&#39;</span> <span class="o">:</span> <span class="s1">&#39;addClassName&#39;</span><span class="p">](</span><span class="nx">element</span><span class="p">,</span> <span class="nx">className</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">cleanWhitespace</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">nextNode</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="sr">/\S/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeValue</span><span class="p">))</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
      <span class="nx">node</span> <span class="o">=</span> <span class="nx">nextNode</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">empty</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">innerHTML</span><span class="p">.</span><span class="nx">blank</span><span class="p">();</span>
  <span class="p">},</span>

  <span class="nx">descendantOf</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">ancestor</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">),</span> <span class="nx">ancestor</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">ancestor</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">compareDocumentPosition</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">compareDocumentPosition</span><span class="p">(</span><span class="nx">ancestor</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">===</span> <span class="mi">8</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">ancestor</span><span class="p">.</span><span class="nx">contains</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">ancestor</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">ancestor</span> <span class="o">!==</span> <span class="nx">element</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="nx">element</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">element</span> <span class="o">==</span> <span class="nx">ancestor</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">scrollTo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">cumulativeOffset</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">scrollTo</span><span class="p">(</span><span class="nx">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">getStyle</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">style</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="nx">style</span> <span class="o">=</span> <span class="nx">style</span> <span class="o">==</span> <span class="s1">&#39;float&#39;</span> <span class="o">?</span> <span class="s1">&#39;cssFloat&#39;</span> <span class="o">:</span> <span class="nx">style</span><span class="p">.</span><span class="nx">camelize</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="nx">style</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">value</span> <span class="o">||</span> <span class="nx">value</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">css</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">defaultView</span><span class="p">.</span><span class="nx">getComputedStyle</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="nx">value</span> <span class="o">=</span> <span class="nx">css</span> <span class="o">?</span> <span class="nx">css</span><span class="p">[</span><span class="nx">style</span><span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">style</span> <span class="o">==</span> <span class="s1">&#39;opacity&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">value</span> <span class="o">?</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">:</span> <span class="mf">1.0</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">value</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">getOpacity</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">getStyle</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">setStyle</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">styles</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">elementStyle</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">,</span> <span class="nx">match</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">styles</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">cssText</span> <span class="o">+=</span> <span class="s1">&#39;;&#39;</span> <span class="o">+</span> <span class="nx">styles</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">styles</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">)</span> <span class="o">?</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">setOpacity</span><span class="p">(</span><span class="nx">styles</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/opacity:\s*(\d?\.?\d*)/</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="o">:</span> <span class="nx">element</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">property</span> <span class="k">in</span> <span class="nx">styles</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">property</span> <span class="o">==</span> <span class="s1">&#39;opacity&#39;</span><span class="p">)</span> <span class="nx">element</span><span class="p">.</span><span class="nx">setOpacity</span><span class="p">(</span><span class="nx">styles</span><span class="p">[</span><span class="nx">property</span><span class="p">]);</span>
      <span class="k">else</span>
        <span class="nx">elementStyle</span><span class="p">[(</span><span class="nx">property</span> <span class="o">==</span> <span class="s1">&#39;float&#39;</span> <span class="o">||</span> <span class="nx">property</span> <span class="o">==</span> <span class="s1">&#39;cssFloat&#39;</span><span class="p">)</span> <span class="o">?</span>
          <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">elementStyle</span><span class="p">.</span><span class="nx">styleFloat</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;cssFloat&#39;</span> <span class="o">:</span> <span class="s1">&#39;styleFloat&#39;</span><span class="p">)</span> <span class="o">:</span>
            <span class="nx">property</span><span class="p">]</span> <span class="o">=</span> <span class="nx">styles</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>

    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">setOpacity</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span> <span class="o">:</span>
      <span class="p">(</span><span class="nx">value</span> <span class="o">&lt;</span> <span class="mf">0.00001</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">value</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">makePositioned</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;position&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">==</span> <span class="s1">&#39;static&#39;</span> <span class="o">||</span> <span class="o">!</span><span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">_madePositioned</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s1">&#39;relative&#39;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">Prototype</span><span class="p">.</span><span class="nx">Browser</span><span class="p">.</span><span class="nx">Opera</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">undoPositioned</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">_madePositioned</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">_madePositioned</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">=</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">right</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">makeClipping</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">_overflow</span><span class="p">)</span> <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">_overflow</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;overflow&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;auto&#39;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">_overflow</span> <span class="o">!==</span> <span class="s1">&#39;hidden&#39;</span><span class="p">)</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">overflow</span> <span class="o">=</span> <span class="s1">&#39;hidden&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">undoClipping</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">element</span><span class="p">.</span><span class="nx">_overflow</span><span class="p">)</span> <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">overflow</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">_overflow</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span> <span class="o">:</span> <span class="nx">element</span><span class="p">.</span><span class="nx">_overflow</span><span class="p">;</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">_overflow</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">clonePosition</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
      <span class="nx">setLeft</span><span class="o">:</span>    <span class="kc">true</span><span class="p">,</span>
      <span class="nx">setTop</span><span class="o">:</span>     <span class="kc">true</span><span class="p">,</span>
      <span class="nx">setWidth</span><span class="o">:</span>   <span class="kc">true</span><span class="p">,</span>
      <span class="nx">setHeight</span><span class="o">:</span>  <span class="kc">true</span><span class="p">,</span>
      <span class="nx">offsetTop</span><span class="o">:</span>  <span class="mi">0</span><span class="p">,</span>
      <span class="nx">offsetLeft</span><span class="o">:</span> <span class="mi">0</span>
    <span class="p">},</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="p">{</span> <span class="p">});</span>

    <span class="nx">source</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">source</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">viewportOffset</span><span class="p">(</span><span class="nx">source</span><span class="p">),</span> <span class="nx">delta</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="nx">parent</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;position&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;absolute&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">parent</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">getOffsetParent</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
      <span class="nx">delta</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">viewportOffset</span><span class="p">(</span><span class="nx">parent</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">parent</span> <span class="o">==</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">delta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">offsetLeft</span><span class="p">;</span>
      <span class="nx">delta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">offsetTop</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">setLeft</span><span class="p">)</span>   <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span>  <span class="o">=</span> <span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">delta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">options</span><span class="p">.</span><span class="nx">offsetLeft</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">setTop</span><span class="p">)</span>    <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span>   <span class="o">=</span> <span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">delta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">options</span><span class="p">.</span><span class="nx">offsetTop</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">setWidth</span><span class="p">)</span>  <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">offsetWidth</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">setHeight</span><span class="p">)</span> <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">offsetHeight</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">getElementsBySelector</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">select</span><span class="p">,</span>

  <span class="nx">childElements</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">immediateDescendants</span>
<span class="p">});</span>

<span class="nx">Element</span><span class="p">.</span><span class="nx">_attributeTranslations</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">write</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">names</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">className</span><span class="o">:</span> <span class="s1">&#39;class&#39;</span><span class="p">,</span>
      <span class="nx">htmlFor</span><span class="o">:</span>   <span class="s1">&#39;for&#39;</span>
    <span class="p">},</span>
    <span class="nx">values</span><span class="o">:</span> <span class="p">{</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">Prototype</span><span class="p">.</span><span class="nx">Browser</span><span class="p">.</span><span class="nx">Opera</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">getStyle</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">proceed</span><span class="p">,</span> <span class="nx">element</span><span class="p">,</span> <span class="nx">style</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">switch</span> <span class="p">(</span><span class="nx">style</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="s1">&#39;left&#39;</span><span class="o">:</span> <span class="k">case</span> <span class="s1">&#39;top&#39;</span><span class="o">:</span> <span class="k">case</span> <span class="s1">&#39;right&#39;</span><span class="o">:</span> <span class="k">case</span> <span class="s1">&#39;bottom&#39;</span><span class="o">:</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">proceed</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;position&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;static&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">case</span> <span class="s1">&#39;height&#39;</span><span class="o">:</span> <span class="k">case</span> <span class="s1">&#39;width&#39;</span><span class="o">:</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Element</span><span class="p">.</span><span class="nx">visible</span><span class="p">(</span><span class="nx">element</span><span class="p">))</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>

          <span class="kd">var</span> <span class="nx">dim</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">proceed</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">style</span><span class="p">),</span> <span class="mi">10</span><span class="p">);</span>

          <span class="k">if</span> <span class="p">(</span><span class="nx">dim</span> <span class="o">!==</span> <span class="nx">element</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span> <span class="o">+</span> <span class="nx">style</span><span class="p">.</span><span class="nx">capitalize</span><span class="p">()])</span>
            <span class="k">return</span> <span class="nx">dim</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">;</span>

          <span class="kd">var</span> <span class="nx">properties</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">style</span> <span class="o">===</span> <span class="s1">&#39;height&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">properties</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;border-top-width&#39;</span><span class="p">,</span> <span class="s1">&#39;padding-top&#39;</span><span class="p">,</span>
             <span class="s1">&#39;padding-bottom&#39;</span><span class="p">,</span> <span class="s1">&#39;border-bottom-width&#39;</span><span class="p">];</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="nx">properties</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;border-left-width&#39;</span><span class="p">,</span> <span class="s1">&#39;padding-left&#39;</span><span class="p">,</span>
             <span class="s1">&#39;padding-right&#39;</span><span class="p">,</span> <span class="s1">&#39;border-right-width&#39;</span><span class="p">];</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">properties</span><span class="p">.</span><span class="nx">inject</span><span class="p">(</span><span class="nx">dim</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">memo</span><span class="p">,</span> <span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">proceed</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">property</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">val</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">memo</span> <span class="o">:</span> <span class="nx">memo</span> <span class="o">-</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
          <span class="p">})</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span> <span class="k">return</span> <span class="nx">proceed</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">style</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">);</span>

  <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">readAttribute</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">readAttribute</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">proceed</span><span class="p">,</span> <span class="nx">element</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">attribute</span> <span class="o">===</span> <span class="s1">&#39;title&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">element</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">proceed</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">Prototype</span><span class="p">.</span><span class="nx">Browser</span><span class="p">.</span><span class="nx">IE</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">getStyle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">style</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="nx">style</span> <span class="o">=</span> <span class="p">(</span><span class="nx">style</span> <span class="o">==</span> <span class="s1">&#39;float&#39;</span> <span class="o">||</span> <span class="nx">style</span> <span class="o">==</span> <span class="s1">&#39;cssFloat&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;styleFloat&#39;</span> <span class="o">:</span> <span class="nx">style</span><span class="p">.</span><span class="nx">camelize</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="nx">style</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="nx">element</span><span class="p">.</span><span class="nx">currentStyle</span><span class="p">)</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">currentStyle</span><span class="p">[</span><span class="nx">style</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">style</span> <span class="o">==</span> <span class="s1">&#39;opacity&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">=</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="s1">&#39;filter&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">match</span><span class="p">(</span><span class="sr">/alpha\(opacity=(.*)\)/</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">return</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
      <span class="k">return</span> <span class="mf">1.0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="nx">style</span> <span class="o">==</span> <span class="s1">&#39;width&#39;</span> <span class="o">||</span> <span class="nx">style</span> <span class="o">==</span> <span class="s1">&#39;height&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="s1">&#39;display&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="nx">element</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span> <span class="o">+</span> <span class="nx">style</span><span class="p">.</span><span class="nx">capitalize</span><span class="p">()]</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">;</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">setOpacity</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">stripAlpha</span><span class="p">(</span><span class="nx">filter</span><span class="p">){</span>
      <span class="k">return</span> <span class="nx">filter</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/alpha\([^\)]*\)/gi</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">currentStyle</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">currentStyle</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="nx">currentStyle</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">currentStyle</span><span class="p">.</span><span class="nx">hasLayout</span><span class="p">)</span> <span class="o">||</span>
      <span class="p">(</span><span class="o">!</span><span class="nx">currentStyle</span> <span class="o">&amp;&amp;</span> <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">zoom</span> <span class="o">==</span> <span class="s1">&#39;normal&#39;</span><span class="p">))</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">zoom</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">filter</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="s1">&#39;filter&#39;</span><span class="p">),</span> <span class="nx">style</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">(</span><span class="nx">filter</span> <span class="o">=</span> <span class="nx">stripAlpha</span><span class="p">(</span><span class="nx">filter</span><span class="p">))</span> <span class="o">?</span>
        <span class="nx">style</span><span class="p">.</span><span class="nx">filter</span> <span class="o">=</span> <span class="nx">filter</span> <span class="o">:</span> <span class="nx">style</span><span class="p">.</span><span class="nx">removeAttribute</span><span class="p">(</span><span class="s1">&#39;filter&#39;</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&lt;</span> <span class="mf">0.00001</span><span class="p">)</span> <span class="nx">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">style</span><span class="p">.</span><span class="nx">filter</span> <span class="o">=</span> <span class="nx">stripAlpha</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span> <span class="o">+</span>
      <span class="s1">&#39;alpha(opacity=&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">value</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Element</span><span class="p">.</span><span class="nx">_attributeTranslations</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>

    <span class="kd">var</span> <span class="nx">classProp</span> <span class="o">=</span> <span class="s1">&#39;className&#39;</span><span class="p">,</span>
        <span class="nx">forProp</span> <span class="o">=</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span>
        <span class="nx">el</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>

    <span class="nx">el</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="nx">classProp</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">className</span> <span class="o">!==</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">el</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">className</span> <span class="o">===</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">classProp</span> <span class="o">=</span> <span class="s1">&#39;class&#39;</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">el</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="nx">el</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">);</span>
    <span class="nx">el</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="nx">forProp</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">htmlFor</span> <span class="o">!==</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">el</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;htmlFor&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">htmlFor</span> <span class="o">===</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">forProp</span> <span class="o">=</span> <span class="s1">&#39;htmlFor&#39;</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">el</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">read</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">names</span><span class="o">:</span> <span class="p">{</span>
          <span class="s1">&#39;class&#39;</span><span class="o">:</span>      <span class="nx">classProp</span><span class="p">,</span>
          <span class="s1">&#39;className&#39;</span><span class="o">:</span>  <span class="nx">classProp</span><span class="p">,</span>
          <span class="s1">&#39;for&#39;</span><span class="o">:</span>        <span class="nx">forProp</span><span class="p">,</span>
          <span class="s1">&#39;htmlFor&#39;</span><span class="o">:</span>    <span class="nx">forProp</span>
        <span class="p">},</span>
        <span class="nx">values</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">_getAttr</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="nx">attribute</span><span class="p">);</span>
          <span class="p">},</span>
          <span class="nx">_getAttr2</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="nx">attribute</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
          <span class="p">},</span>
          <span class="nx">_getAttrNode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getAttributeNode</span><span class="p">(</span><span class="nx">attribute</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">node</span> <span class="o">?</span> <span class="nx">node</span><span class="p">.</span><span class="nx">value</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
          <span class="p">},</span>
          <span class="nx">_getEv</span><span class="o">:</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>

            <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">),</span> <span class="nx">f</span><span class="p">;</span>
            <span class="nx">el</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">emptyFunction</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">el</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;onclick&#39;</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">String</span><span class="p">(</span><span class="nx">value</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">f</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">attribute</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="nx">attribute</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attribute</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                <span class="nx">attribute</span> <span class="o">=</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
                <span class="nx">attribute</span> <span class="o">=</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
                <span class="nx">attribute</span> <span class="o">=</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
                <span class="k">return</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">strip</span><span class="p">();</span>
              <span class="p">};</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">f</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">attribute</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="nx">attribute</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attribute</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">strip</span><span class="p">();</span>
              <span class="p">};</span>
            <span class="p">}</span>
            <span class="nx">el</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">f</span><span class="p">;</span>
          <span class="p">})(),</span>
          <span class="nx">_flag</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">hasAttribute</span><span class="p">(</span><span class="nx">attribute</span><span class="p">)</span> <span class="o">?</span> <span class="nx">attribute</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
          <span class="p">},</span>
          <span class="nx">style</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">cssText</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
          <span class="p">},</span>
          <span class="nx">title</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">element</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">})();</span>

  <span class="nx">Element</span><span class="p">.</span><span class="nx">_attributeTranslations</span><span class="p">.</span><span class="nx">write</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">names</span><span class="o">:</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
      <span class="nx">cellpadding</span><span class="o">:</span> <span class="s1">&#39;cellPadding&#39;</span><span class="p">,</span>
      <span class="nx">cellspacing</span><span class="o">:</span> <span class="s1">&#39;cellSpacing&#39;</span>
    <span class="p">},</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">_attributeTranslations</span><span class="p">.</span><span class="nx">read</span><span class="p">.</span><span class="nx">names</span><span class="p">),</span>
    <span class="nx">values</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">checked</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">checked</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">value</span><span class="p">;</span>
      <span class="p">},</span>

      <span class="nx">style</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">cssText</span> <span class="o">=</span> <span class="nx">value</span> <span class="o">?</span> <span class="nx">value</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nx">Element</span><span class="p">.</span><span class="nx">_attributeTranslations</span><span class="p">.</span><span class="nx">has</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="nx">$w</span><span class="p">(</span><span class="s1">&#39;colSpan rowSpan vAlign dateTime accessKey tabIndex &#39;</span> <span class="o">+</span>
      <span class="s1">&#39;encType maxLength readOnly longDesc frameBorder&#39;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">attr</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Element</span><span class="p">.</span><span class="nx">_attributeTranslations</span><span class="p">.</span><span class="nx">write</span><span class="p">.</span><span class="nx">names</span><span class="p">[</span><span class="nx">attr</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()]</span> <span class="o">=</span> <span class="nx">attr</span><span class="p">;</span>
    <span class="nx">Element</span><span class="p">.</span><span class="nx">_attributeTranslations</span><span class="p">.</span><span class="nx">has</span><span class="p">[</span><span class="nx">attr</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()]</span> <span class="o">=</span> <span class="nx">attr</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">href</span><span class="o">:</span>        <span class="nx">v</span><span class="p">.</span><span class="nx">_getAttr2</span><span class="p">,</span>
      <span class="nx">src</span><span class="o">:</span>         <span class="nx">v</span><span class="p">.</span><span class="nx">_getAttr2</span><span class="p">,</span>
      <span class="nx">type</span><span class="o">:</span>        <span class="nx">v</span><span class="p">.</span><span class="nx">_getAttr</span><span class="p">,</span>
      <span class="nx">action</span><span class="o">:</span>      <span class="nx">v</span><span class="p">.</span><span class="nx">_getAttrNode</span><span class="p">,</span>
      <span class="nx">disabled</span><span class="o">:</span>    <span class="nx">v</span><span class="p">.</span><span class="nx">_flag</span><span class="p">,</span>
      <span class="nx">checked</span><span class="o">:</span>     <span class="nx">v</span><span class="p">.</span><span class="nx">_flag</span><span class="p">,</span>
      <span class="nx">readonly</span><span class="o">:</span>    <span class="nx">v</span><span class="p">.</span><span class="nx">_flag</span><span class="p">,</span>
      <span class="nx">multiple</span><span class="o">:</span>    <span class="nx">v</span><span class="p">.</span><span class="nx">_flag</span><span class="p">,</span>
      <span class="nx">onload</span><span class="o">:</span>      <span class="nx">v</span><span class="p">.</span><span class="nx">_getEv</span><span class="p">,</span>
      <span class="nx">onunload</span><span class="o">:</span>    <span class="nx">v</span><span class="p">.</span><span class="nx">_getEv</span><span class="p">,</span>
      <span class="nx">onclick</span><span class="o">:</span>     <span class="nx">v</span><span class="p">.</span><span class="nx">_getEv</span><span class="p">,</span>
      <span class="nx">ondblclick</span><span class="o">:</span>  <span class="nx">v</span><span class="p">.</span><span class="nx">_getEv</span><span class="p">,</span>
      <span class="nx">onmousedown</span><span class="o">:</span> <span class="nx">v</span><span class="p">.</span><span class="nx">_getEv</span><span class="p">,</span>
      <span class="nx">onmouseup</span><span class="o">:</span>   <span class="nx">v</span><span class="p">.</span><span class="nx">_getEv</span><span class="p">,</span>
      <span class="nx">onmouseover</span><span class="o">:</span> <span class="nx">v</span><span class="p">.</span><span class="nx">_getEv</span><span class="p">,</span>
      <span class="nx">onmousemove</span><span class="o">:</span> <span class="nx">v</span><span class="p">.</span><span class="nx">_getEv</span><span class="p">,</span>
      <span class="nx">onmouseout</span><span class="o">:</span>  <span class="nx">v</span><span class="p">.</span><span class="nx">_getEv</span><span class="p">,</span>
      <span class="nx">onfocus</span><span class="o">:</span>     <span class="nx">v</span><span class="p">.</span><span class="nx">_getEv</span><span class="p">,</span>
      <span class="nx">onblur</span><span class="o">:</span>      <span class="nx">v</span><span class="p">.</span><span class="nx">_getEv</span><span class="p">,</span>
      <span class="nx">onkeypress</span><span class="o">:</span>  <span class="nx">v</span><span class="p">.</span><span class="nx">_getEv</span><span class="p">,</span>
      <span class="nx">onkeydown</span><span class="o">:</span>   <span class="nx">v</span><span class="p">.</span><span class="nx">_getEv</span><span class="p">,</span>
      <span class="nx">onkeyup</span><span class="o">:</span>     <span class="nx">v</span><span class="p">.</span><span class="nx">_getEv</span><span class="p">,</span>
      <span class="nx">onsubmit</span><span class="o">:</span>    <span class="nx">v</span><span class="p">.</span><span class="nx">_getEv</span><span class="p">,</span>
      <span class="nx">onreset</span><span class="o">:</span>     <span class="nx">v</span><span class="p">.</span><span class="nx">_getEv</span><span class="p">,</span>
      <span class="nx">onselect</span><span class="o">:</span>    <span class="nx">v</span><span class="p">.</span><span class="nx">_getEv</span><span class="p">,</span>
      <span class="nx">onchange</span><span class="o">:</span>    <span class="nx">v</span><span class="p">.</span><span class="nx">_getEv</span>
    <span class="p">});</span>
  <span class="p">})(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">_attributeTranslations</span><span class="p">.</span><span class="nx">read</span><span class="p">.</span><span class="nx">values</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">Prototype</span><span class="p">.</span><span class="nx">BrowserFeatures</span><span class="p">.</span><span class="nx">ElementExtensions</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">function</span> <span class="nx">_descendants</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">nodes</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">),</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">node</span><span class="p">;</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">tagName</span> <span class="o">!==</span> <span class="s2">&quot;!&quot;</span><span class="p">)</span> <span class="c1">// Filter out comment nodes.</span>
            <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">down</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">expression</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="nx">element</span><span class="p">.</span><span class="nx">firstDescendant</span><span class="p">();</span>
        <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">isNumber</span><span class="p">(</span><span class="nx">expression</span><span class="p">)</span> <span class="o">?</span> <span class="nx">_descendants</span><span class="p">(</span><span class="nx">element</span><span class="p">)[</span><span class="nx">expression</span><span class="p">]</span> <span class="o">:</span>
          <span class="nx">Element</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">expression</span><span class="p">)[</span><span class="nx">index</span> <span class="o">||</span> <span class="mi">0</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">})();</span>
  <span class="p">}</span>

<span class="p">}</span>

<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">Prototype</span><span class="p">.</span><span class="nx">Browser</span><span class="p">.</span><span class="nx">Gecko</span> <span class="o">&amp;&amp;</span> <span class="sr">/rv:1\.8\.0/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">))</span> <span class="p">{</span>
  <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">setOpacity</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mf">0.999999</span> <span class="o">:</span>
      <span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span> <span class="o">:</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&lt;</span> <span class="mf">0.00001</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">value</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">Prototype</span><span class="p">.</span><span class="nx">Browser</span><span class="p">.</span><span class="nx">WebKit</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">setOpacity</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span> <span class="o">:</span>
      <span class="p">(</span><span class="nx">value</span> <span class="o">&lt;</span> <span class="mf">0.00001</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">value</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;IMG&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">element</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">width</span><span class="o">++</span><span class="p">;</span> <span class="nx">element</span><span class="p">.</span><span class="nx">width</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">try</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;outerHTML&#39;</span> <span class="k">in</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">replace</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">content</span> <span class="o">&amp;&amp;</span> <span class="nx">content</span><span class="p">.</span><span class="nx">toElement</span><span class="p">)</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">content</span><span class="p">.</span><span class="nx">toElement</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isElement</span><span class="p">(</span><span class="nx">content</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">replaceChild</span><span class="p">(</span><span class="nx">content</span><span class="p">,</span> <span class="nx">element</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">content</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">toHTML</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="nx">tagName</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">_insertionTranslations</span><span class="p">.</span><span class="nx">tags</span><span class="p">[</span><span class="nx">tagName</span><span class="p">])</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">nextSibling</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">next</span><span class="p">(),</span>
          <span class="nx">fragments</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">_getContentFromAnonymousElement</span><span class="p">(</span><span class="nx">tagName</span><span class="p">,</span> <span class="nx">content</span><span class="p">.</span><span class="nx">stripScripts</span><span class="p">());</span>
      <span class="nx">parent</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">nextSibling</span><span class="p">)</span>
        <span class="nx">fragments</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">nextSibling</span><span class="p">)</span> <span class="p">});</span>
      <span class="k">else</span>
        <span class="nx">fragments</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="nx">element</span><span class="p">.</span><span class="nx">outerHTML</span> <span class="o">=</span> <span class="nx">content</span><span class="p">.</span><span class="nx">stripScripts</span><span class="p">();</span>

    <span class="nx">content</span><span class="p">.</span><span class="nx">evalScripts</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">content</span><span class="p">).</span><span class="nx">defer</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="nx">Element</span><span class="p">.</span><span class="nx">_returnOffset</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">l</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[</span><span class="nx">l</span><span class="p">,</span> <span class="nx">t</span><span class="p">];</span>
  <span class="nx">result</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="nx">l</span><span class="p">;</span>
  <span class="nx">result</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">Element</span><span class="p">.</span><span class="nx">_getContentFromAnonymousElement</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tagName</span><span class="p">,</span> <span class="nx">html</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">),</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">_insertionTranslations</span><span class="p">.</span><span class="nx">tags</span><span class="p">[</span><span class="nx">tagName</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">div</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">html</span> <span class="o">+</span> <span class="nx">t</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">t</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="nx">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">div</span> <span class="o">=</span> <span class="nx">div</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">div</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">html</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">$A</span><span class="p">(</span><span class="nx">div</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">Element</span><span class="p">.</span><span class="nx">_insertionTranslations</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">before</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">element</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">top</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">element</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">bottom</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">after</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">element</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">tags</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">TABLE</span><span class="o">:</span>  <span class="p">[</span><span class="s1">&#39;&lt;table&gt;&#39;</span><span class="p">,</span>                <span class="s1">&#39;&lt;/table&gt;&#39;</span><span class="p">,</span>                   <span class="mi">1</span><span class="p">],</span>
    <span class="nx">TBODY</span><span class="o">:</span>  <span class="p">[</span><span class="s1">&#39;&lt;table&gt;&lt;tbody&gt;&#39;</span><span class="p">,</span>         <span class="s1">&#39;&lt;/tbody&gt;&lt;/table&gt;&#39;</span><span class="p">,</span>           <span class="mi">2</span><span class="p">],</span>
    <span class="nx">TR</span><span class="o">:</span>     <span class="p">[</span><span class="s1">&#39;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&#39;</span><span class="p">,</span>     <span class="s1">&#39;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&#39;</span><span class="p">,</span>      <span class="mi">3</span><span class="p">],</span>
    <span class="nx">TD</span><span class="o">:</span>     <span class="p">[</span><span class="s1">&#39;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
    <span class="nx">SELECT</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;&lt;select&gt;&#39;</span><span class="p">,</span>               <span class="s1">&#39;&lt;/select&gt;&#39;</span><span class="p">,</span>                  <span class="mi">1</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">tags</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">_insertionTranslations</span><span class="p">.</span><span class="nx">tags</span><span class="p">;</span>
  <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">tags</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">THEAD</span><span class="o">:</span> <span class="nx">tags</span><span class="p">.</span><span class="nx">TBODY</span><span class="p">,</span>
    <span class="nx">TFOOT</span><span class="o">:</span> <span class="nx">tags</span><span class="p">.</span><span class="nx">TBODY</span><span class="p">,</span>
    <span class="nx">TH</span><span class="o">:</span>    <span class="nx">tags</span><span class="p">.</span><span class="nx">TD</span>
  <span class="p">});</span>
<span class="p">})();</span>

<span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">Simulated</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">hasAttribute</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">attribute</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">_attributeTranslations</span><span class="p">.</span><span class="nx">has</span><span class="p">[</span><span class="nx">attribute</span><span class="p">]</span> <span class="o">||</span> <span class="nx">attribute</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">getAttributeNode</span><span class="p">(</span><span class="nx">attribute</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">!!</span><span class="p">(</span><span class="nx">node</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">specified</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">ByTag</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>

<span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Element</span><span class="p">,</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">);</span>

<span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">div</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Prototype</span><span class="p">.</span><span class="nx">BrowserFeatures</span><span class="p">.</span><span class="nx">ElementExtensions</span> <span class="o">&amp;&amp;</span> <span class="nx">div</span><span class="p">[</span><span class="s1">&#39;__proto__&#39;</span><span class="p">])</span> <span class="p">{</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">HTMLElement</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">HTMLElement</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">div</span><span class="p">[</span><span class="s1">&#39;__proto__&#39;</span><span class="p">];</span>
    <span class="nx">Prototype</span><span class="p">.</span><span class="nx">BrowserFeatures</span><span class="p">.</span><span class="nx">ElementExtensions</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">div</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

<span class="p">})(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">));</span>

<span class="nx">Element</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="kd">function</span> <span class="nx">checkDeficiency</span><span class="p">(</span><span class="nx">tagName</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Element</span> <span class="o">!=</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">proto</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">proto</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
            <span class="nx">el</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">tagName</span><span class="p">);</span>
        <span class="nx">proto</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">isBuggy</span> <span class="o">=</span> <span class="p">(</span><span class="nx">el</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;x&#39;</span><span class="p">);</span>
        <span class="k">delete</span> <span class="nx">proto</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
        <span class="nx">el</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">isBuggy</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">extendElementWith</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">methods</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">property</span> <span class="k">in</span> <span class="nx">methods</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">methods</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">property</span> <span class="k">in</span> <span class="nx">element</span><span class="p">))</span>
        <span class="nx">element</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">methodize</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">HTMLOBJECTELEMENT_PROTOTYPE_BUGGY</span> <span class="o">=</span> <span class="nx">checkDeficiency</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">Prototype</span><span class="p">.</span><span class="nx">BrowserFeatures</span><span class="p">.</span><span class="nx">SpecificElementExtensions</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">HTMLOBJECTELEMENT_PROTOTYPE_BUGGY</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">element</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">element</span><span class="p">.</span><span class="nx">_extendedByPrototype</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">tagName</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">t</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="sr">/^(?:object|applet|embed)$/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">t</span><span class="p">)))</span> <span class="p">{</span>
            <span class="nx">extendElementWith</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">);</span>
            <span class="nx">extendElementWith</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">Simulated</span><span class="p">);</span>
            <span class="nx">extendElementWith</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">ByTag</span><span class="p">[</span><span class="nx">t</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()]);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">K</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">Methods</span> <span class="o">=</span> <span class="p">{</span> <span class="p">},</span> <span class="nx">ByTag</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">ByTag</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">extend</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">element</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">element</span><span class="p">.</span><span class="nx">_extendedByPrototype</span> <span class="o">!=</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">||</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">element</span> <span class="o">==</span> <span class="nb">window</span><span class="p">)</span> <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">methods</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">Methods</span><span class="p">),</span>
        <span class="nx">tagName</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">ByTag</span><span class="p">[</span><span class="nx">tagName</span><span class="p">])</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">methods</span><span class="p">,</span> <span class="nx">ByTag</span><span class="p">[</span><span class="nx">tagName</span><span class="p">]);</span>

    <span class="nx">extendElementWith</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">methods</span><span class="p">);</span>

    <span class="nx">element</span><span class="p">.</span><span class="nx">_extendedByPrototype</span> <span class="o">=</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">emptyFunction</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>

  <span class="p">},</span> <span class="p">{</span>
    <span class="nx">refresh</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Prototype</span><span class="p">.</span><span class="nx">BrowserFeatures</span><span class="p">.</span><span class="nx">ElementExtensions</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Methods</span><span class="p">,</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">);</span>
        <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Methods</span><span class="p">,</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">Simulated</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="nx">extend</span><span class="p">.</span><span class="nx">refresh</span><span class="p">();</span>
  <span class="k">return</span> <span class="nx">extend</span><span class="p">;</span>
<span class="p">})();</span>

<span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">hasAttribute</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Element</span><span class="p">.</span><span class="nx">hasAttribute</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">.</span><span class="nx">hasAttribute</span><span class="p">(</span><span class="nx">attribute</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
  <span class="nx">Element</span><span class="p">.</span><span class="nx">hasAttribute</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">Simulated</span><span class="p">.</span><span class="nx">hasAttribute</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">Element</span><span class="p">.</span><span class="nx">addMethods</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">methods</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">F</span> <span class="o">=</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">BrowserFeatures</span><span class="p">,</span> <span class="nx">T</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">ByTag</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">methods</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Form</span><span class="p">,</span> <span class="nx">Form</span><span class="p">.</span><span class="nx">Methods</span><span class="p">);</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Form</span><span class="p">.</span><span class="nx">Element</span><span class="p">,</span> <span class="nx">Form</span><span class="p">.</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">);</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">ByTag</span><span class="p">,</span> <span class="p">{</span>
      <span class="s2">&quot;FORM&quot;</span><span class="o">:</span>     <span class="nb">Object</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">Form</span><span class="p">.</span><span class="nx">Methods</span><span class="p">),</span>
      <span class="s2">&quot;INPUT&quot;</span><span class="o">:</span>    <span class="nb">Object</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">Form</span><span class="p">.</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">),</span>
      <span class="s2">&quot;SELECT&quot;</span><span class="o">:</span>   <span class="nb">Object</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">Form</span><span class="p">.</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">),</span>
      <span class="s2">&quot;TEXTAREA&quot;</span><span class="o">:</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">Form</span><span class="p">.</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">)</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tagName</span> <span class="o">=</span> <span class="nx">methods</span><span class="p">;</span>
    <span class="nx">methods</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">tagName</span><span class="p">)</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">,</span> <span class="nx">methods</span> <span class="o">||</span> <span class="p">{</span> <span class="p">});</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">tagName</span><span class="p">))</span> <span class="nx">tagName</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">extend</span><span class="p">);</span>
    <span class="k">else</span> <span class="nx">extend</span><span class="p">(</span><span class="nx">tagName</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">extend</span><span class="p">(</span><span class="nx">tagName</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">tagName</span> <span class="o">=</span> <span class="nx">tagName</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">ByTag</span><span class="p">[</span><span class="nx">tagName</span><span class="p">])</span>
      <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">ByTag</span><span class="p">[</span><span class="nx">tagName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">ByTag</span><span class="p">[</span><span class="nx">tagName</span><span class="p">],</span> <span class="nx">methods</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">copy</span><span class="p">(</span><span class="nx">methods</span><span class="p">,</span> <span class="nx">destination</span><span class="p">,</span> <span class="nx">onlyIfAbsent</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">onlyIfAbsent</span> <span class="o">=</span> <span class="nx">onlyIfAbsent</span> <span class="o">||</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">property</span> <span class="k">in</span> <span class="nx">methods</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">methods</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">onlyIfAbsent</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="nx">property</span> <span class="k">in</span> <span class="nx">destination</span><span class="p">))</span>
        <span class="nx">destination</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">methodize</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">findDOMClass</span><span class="p">(</span><span class="nx">tagName</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">klass</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">trans</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s2">&quot;OPTGROUP&quot;</span><span class="o">:</span> <span class="s2">&quot;OptGroup&quot;</span><span class="p">,</span> <span class="s2">&quot;TEXTAREA&quot;</span><span class="o">:</span> <span class="s2">&quot;TextArea&quot;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="o">:</span> <span class="s2">&quot;Paragraph&quot;</span><span class="p">,</span>
      <span class="s2">&quot;FIELDSET&quot;</span><span class="o">:</span> <span class="s2">&quot;FieldSet&quot;</span><span class="p">,</span> <span class="s2">&quot;UL&quot;</span><span class="o">:</span> <span class="s2">&quot;UList&quot;</span><span class="p">,</span> <span class="s2">&quot;OL&quot;</span><span class="o">:</span> <span class="s2">&quot;OList&quot;</span><span class="p">,</span> <span class="s2">&quot;DL&quot;</span><span class="o">:</span> <span class="s2">&quot;DList&quot;</span><span class="p">,</span>
      <span class="s2">&quot;DIR&quot;</span><span class="o">:</span> <span class="s2">&quot;Directory&quot;</span><span class="p">,</span> <span class="s2">&quot;H1&quot;</span><span class="o">:</span> <span class="s2">&quot;Heading&quot;</span><span class="p">,</span> <span class="s2">&quot;H2&quot;</span><span class="o">:</span> <span class="s2">&quot;Heading&quot;</span><span class="p">,</span> <span class="s2">&quot;H3&quot;</span><span class="o">:</span> <span class="s2">&quot;Heading&quot;</span><span class="p">,</span>
      <span class="s2">&quot;H4&quot;</span><span class="o">:</span> <span class="s2">&quot;Heading&quot;</span><span class="p">,</span> <span class="s2">&quot;H5&quot;</span><span class="o">:</span> <span class="s2">&quot;Heading&quot;</span><span class="p">,</span> <span class="s2">&quot;H6&quot;</span><span class="o">:</span> <span class="s2">&quot;Heading&quot;</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="o">:</span> <span class="s2">&quot;Quote&quot;</span><span class="p">,</span>
      <span class="s2">&quot;INS&quot;</span><span class="o">:</span> <span class="s2">&quot;Mod&quot;</span><span class="p">,</span> <span class="s2">&quot;DEL&quot;</span><span class="o">:</span> <span class="s2">&quot;Mod&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="o">:</span> <span class="s2">&quot;Anchor&quot;</span><span class="p">,</span> <span class="s2">&quot;IMG&quot;</span><span class="o">:</span> <span class="s2">&quot;Image&quot;</span><span class="p">,</span> <span class="s2">&quot;CAPTION&quot;</span><span class="o">:</span>
      <span class="s2">&quot;TableCaption&quot;</span><span class="p">,</span> <span class="s2">&quot;COL&quot;</span><span class="o">:</span> <span class="s2">&quot;TableCol&quot;</span><span class="p">,</span> <span class="s2">&quot;COLGROUP&quot;</span><span class="o">:</span> <span class="s2">&quot;TableCol&quot;</span><span class="p">,</span> <span class="s2">&quot;THEAD&quot;</span><span class="o">:</span>
      <span class="s2">&quot;TableSection&quot;</span><span class="p">,</span> <span class="s2">&quot;TFOOT&quot;</span><span class="o">:</span> <span class="s2">&quot;TableSection&quot;</span><span class="p">,</span> <span class="s2">&quot;TBODY&quot;</span><span class="o">:</span> <span class="s2">&quot;TableSection&quot;</span><span class="p">,</span> <span class="s2">&quot;TR&quot;</span><span class="o">:</span>
      <span class="s2">&quot;TableRow&quot;</span><span class="p">,</span> <span class="s2">&quot;TH&quot;</span><span class="o">:</span> <span class="s2">&quot;TableCell&quot;</span><span class="p">,</span> <span class="s2">&quot;TD&quot;</span><span class="o">:</span> <span class="s2">&quot;TableCell&quot;</span><span class="p">,</span> <span class="s2">&quot;FRAMESET&quot;</span><span class="o">:</span>
      <span class="s2">&quot;FrameSet&quot;</span><span class="p">,</span> <span class="s2">&quot;IFRAME&quot;</span><span class="o">:</span> <span class="s2">&quot;IFrame&quot;</span>
    <span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">trans</span><span class="p">[</span><span class="nx">tagName</span><span class="p">])</span> <span class="nx">klass</span> <span class="o">=</span> <span class="s1">&#39;HTML&#39;</span> <span class="o">+</span> <span class="nx">trans</span><span class="p">[</span><span class="nx">tagName</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;Element&#39;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">[</span><span class="nx">klass</span><span class="p">])</span> <span class="k">return</span> <span class="nb">window</span><span class="p">[</span><span class="nx">klass</span><span class="p">];</span>
    <span class="nx">klass</span> <span class="o">=</span> <span class="s1">&#39;HTML&#39;</span> <span class="o">+</span> <span class="nx">tagName</span> <span class="o">+</span> <span class="s1">&#39;Element&#39;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">[</span><span class="nx">klass</span><span class="p">])</span> <span class="k">return</span> <span class="nb">window</span><span class="p">[</span><span class="nx">klass</span><span class="p">];</span>
    <span class="nx">klass</span> <span class="o">=</span> <span class="s1">&#39;HTML&#39;</span> <span class="o">+</span> <span class="nx">tagName</span><span class="p">.</span><span class="nx">capitalize</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;Element&#39;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">[</span><span class="nx">klass</span><span class="p">])</span> <span class="k">return</span> <span class="nb">window</span><span class="p">[</span><span class="nx">klass</span><span class="p">];</span>

    <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">tagName</span><span class="p">),</span>
        <span class="nx">proto</span> <span class="o">=</span> <span class="nx">element</span><span class="p">[</span><span class="s1">&#39;__proto__&#39;</span><span class="p">]</span> <span class="o">||</span> <span class="nx">element</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>

    <span class="nx">element</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">proto</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">elementPrototype</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">HTMLElement</span> <span class="o">?</span> <span class="nx">HTMLElement</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">:</span>
   <span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">F</span><span class="p">.</span><span class="nx">ElementExtensions</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">copy</span><span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">,</span> <span class="nx">elementPrototype</span><span class="p">);</span>
    <span class="nx">copy</span><span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">Simulated</span><span class="p">,</span> <span class="nx">elementPrototype</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">F</span><span class="p">.</span><span class="nx">SpecificElementExtensions</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">tag</span> <span class="k">in</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">ByTag</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">klass</span> <span class="o">=</span> <span class="nx">findDOMClass</span><span class="p">(</span><span class="nx">tag</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">klass</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
      <span class="nx">copy</span><span class="p">(</span><span class="nx">T</span><span class="p">[</span><span class="nx">tag</span><span class="p">],</span> <span class="nx">klass</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Element</span><span class="p">,</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">);</span>
  <span class="k">delete</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">ByTag</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">extend</span><span class="p">.</span><span class="nx">refresh</span><span class="p">)</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">extend</span><span class="p">.</span><span class="nx">refresh</span><span class="p">();</span>
  <span class="nx">Element</span><span class="p">.</span><span class="nx">cache</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
<span class="p">};</span>


<span class="nb">document</span><span class="p">.</span><span class="nx">viewport</span> <span class="o">=</span> <span class="p">{</span>

  <span class="nx">getDimensions</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span> <span class="nx">width</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">(),</span> <span class="nx">height</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">()</span> <span class="p">};</span>
  <span class="p">},</span>

  <span class="nx">getScrollOffsets</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">_returnOffset</span><span class="p">(</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">pageXOffset</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">scrollLeft</span><span class="p">,</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">pageYOffset</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">scrollTop</span>  <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">viewport</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">B</span> <span class="o">=</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">Browser</span><span class="p">,</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nb">document</span><span class="p">,</span> <span class="nx">element</span><span class="p">,</span> <span class="nx">property</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="kd">function</span> <span class="nx">getRootElement</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">B</span><span class="p">.</span><span class="nx">WebKit</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">)</span>
      <span class="k">return</span> <span class="nb">document</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">B</span><span class="p">.</span><span class="nx">Opera</span> <span class="o">&amp;&amp;</span> <span class="nb">window</span><span class="p">.</span><span class="nb">parseFloat</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">opera</span><span class="p">.</span><span class="nx">version</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mf">9.5</span><span class="p">)</span>
      <span class="k">return</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>

    <span class="k">return</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">define</span><span class="p">(</span><span class="nx">D</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">element</span><span class="p">)</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">getRootElement</span><span class="p">();</span>

    <span class="nx">property</span><span class="p">[</span><span class="nx">D</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;client&#39;</span> <span class="o">+</span> <span class="nx">D</span><span class="p">;</span>

    <span class="nx">viewport</span><span class="p">[</span><span class="s1">&#39;get&#39;</span> <span class="o">+</span> <span class="nx">D</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">element</span><span class="p">[</span><span class="nx">property</span><span class="p">[</span><span class="nx">D</span><span class="p">]]</span> <span class="p">};</span>
    <span class="k">return</span> <span class="nx">viewport</span><span class="p">[</span><span class="s1">&#39;get&#39;</span> <span class="o">+</span> <span class="nx">D</span><span class="p">]();</span>
  <span class="p">}</span>

  <span class="nx">viewport</span><span class="p">.</span><span class="nx">getWidth</span>  <span class="o">=</span> <span class="nx">define</span><span class="p">.</span><span class="nx">curry</span><span class="p">(</span><span class="s1">&#39;Width&#39;</span><span class="p">);</span>

  <span class="nx">viewport</span><span class="p">.</span><span class="nx">getHeight</span> <span class="o">=</span> <span class="nx">define</span><span class="p">.</span><span class="nx">curry</span><span class="p">(</span><span class="s1">&#39;Height&#39;</span><span class="p">);</span>
<span class="p">})(</span><span class="nb">document</span><span class="p">.</span><span class="nx">viewport</span><span class="p">);</span>


<span class="nx">Element</span><span class="p">.</span><span class="nx">Storage</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">UID</span><span class="o">:</span> <span class="mi">1</span>
<span class="p">};</span>

<span class="nx">Element</span><span class="p">.</span><span class="nx">addMethods</span><span class="p">({</span>
  <span class="nx">getStorage</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">)))</span> <span class="k">return</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">uid</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">element</span> <span class="o">===</span> <span class="nb">window</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">uid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">element</span><span class="p">.</span><span class="nx">_prototypeUID</span> <span class="o">===</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">_prototypeUID</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Storage</span><span class="p">.</span><span class="nx">UID</span><span class="o">++</span><span class="p">;</span>
      <span class="nx">uid</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">_prototypeUID</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Storage</span><span class="p">[</span><span class="nx">uid</span><span class="p">])</span>
      <span class="nx">Element</span><span class="p">.</span><span class="nx">Storage</span><span class="p">[</span><span class="nx">uid</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$H</span><span class="p">();</span>

    <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Storage</span><span class="p">[</span><span class="nx">uid</span><span class="p">];</span>
  <span class="p">},</span>

  <span class="nx">store</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">)))</span> <span class="k">return</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">Element</span><span class="p">.</span><span class="nx">getStorage</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">Element</span><span class="p">.</span><span class="nx">getStorage</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">retrieve</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">defaultValue</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">)))</span> <span class="k">return</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">hash</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">getStorage</span><span class="p">(</span><span class="nx">element</span><span class="p">),</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">hash</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">hash</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">defaultValue</span><span class="p">);</span>
      <span class="nx">value</span> <span class="o">=</span> <span class="nx">defaultValue</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">clone</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">deep</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">)))</span> <span class="k">return</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">clone</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">cloneNode</span><span class="p">(</span><span class="nx">deep</span><span class="p">);</span>
    <span class="nx">clone</span><span class="p">.</span><span class="nx">_prototypeUID</span> <span class="o">=</span> <span class="k">void</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">deep</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">descendants</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">clone</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">),</span>
          <span class="nx">i</span> <span class="o">=</span> <span class="nx">descendants</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">descendants</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_prototypeUID</span> <span class="o">=</span> <span class="k">void</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">clone</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">purge</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">)))</span> <span class="k">return</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">purgeElement</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">_purgeElement</span><span class="p">;</span>

    <span class="nx">purgeElement</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">descendants</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">),</span>
     <span class="nx">i</span> <span class="o">=</span> <span class="nx">descendants</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="nx">purgeElement</span><span class="p">(</span><span class="nx">descendants</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>

    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="kd">function</span> <span class="nx">toDecimal</span><span class="p">(</span><span class="nx">pctString</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="nx">pctString</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^(\d+)%?$/i</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">match</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">getPixelValue</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isElement</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">element</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="nx">value</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="nx">property</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">((</span><span class="sr">/^(?:-)?\d+(\.\d+)?(px)?$/i</span><span class="p">).</span><span class="nx">test</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">isPercentage</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">),</span> <span class="nx">isViewport</span> <span class="o">=</span> <span class="p">(</span><span class="nx">context</span> <span class="o">===</span> <span class="nb">document</span><span class="p">.</span><span class="nx">viewport</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="sr">/\d/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">element</span> <span class="o">&amp;&amp;</span> <span class="nx">element</span><span class="p">.</span><span class="nx">runtimeStyle</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">isPercentage</span> <span class="o">&amp;&amp;</span> <span class="nx">isViewport</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">style</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span> <span class="nx">rStyle</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">runtimeStyle</span><span class="p">.</span><span class="nx">left</span><span class="p">;</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">runtimeStyle</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">currentStyle</span><span class="p">.</span><span class="nx">left</span><span class="p">;</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="nx">value</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">value</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">pixelLeft</span><span class="p">;</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="nx">style</span><span class="p">;</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">runtimeStyle</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="nx">rStyle</span><span class="p">;</span>

      <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">element</span> <span class="o">&amp;&amp;</span> <span class="nx">isPercentage</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">context</span> <span class="o">=</span> <span class="nx">context</span> <span class="o">||</span> <span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">decimal</span> <span class="o">=</span> <span class="nx">toDecimal</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">whole</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">position</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">isHorizontal</span> <span class="o">=</span> <span class="nx">property</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">property</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span> <span class="o">||</span>
       <span class="nx">property</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">isVertical</span> <span class="o">=</span>  <span class="nx">property</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">property</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span> <span class="o">||</span>
        <span class="nx">property</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">context</span> <span class="o">===</span> <span class="nb">document</span><span class="p">.</span><span class="nx">viewport</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">isHorizontal</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">whole</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">viewport</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isVertical</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">whole</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">viewport</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">isHorizontal</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">whole</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">context</span><span class="p">).</span><span class="nx">measure</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isVertical</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">whole</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">context</span><span class="p">).</span><span class="nx">measure</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="p">(</span><span class="nx">whole</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">whole</span> <span class="o">*</span> <span class="nx">decimal</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">toCSSPixels</span><span class="p">(</span><span class="nx">number</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">number</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">number</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;px&#39;</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">number</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">number</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">isDisplayed</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">originalElement</span> <span class="o">=</span> <span class="nx">element</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">element</span> <span class="o">&amp;&amp;</span> <span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">display</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="s1">&#39;display&#39;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">display</span> <span class="o">===</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">hasLayout</span> <span class="o">=</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">K</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;currentStyle&#39;</span> <span class="k">in</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">hasLayout</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">element</span><span class="p">.</span><span class="nx">currentStyle</span><span class="p">.</span><span class="nx">hasLayout</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">zoom</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">cssNameFor</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">key</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="s1">&#39;border&#39;</span><span class="p">))</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">key</span> <span class="o">+</span> <span class="s1">&#39;-width&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">key</span><span class="p">.</span><span class="nx">camelize</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">Element</span><span class="p">.</span><span class="nx">Layout</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">Hash</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$super</span><span class="p">,</span> <span class="nx">element</span><span class="p">,</span> <span class="nx">preCompute</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$super</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>

      <span class="nx">Element</span><span class="p">.</span><span class="nx">Layout</span><span class="p">.</span><span class="nx">PROPERTIES</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_set</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="p">},</span> <span class="k">this</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">preCompute</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_preComputing</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_begin</span><span class="p">();</span>
        <span class="nx">Element</span><span class="p">.</span><span class="nx">Layout</span><span class="p">.</span><span class="nx">PROPERTIES</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_compute</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_end</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_preComputing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">},</span>

    <span class="nx">_set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">Hash</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="s2">&quot;Properties of Element.Layout are read-only.&quot;</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$super</span><span class="p">,</span> <span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">$super</span><span class="p">(</span><span class="nx">property</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">value</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">_compute</span><span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="o">:</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">_begin</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_prepared</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isDisplayed</span><span class="p">(</span><span class="nx">element</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_prepared</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">originalStyles</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">position</span><span class="o">:</span>   <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">position</span>   <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="nx">width</span><span class="o">:</span>      <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span>      <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="nx">visibility</span><span class="o">:</span> <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">visibility</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="nx">display</span><span class="o">:</span>    <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span>    <span class="o">||</span> <span class="s1">&#39;&#39;</span>
      <span class="p">};</span>

      <span class="nx">element</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="s1">&#39;prototype_original_styles&#39;</span><span class="p">,</span> <span class="nx">originalStyles</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">position</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">),</span>
       <span class="nx">width</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">context</span> <span class="o">=</span> <span class="p">(</span><span class="nx">position</span> <span class="o">===</span> <span class="s1">&#39;fixed&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nb">document</span><span class="p">.</span><span class="nx">viewport</span> <span class="o">:</span>
       <span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>

      <span class="nx">element</span><span class="p">.</span><span class="nx">setStyle</span><span class="p">({</span>
        <span class="nx">position</span><span class="o">:</span>   <span class="s1">&#39;absolute&#39;</span><span class="p">,</span>
        <span class="nx">visibility</span><span class="o">:</span> <span class="s1">&#39;hidden&#39;</span><span class="p">,</span>
        <span class="nx">display</span><span class="o">:</span>    <span class="s1">&#39;block&#39;</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">positionedWidth</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">newWidth</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">width</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">positionedWidth</span> <span class="o">===</span> <span class="nx">width</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">newWidth</span> <span class="o">=</span> <span class="nx">getPixelValue</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">position</span> <span class="o">===</span> <span class="s1">&#39;absolute&#39;</span> <span class="o">||</span> <span class="nx">position</span> <span class="o">===</span> <span class="s1">&#39;fixed&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">newWidth</span> <span class="o">=</span> <span class="nx">getPixelValue</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="nx">pLayout</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">parent</span><span class="p">).</span><span class="nx">getLayout</span><span class="p">();</span>

        <span class="nx">newWidth</span> <span class="o">=</span> <span class="nx">pLayout</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">)</span> <span class="o">-</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;margin-left&#39;</span><span class="p">)</span> <span class="o">-</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;border-left&#39;</span><span class="p">)</span> <span class="o">-</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;padding-left&#39;</span><span class="p">)</span> <span class="o">-</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;padding-right&#39;</span><span class="p">)</span> <span class="o">-</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;border-right&#39;</span><span class="p">)</span> <span class="o">-</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;margin-right&#39;</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">element</span><span class="p">.</span><span class="nx">setStyle</span><span class="p">({</span> <span class="nx">width</span><span class="o">:</span> <span class="nx">newWidth</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span> <span class="p">});</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">_prepared</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">_end</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">originalStyles</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">retrieve</span><span class="p">(</span><span class="s1">&#39;prototype_original_styles&#39;</span><span class="p">);</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="s1">&#39;prototype_original_styles&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">setStyle</span><span class="p">(</span><span class="nx">originalStyles</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_prepared</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">_compute</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">COMPUTATIONS</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Layout</span><span class="p">.</span><span class="nx">COMPUTATIONS</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">property</span> <span class="k">in</span> <span class="nx">COMPUTATIONS</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="s2">&quot;Property not found.&quot;</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_set</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span> <span class="nx">COMPUTATIONS</span><span class="p">[</span><span class="nx">property</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">));</span>
    <span class="p">},</span>

    <span class="nx">toObject</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">$A</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Layout</span><span class="p">.</span><span class="nx">PROPERTIES</span> <span class="o">:</span>
       <span class="nx">args</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="nx">keys</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Layout</span><span class="p">.</span><span class="nx">PROPERTIES</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">toHash</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">toObject</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Hash</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">toCSS</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">$A</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Layout</span><span class="p">.</span><span class="nx">PROPERTIES</span> <span class="o">:</span>
       <span class="nx">args</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">css</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="nx">keys</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Layout</span><span class="p">.</span><span class="nx">PROPERTIES</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Layout</span><span class="p">.</span><span class="nx">COMPOSITE_PROPERTIES</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">css</span><span class="p">[</span><span class="nx">cssNameFor</span><span class="p">(</span><span class="nx">key</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">value</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">;</span>
      <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">css</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">inspect</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">&quot;#&lt;Element.Layout&gt;&quot;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Layout</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">PROPERTIES</span><span class="o">:</span> <span class="nx">$w</span><span class="p">(</span><span class="s1">&#39;height width top left right bottom border-left border-right border-top border-bottom padding-left padding-right padding-top padding-bottom margin-top margin-bottom margin-left margin-right padding-box-width padding-box-height border-box-width border-box-height margin-box-width margin-box-height&#39;</span><span class="p">),</span>

    <span class="nx">COMPOSITE_PROPERTIES</span><span class="o">:</span> <span class="nx">$w</span><span class="p">(</span><span class="s1">&#39;padding-box-width padding-box-height margin-box-width margin-box-height border-box-width border-box-height&#39;</span><span class="p">),</span>

    <span class="nx">COMPUTATIONS</span><span class="o">:</span> <span class="p">{</span>
      <span class="s1">&#39;height&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_preComputing</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">_begin</span><span class="p">();</span>

        <span class="kd">var</span> <span class="nx">bHeight</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;border-box-height&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">bHeight</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_preComputing</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">_end</span><span class="p">();</span>
          <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">bTop</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;border-top&#39;</span><span class="p">),</span>
         <span class="nx">bBottom</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;border-bottom&#39;</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">pTop</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;padding-top&#39;</span><span class="p">),</span>
         <span class="nx">pBottom</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;padding-bottom&#39;</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_preComputing</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">_end</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">bHeight</span> <span class="o">-</span> <span class="nx">bTop</span> <span class="o">-</span> <span class="nx">bBottom</span> <span class="o">-</span> <span class="nx">pTop</span> <span class="o">-</span> <span class="nx">pBottom</span><span class="p">;</span>
      <span class="p">},</span>

      <span class="s1">&#39;width&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_preComputing</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">_begin</span><span class="p">();</span>

        <span class="kd">var</span> <span class="nx">bWidth</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;border-box-width&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">bWidth</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_preComputing</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">_end</span><span class="p">();</span>
          <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">bLeft</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;border-left&#39;</span><span class="p">),</span>
         <span class="nx">bRight</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;border-right&#39;</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">pLeft</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;padding-left&#39;</span><span class="p">),</span>
         <span class="nx">pRight</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;padding-right&#39;</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_preComputing</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">_end</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">bWidth</span> <span class="o">-</span> <span class="nx">bLeft</span> <span class="o">-</span> <span class="nx">bRight</span> <span class="o">-</span> <span class="nx">pLeft</span> <span class="o">-</span> <span class="nx">pRight</span><span class="p">;</span>
      <span class="p">},</span>

      <span class="s1">&#39;padding-box-height&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">height</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">),</span>
         <span class="nx">pTop</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;padding-top&#39;</span><span class="p">),</span>
         <span class="nx">pBottom</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;padding-bottom&#39;</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">height</span> <span class="o">+</span> <span class="nx">pTop</span> <span class="o">+</span> <span class="nx">pBottom</span><span class="p">;</span>
      <span class="p">},</span>

      <span class="s1">&#39;padding-box-width&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">width</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">),</span>
         <span class="nx">pLeft</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;padding-left&#39;</span><span class="p">),</span>
         <span class="nx">pRight</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;padding-right&#39;</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">width</span> <span class="o">+</span> <span class="nx">pLeft</span> <span class="o">+</span> <span class="nx">pRight</span><span class="p">;</span>
      <span class="p">},</span>

      <span class="s1">&#39;border-box-height&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_preComputing</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">_begin</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">height</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_preComputing</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">_end</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">height</span><span class="p">;</span>
      <span class="p">},</span>

      <span class="s1">&#39;border-box-width&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_preComputing</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">_begin</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">width</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_preComputing</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">_end</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">width</span><span class="p">;</span>
      <span class="p">},</span>

      <span class="s1">&#39;margin-box-height&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">bHeight</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;border-box-height&#39;</span><span class="p">),</span>
         <span class="nx">mTop</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;margin-top&#39;</span><span class="p">),</span>
         <span class="nx">mBottom</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;margin-bottom&#39;</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">bHeight</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">return</span> <span class="nx">bHeight</span> <span class="o">+</span> <span class="nx">mTop</span> <span class="o">+</span> <span class="nx">mBottom</span><span class="p">;</span>
      <span class="p">},</span>

      <span class="s1">&#39;margin-box-width&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">bWidth</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;border-box-width&#39;</span><span class="p">),</span>
         <span class="nx">mLeft</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;margin-left&#39;</span><span class="p">),</span>
         <span class="nx">mRight</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;margin-right&#39;</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">bWidth</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">return</span> <span class="nx">bWidth</span> <span class="o">+</span> <span class="nx">mLeft</span> <span class="o">+</span> <span class="nx">mRight</span><span class="p">;</span>
      <span class="p">},</span>

      <span class="s1">&#39;top&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">offset</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">positionedOffset</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">offset</span><span class="p">.</span><span class="nx">top</span><span class="p">;</span>
      <span class="p">},</span>

      <span class="s1">&#39;bottom&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">offset</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">positionedOffset</span><span class="p">(),</span>
         <span class="nx">parent</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getOffsetParent</span><span class="p">(),</span>
         <span class="nx">pHeight</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">measure</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">mHeight</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;border-box-height&#39;</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">pHeight</span> <span class="o">-</span> <span class="nx">mHeight</span> <span class="o">-</span> <span class="nx">offset</span><span class="p">.</span><span class="nx">top</span><span class="p">;</span>
      <span class="p">},</span>

      <span class="s1">&#39;left&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">offset</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">positionedOffset</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">offset</span><span class="p">.</span><span class="nx">left</span><span class="p">;</span>
      <span class="p">},</span>

      <span class="s1">&#39;right&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">offset</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">positionedOffset</span><span class="p">(),</span>
         <span class="nx">parent</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getOffsetParent</span><span class="p">(),</span>
         <span class="nx">pWidth</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">measure</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">mWidth</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;border-box-width&#39;</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">pWidth</span> <span class="o">-</span> <span class="nx">mWidth</span> <span class="o">-</span> <span class="nx">offset</span><span class="p">.</span><span class="nx">left</span><span class="p">;</span>
      <span class="p">},</span>

      <span class="s1">&#39;padding-top&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">getPixelValue</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;paddingTop&#39;</span><span class="p">);</span>
      <span class="p">},</span>

      <span class="s1">&#39;padding-bottom&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">getPixelValue</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;paddingBottom&#39;</span><span class="p">);</span>
      <span class="p">},</span>

      <span class="s1">&#39;padding-left&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">getPixelValue</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;paddingLeft&#39;</span><span class="p">);</span>
      <span class="p">},</span>

      <span class="s1">&#39;padding-right&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">getPixelValue</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;paddingRight&#39;</span><span class="p">);</span>
      <span class="p">},</span>

      <span class="s1">&#39;border-top&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">getPixelValue</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;borderTopWidth&#39;</span><span class="p">);</span>
      <span class="p">},</span>

      <span class="s1">&#39;border-bottom&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">getPixelValue</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;borderBottomWidth&#39;</span><span class="p">);</span>
      <span class="p">},</span>

      <span class="s1">&#39;border-left&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">getPixelValue</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;borderLeftWidth&#39;</span><span class="p">);</span>
      <span class="p">},</span>

      <span class="s1">&#39;border-right&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">getPixelValue</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;borderRightWidth&#39;</span><span class="p">);</span>
      <span class="p">},</span>

      <span class="s1">&#39;margin-top&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">getPixelValue</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;marginTop&#39;</span><span class="p">);</span>
      <span class="p">},</span>

      <span class="s1">&#39;margin-bottom&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">getPixelValue</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;marginBottom&#39;</span><span class="p">);</span>
      <span class="p">},</span>

      <span class="s1">&#39;margin-left&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">getPixelValue</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;marginLeft&#39;</span><span class="p">);</span>
      <span class="p">},</span>

      <span class="s1">&#39;margin-right&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">getPixelValue</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;marginRight&#39;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;getBoundingClientRect&#39;</span> <span class="k">in</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Layout</span><span class="p">.</span><span class="nx">COMPUTATIONS</span><span class="p">,</span> <span class="p">{</span>
      <span class="s1">&#39;right&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">hasLayout</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">getOffsetParent</span><span class="p">());</span>
        <span class="kd">var</span> <span class="nx">rect</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">(),</span>
         <span class="nx">pRect</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">();</span>

        <span class="k">return</span> <span class="p">(</span><span class="nx">pRect</span><span class="p">.</span><span class="nx">right</span> <span class="o">-</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">right</span><span class="p">).</span><span class="nx">round</span><span class="p">();</span>
      <span class="p">},</span>

      <span class="s1">&#39;bottom&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">hasLayout</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">getOffsetParent</span><span class="p">());</span>
        <span class="kd">var</span> <span class="nx">rect</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">(),</span>
         <span class="nx">pRect</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">();</span>

        <span class="k">return</span> <span class="p">(</span><span class="nx">pRect</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">-</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">bottom</span><span class="p">).</span><span class="nx">round</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">Element</span><span class="p">.</span><span class="nx">Offset</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span> <span class="nx">top</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="nx">left</span><span class="p">.</span><span class="nx">round</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">top</span>  <span class="o">=</span> <span class="nx">top</span><span class="p">.</span><span class="nx">round</span><span class="p">();</span>

      <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">left</span><span class="p">;</span>
      <span class="k">this</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">top</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">relativeTo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">offset</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Offset</span><span class="p">(</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">left</span> <span class="o">-</span> <span class="nx">offset</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">top</span>  <span class="o">-</span> <span class="nx">offset</span><span class="p">.</span><span class="nx">top</span>
      <span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">inspect</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">&quot;#&lt;Element.Offset left: #{left} top: #{top}&gt;&quot;</span><span class="p">.</span><span class="nx">interpolate</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">&quot;[#{left}, #{top}]&quot;</span><span class="p">.</span><span class="nx">interpolate</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">toArray</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">top</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="kd">function</span> <span class="nx">getLayout</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">preCompute</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Layout</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">preCompute</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">measure</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">getLayout</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="nx">property</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">getDimensions</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">display</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;display&#39;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">display</span> <span class="o">&amp;&amp;</span> <span class="nx">display</span> <span class="o">!==</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">{</span> <span class="nx">width</span><span class="o">:</span> <span class="nx">element</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">,</span> <span class="nx">height</span><span class="o">:</span> <span class="nx">element</span><span class="p">.</span><span class="nx">offsetHeight</span> <span class="p">};</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">style</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">originalStyles</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">visibility</span><span class="o">:</span> <span class="nx">style</span><span class="p">.</span><span class="nx">visibility</span><span class="p">,</span>
      <span class="nx">position</span><span class="o">:</span>   <span class="nx">style</span><span class="p">.</span><span class="nx">position</span><span class="p">,</span>
      <span class="nx">display</span><span class="o">:</span>    <span class="nx">style</span><span class="p">.</span><span class="nx">display</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">newStyles</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">visibility</span><span class="o">:</span> <span class="s1">&#39;hidden&#39;</span><span class="p">,</span>
      <span class="nx">display</span><span class="o">:</span>    <span class="s1">&#39;block&#39;</span>
    <span class="p">};</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">originalStyles</span><span class="p">.</span><span class="nx">position</span> <span class="o">!==</span> <span class="s1">&#39;fixed&#39;</span><span class="p">)</span>
      <span class="nx">newStyles</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s1">&#39;absolute&#39;</span><span class="p">;</span>

    <span class="nx">Element</span><span class="p">.</span><span class="nx">setStyle</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">newStyles</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">dimensions</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">width</span><span class="o">:</span>  <span class="nx">element</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">,</span>
      <span class="nx">height</span><span class="o">:</span> <span class="nx">element</span><span class="p">.</span><span class="nx">offsetHeight</span>
    <span class="p">};</span>

    <span class="nx">Element</span><span class="p">.</span><span class="nx">setStyle</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">originalStyles</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">dimensions</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">getOffsetParent</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isDetached</span><span class="p">(</span><span class="nx">element</span><span class="p">))</span> <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">isInline</span> <span class="o">=</span> <span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;display&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;inline&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isInline</span> <span class="o">&amp;&amp;</span> <span class="nx">element</span><span class="p">.</span><span class="nx">offsetParent</span><span class="p">)</span> <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">offsetParent</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">element</span> <span class="o">===</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span> <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">((</span><span class="nx">element</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">element</span> <span class="o">!==</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;position&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;static&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">===</span> <span class="s1">&#39;HTML&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
  <span class="p">}</span>


  <span class="kd">function</span> <span class="nx">cumulativeOffset</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">valueT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">valueL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">do</span> <span class="p">{</span>
        <span class="nx">valueT</span> <span class="o">+=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">offsetTop</span>  <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">valueL</span> <span class="o">+=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">offsetLeft</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">element</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">offsetParent</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Offset</span><span class="p">(</span><span class="nx">valueL</span><span class="p">,</span> <span class="nx">valueT</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">positionedOffset</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">layout</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getLayout</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">valueT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">valueL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
      <span class="nx">valueT</span> <span class="o">+=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">offsetTop</span>  <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">valueL</span> <span class="o">+=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">offsetLeft</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">element</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">offsetParent</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">isBody</span><span class="p">(</span><span class="nx">element</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;position&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">p</span> <span class="o">!==</span> <span class="s1">&#39;static&#39;</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">element</span><span class="p">);</span>

    <span class="nx">valueL</span> <span class="o">-=</span> <span class="nx">layout</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;margin-top&#39;</span><span class="p">);</span>
    <span class="nx">valueT</span> <span class="o">-=</span> <span class="nx">layout</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;margin-left&#39;</span><span class="p">);</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Offset</span><span class="p">(</span><span class="nx">valueL</span><span class="p">,</span> <span class="nx">valueT</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">cumulativeScrollOffset</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">valueT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">valueL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
      <span class="nx">valueT</span> <span class="o">+=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">scrollTop</span>  <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">valueL</span> <span class="o">+=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">element</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Offset</span><span class="p">(</span><span class="nx">valueL</span><span class="p">,</span> <span class="nx">valueT</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">viewportOffset</span><span class="p">(</span><span class="nx">forElement</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">valueT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">valueL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">docBody</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">forElement</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
      <span class="nx">valueT</span> <span class="o">+=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">offsetTop</span>  <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">valueL</span> <span class="o">+=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">offsetLeft</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">offsetParent</span> <span class="o">==</span> <span class="nx">docBody</span> <span class="o">&amp;&amp;</span>
        <span class="nx">Element</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;position&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;absolute&#39;</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">element</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">offsetParent</span><span class="p">);</span>

    <span class="nx">element</span> <span class="o">=</span> <span class="nx">forElement</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">element</span> <span class="o">!=</span> <span class="nx">docBody</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">valueT</span> <span class="o">-=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">scrollTop</span>  <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">valueL</span> <span class="o">-=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">element</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Offset</span><span class="p">(</span><span class="nx">valueL</span><span class="p">,</span> <span class="nx">valueT</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">absolutize</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;position&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;absolute&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">offsetParent</span> <span class="o">=</span> <span class="nx">getOffsetParent</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">eOffset</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">viewportOffset</span><span class="p">(),</span>
     <span class="nx">pOffset</span> <span class="o">=</span> <span class="nx">offsetParent</span><span class="p">.</span><span class="nx">viewportOffset</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">offset</span> <span class="o">=</span> <span class="nx">eOffset</span><span class="p">.</span><span class="nx">relativeTo</span><span class="p">(</span><span class="nx">pOffset</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">layout</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getLayout</span><span class="p">();</span>

    <span class="nx">element</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="s1">&#39;prototype_absolutize_original_styles&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">left</span><span class="o">:</span>   <span class="nx">element</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">),</span>
      <span class="nx">top</span><span class="o">:</span>    <span class="nx">element</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">),</span>
      <span class="nx">width</span><span class="o">:</span>  <span class="nx">element</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">),</span>
      <span class="nx">height</span><span class="o">:</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">)</span>
    <span class="p">});</span>

    <span class="nx">element</span><span class="p">.</span><span class="nx">setStyle</span><span class="p">({</span>
      <span class="nx">position</span><span class="o">:</span> <span class="s1">&#39;absolute&#39;</span><span class="p">,</span>
      <span class="nx">top</span><span class="o">:</span>    <span class="nx">offset</span><span class="p">.</span><span class="nx">top</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">,</span>
      <span class="nx">left</span><span class="o">:</span>   <span class="nx">offset</span><span class="p">.</span><span class="nx">left</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">,</span>
      <span class="nx">width</span><span class="o">:</span>  <span class="nx">layout</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">,</span>
      <span class="nx">height</span><span class="o">:</span> <span class="nx">layout</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">relativize</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;position&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;relative&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">originalStyles</span> <span class="o">=</span>
     <span class="nx">element</span><span class="p">.</span><span class="nx">retrieve</span><span class="p">(</span><span class="s1">&#39;prototype_absolutize_original_styles&#39;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">originalStyles</span><span class="p">)</span> <span class="nx">element</span><span class="p">.</span><span class="nx">setStyle</span><span class="p">(</span><span class="nx">originalStyles</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">Prototype</span><span class="p">.</span><span class="nx">Browser</span><span class="p">.</span><span class="nx">IE</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">getOffsetParent</span> <span class="o">=</span> <span class="nx">getOffsetParent</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">proceed</span><span class="p">,</span> <span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">isDetached</span><span class="p">(</span><span class="nx">element</span><span class="p">))</span> <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">position</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">position</span> <span class="o">!==</span> <span class="s1">&#39;static&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">proceed</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>

        <span class="nx">element</span><span class="p">.</span><span class="nx">setStyle</span><span class="p">({</span> <span class="nx">position</span><span class="o">:</span> <span class="s1">&#39;relative&#39;</span> <span class="p">});</span>
        <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">proceed</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">setStyle</span><span class="p">({</span> <span class="nx">position</span><span class="o">:</span> <span class="nx">position</span> <span class="p">});</span>
        <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">);</span>

    <span class="nx">positionedOffset</span> <span class="o">=</span> <span class="nx">positionedOffset</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">proceed</span><span class="p">,</span> <span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">)</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Offset</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">position</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">position</span> <span class="o">!==</span> <span class="s1">&#39;static&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">proceed</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">offsetParent</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getOffsetParent</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">offsetParent</span> <span class="o">&amp;&amp;</span> <span class="nx">offsetParent</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;fixed&#39;</span><span class="p">)</span>
        <span class="nx">hasLayout</span><span class="p">(</span><span class="nx">offsetParent</span><span class="p">);</span>

      <span class="nx">element</span><span class="p">.</span><span class="nx">setStyle</span><span class="p">({</span> <span class="nx">position</span><span class="o">:</span> <span class="s1">&#39;relative&#39;</span> <span class="p">});</span>
      <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">proceed</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">setStyle</span><span class="p">({</span> <span class="nx">position</span><span class="o">:</span> <span class="nx">position</span> <span class="p">});</span>
      <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">Prototype</span><span class="p">.</span><span class="nx">Browser</span><span class="p">.</span><span class="nx">Webkit</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">cumulativeOffset</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">valueT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">valueL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">do</span> <span class="p">{</span>
        <span class="nx">valueT</span> <span class="o">+=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">offsetTop</span>  <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">valueL</span> <span class="o">+=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">offsetLeft</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">offsetParent</span> <span class="o">==</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">getStyle</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;position&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;absolute&#39;</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

        <span class="nx">element</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">offsetParent</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">element</span><span class="p">);</span>

      <span class="k">return</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Offset</span><span class="p">(</span><span class="nx">valueL</span><span class="p">,</span> <span class="nx">valueT</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>


  <span class="nx">Element</span><span class="p">.</span><span class="nx">addMethods</span><span class="p">({</span>
    <span class="nx">getLayout</span><span class="o">:</span>              <span class="nx">getLayout</span><span class="p">,</span>
    <span class="nx">measure</span><span class="o">:</span>                <span class="nx">measure</span><span class="p">,</span>
    <span class="nx">getDimensions</span><span class="o">:</span>          <span class="nx">getDimensions</span><span class="p">,</span>
    <span class="nx">getOffsetParent</span><span class="o">:</span>        <span class="nx">getOffsetParent</span><span class="p">,</span>
    <span class="nx">cumulativeOffset</span><span class="o">:</span>       <span class="nx">cumulativeOffset</span><span class="p">,</span>
    <span class="nx">positionedOffset</span><span class="o">:</span>       <span class="nx">positionedOffset</span><span class="p">,</span>
    <span class="nx">cumulativeScrollOffset</span><span class="o">:</span> <span class="nx">cumulativeScrollOffset</span><span class="p">,</span>
    <span class="nx">viewportOffset</span><span class="o">:</span>         <span class="nx">viewportOffset</span><span class="p">,</span>
    <span class="nx">absolutize</span><span class="o">:</span>             <span class="nx">absolutize</span><span class="p">,</span>
    <span class="nx">relativize</span><span class="o">:</span>             <span class="nx">relativize</span>
  <span class="p">});</span>

  <span class="kd">function</span> <span class="nx">isBody</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;BODY&#39;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">isDetached</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">element</span> <span class="o">!==</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span> <span class="o">&amp;&amp;</span>
     <span class="o">!</span><span class="nx">Element</span><span class="p">.</span><span class="nx">descendantOf</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;getBoundingClientRect&#39;</span> <span class="k">in</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Element</span><span class="p">.</span><span class="nx">addMethods</span><span class="p">({</span>
      <span class="nx">viewportOffset</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">isDetached</span><span class="p">(</span><span class="nx">element</span><span class="p">))</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Offset</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">rect</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">(),</span>
         <span class="nx">docEl</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Offset</span><span class="p">(</span><span class="nx">rect</span><span class="p">.</span><span class="nx">left</span> <span class="o">-</span> <span class="nx">docEl</span><span class="p">.</span><span class="nx">clientLeft</span><span class="p">,</span>
         <span class="nx">rect</span><span class="p">.</span><span class="nx">top</span> <span class="o">-</span> <span class="nx">docEl</span><span class="p">.</span><span class="nx">clientTop</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">})();</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">$$</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">expression</span> <span class="o">=</span> <span class="nx">$A</span><span class="p">(</span><span class="nx">arguments</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">Selector</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">expression</span><span class="p">,</span> <span class="nb">document</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">Prototype</span><span class="p">.</span><span class="nx">Selector</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="kd">function</span> <span class="nx">select</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Method &quot;Prototype.Selector.select&quot; must be defined.&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">match</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Method &quot;Prototype.Selector.match&quot; must be defined.&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">find</span><span class="p">(</span><span class="nx">elements</span><span class="p">,</span> <span class="nx">expression</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">index</span> <span class="o">=</span> <span class="nx">index</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">Selector</span><span class="p">.</span><span class="nx">match</span><span class="p">,</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">elements</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">matchIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">i</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">match</span><span class="p">(</span><span class="nx">elements</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">expression</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">index</span> <span class="o">==</span> <span class="nx">matchIndex</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">elements</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">extendElements</span><span class="p">(</span><span class="nx">elements</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">elements</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">Element</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">elements</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">elements</span><span class="p">;</span>
  <span class="p">}</span>


  <span class="kd">var</span> <span class="nx">K</span> <span class="o">=</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">K</span><span class="p">;</span>

  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">select</span><span class="o">:</span> <span class="nx">select</span><span class="p">,</span>
    <span class="nx">match</span><span class="o">:</span> <span class="nx">match</span><span class="p">,</span>
    <span class="nx">find</span><span class="o">:</span> <span class="nx">find</span><span class="p">,</span>
    <span class="nx">extendElements</span><span class="o">:</span> <span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">extend</span> <span class="o">===</span> <span class="nx">K</span><span class="p">)</span> <span class="o">?</span> <span class="nx">K</span> <span class="o">:</span> <span class="nx">extendElements</span><span class="p">,</span>
    <span class="nx">extendElement</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">extend</span>
  <span class="p">};</span>
<span class="p">})();</span>
<span class="nx">Prototype</span><span class="p">.</span><span class="nx">_original_property</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Sizzle</span><span class="p">;</span>
<span class="cm">/*!</span>
<span class="cm"> * Sizzle CSS Selector Engine - v1.0</span>
<span class="cm"> *  Copyright 2009, The Dojo Foundation</span>
<span class="cm"> *  Released under the MIT, BSD, and GPL Licenses.</span>
<span class="cm"> *  More information: http://sizzlejs.com/</span>
<span class="cm"> */</span>
<span class="p">(</span><span class="kd">function</span><span class="p">(){</span>

<span class="kd">var</span> <span class="nx">chunker</span> <span class="o">=</span> <span class="sr">/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^[\]]*\]|[&#39;&quot;][^&#39;&quot;]*[&#39;&quot;]|[^[\]&#39;&quot;]+)+\]|\\.|[^ &gt;+~,(\[\\]+)+|[&gt;+~])(\s*,\s*)?((?:.|\r|\n)*)/g</span><span class="p">,</span>
	<span class="nx">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="nx">toString</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">,</span>
	<span class="nx">hasDuplicate</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
	<span class="nx">baseHasDuplicate</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

<span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">].</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
	<span class="nx">baseHasDuplicate</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">Sizzle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">results</span><span class="p">,</span> <span class="nx">seed</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">results</span> <span class="o">=</span> <span class="nx">results</span> <span class="o">||</span> <span class="p">[];</span>
	<span class="kd">var</span> <span class="nx">origContext</span> <span class="o">=</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">context</span> <span class="o">||</span> <span class="nb">document</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="nx">context</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">!==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">!==</span> <span class="mi">9</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">[];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">selector</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">selector</span> <span class="o">!==</span> <span class="s2">&quot;string&quot;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="kd">var</span> <span class="nx">parts</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">set</span><span class="p">,</span> <span class="nx">checkSet</span><span class="p">,</span> <span class="nx">check</span><span class="p">,</span> <span class="nx">mode</span><span class="p">,</span> <span class="nx">extra</span><span class="p">,</span> <span class="nx">prune</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">contextXML</span> <span class="o">=</span> <span class="nx">isXML</span><span class="p">(</span><span class="nx">context</span><span class="p">),</span>
		<span class="nx">soFar</span> <span class="o">=</span> <span class="nx">selector</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="nx">chunker</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">chunker</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">soFar</span><span class="p">))</span> <span class="o">!==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
		<span class="nx">soFar</span> <span class="o">=</span> <span class="nx">m</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

		<span class="nx">parts</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">m</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
			<span class="nx">extra</span> <span class="o">=</span> <span class="nx">m</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">origPOS</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span> <span class="nx">selector</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">relative</span><span class="p">[</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
			<span class="nx">set</span> <span class="o">=</span> <span class="nx">posProcess</span><span class="p">(</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">context</span> <span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">set</span> <span class="o">=</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">relative</span><span class="p">[</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span> <span class="o">?</span>
				<span class="p">[</span> <span class="nx">context</span> <span class="p">]</span> <span class="o">:</span>
				<span class="nx">Sizzle</span><span class="p">(</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">shift</span><span class="p">(),</span> <span class="nx">context</span> <span class="p">);</span>

			<span class="k">while</span> <span class="p">(</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
				<span class="nx">selector</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">relative</span><span class="p">[</span> <span class="nx">selector</span> <span class="p">]</span> <span class="p">)</span>
					<span class="nx">selector</span> <span class="o">+=</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>

				<span class="nx">set</span> <span class="o">=</span> <span class="nx">posProcess</span><span class="p">(</span> <span class="nx">selector</span><span class="p">,</span> <span class="nx">set</span> <span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">seed</span> <span class="o">&amp;&amp;</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">9</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">contextXML</span> <span class="o">&amp;&amp;</span>
				<span class="nx">Expr</span><span class="p">.</span><span class="nx">match</span><span class="p">.</span><span class="nx">ID</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">Expr</span><span class="p">.</span><span class="nx">match</span><span class="p">.</span><span class="nx">ID</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="nx">parts</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">Sizzle</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">shift</span><span class="p">(),</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">contextXML</span> <span class="p">);</span>
			<span class="nx">context</span> <span class="o">=</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">expr</span> <span class="o">?</span> <span class="nx">Sizzle</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">expr</span><span class="p">,</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">set</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">set</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">context</span> <span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">seed</span> <span class="o">?</span>
				<span class="p">{</span> <span class="nx">expr</span><span class="o">:</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">pop</span><span class="p">(),</span> <span class="nx">set</span><span class="o">:</span> <span class="nx">makeArray</span><span class="p">(</span><span class="nx">seed</span><span class="p">)</span> <span class="p">}</span> <span class="o">:</span>
				<span class="nx">Sizzle</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">pop</span><span class="p">(),</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;~&quot;</span> <span class="o">||</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;+&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">?</span> <span class="nx">context</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">:</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">contextXML</span> <span class="p">);</span>
			<span class="nx">set</span> <span class="o">=</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">expr</span> <span class="o">?</span> <span class="nx">Sizzle</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">expr</span><span class="p">,</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">set</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">set</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
				<span class="nx">checkSet</span> <span class="o">=</span> <span class="nx">makeArray</span><span class="p">(</span><span class="nx">set</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nx">prune</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">while</span> <span class="p">(</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">pop</span><span class="p">(),</span> <span class="nx">pop</span> <span class="o">=</span> <span class="nx">cur</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">Expr</span><span class="p">.</span><span class="nx">relative</span><span class="p">[</span> <span class="nx">cur</span> <span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">cur</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="nx">pop</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">pop</span> <span class="o">==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">pop</span> <span class="o">=</span> <span class="nx">context</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="nx">Expr</span><span class="p">.</span><span class="nx">relative</span><span class="p">[</span> <span class="nx">cur</span> <span class="p">](</span> <span class="nx">checkSet</span><span class="p">,</span> <span class="nx">pop</span><span class="p">,</span> <span class="nx">contextXML</span> <span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">checkSet</span> <span class="o">=</span> <span class="nx">parts</span> <span class="o">=</span> <span class="p">[];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">checkSet</span> <span class="p">)</span> <span class="p">{</span>
		<span class="nx">checkSet</span> <span class="o">=</span> <span class="nx">set</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">checkSet</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">throw</span> <span class="s2">&quot;Syntax error, unrecognized expression: &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">cur</span> <span class="o">||</span> <span class="nx">selector</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">checkSet</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;[object Array]&quot;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">prune</span> <span class="p">)</span> <span class="p">{</span>
			<span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">results</span><span class="p">,</span> <span class="nx">checkSet</span> <span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">context</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">checkSet</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span> <span class="nx">checkSet</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">checkSet</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">||</span> <span class="nx">checkSet</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">contains</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">checkSet</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">set</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">checkSet</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span> <span class="nx">checkSet</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">checkSet</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">set</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">makeArray</span><span class="p">(</span> <span class="nx">checkSet</span><span class="p">,</span> <span class="nx">results</span> <span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="nx">extra</span> <span class="p">)</span> <span class="p">{</span>
		<span class="nx">Sizzle</span><span class="p">(</span> <span class="nx">extra</span><span class="p">,</span> <span class="nx">origContext</span><span class="p">,</span> <span class="nx">results</span><span class="p">,</span> <span class="nx">seed</span> <span class="p">);</span>
		<span class="nx">Sizzle</span><span class="p">.</span><span class="nx">uniqueSort</span><span class="p">(</span> <span class="nx">results</span> <span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">Sizzle</span><span class="p">.</span><span class="nx">uniqueSort</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">results</span><span class="p">){</span>
	<span class="k">if</span> <span class="p">(</span> <span class="nx">sortOrder</span> <span class="p">)</span> <span class="p">{</span>
		<span class="nx">hasDuplicate</span> <span class="o">=</span> <span class="nx">baseHasDuplicate</span><span class="p">;</span>
		<span class="nx">results</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nx">sortOrder</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">hasDuplicate</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span> <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">results</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">Sizzle</span><span class="p">.</span><span class="nx">matches</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">expr</span><span class="p">,</span> <span class="nx">set</span><span class="p">){</span>
	<span class="k">return</span> <span class="nx">Sizzle</span><span class="p">(</span><span class="nx">expr</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">set</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">Sizzle</span><span class="p">.</span><span class="nx">find</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">expr</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">isXML</span><span class="p">){</span>
	<span class="kd">var</span> <span class="nx">set</span><span class="p">,</span> <span class="nx">match</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">expr</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">[];</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">order</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">order</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">match</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="nx">match</span> <span class="o">=</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">leftMatch</span><span class="p">[</span> <span class="nx">type</span> <span class="p">].</span><span class="nx">exec</span><span class="p">(</span> <span class="nx">expr</span> <span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">left</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="nx">match</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">left</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span> <span class="nx">left</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">!==</span> <span class="s2">&quot;\\&quot;</span> <span class="p">)</span> <span class="p">{</span>
				<span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\/g</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
				<span class="nx">set</span> <span class="o">=</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">find</span><span class="p">[</span> <span class="nx">type</span> <span class="p">](</span> <span class="nx">match</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">isXML</span> <span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span> <span class="nx">set</span> <span class="o">!=</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">expr</span> <span class="o">=</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span> <span class="nx">type</span> <span class="p">],</span> <span class="s2">&quot;&quot;</span> <span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">set</span> <span class="p">)</span> <span class="p">{</span>
		<span class="nx">set</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">{</span><span class="nx">set</span><span class="o">:</span> <span class="nx">set</span><span class="p">,</span> <span class="nx">expr</span><span class="o">:</span> <span class="nx">expr</span><span class="p">};</span>
<span class="p">};</span>

<span class="nx">Sizzle</span><span class="p">.</span><span class="nx">filter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">expr</span><span class="p">,</span> <span class="nx">set</span><span class="p">,</span> <span class="nx">inplace</span><span class="p">,</span> <span class="nx">not</span><span class="p">){</span>
	<span class="kd">var</span> <span class="nx">old</span> <span class="o">=</span> <span class="nx">expr</span><span class="p">,</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">curLoop</span> <span class="o">=</span> <span class="nx">set</span><span class="p">,</span> <span class="nx">match</span><span class="p">,</span> <span class="nx">anyFound</span><span class="p">,</span>
		<span class="nx">isXMLFilter</span> <span class="o">=</span> <span class="nx">set</span> <span class="o">&amp;&amp;</span> <span class="nx">set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">isXML</span><span class="p">(</span><span class="nx">set</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">while</span> <span class="p">(</span> <span class="nx">expr</span> <span class="o">&amp;&amp;</span> <span class="nx">set</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">type</span> <span class="k">in</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">filter</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="nx">match</span> <span class="o">=</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span> <span class="nx">type</span> <span class="p">].</span><span class="nx">exec</span><span class="p">(</span> <span class="nx">expr</span> <span class="p">))</span> <span class="o">!=</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">filter</span> <span class="o">=</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">filter</span><span class="p">[</span> <span class="nx">type</span> <span class="p">],</span> <span class="nx">found</span><span class="p">,</span> <span class="nx">item</span><span class="p">;</span>
				<span class="nx">anyFound</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">curLoop</span> <span class="o">==</span> <span class="nx">result</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">preFilter</span><span class="p">[</span> <span class="nx">type</span> <span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">match</span> <span class="o">=</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">preFilter</span><span class="p">[</span> <span class="nx">type</span> <span class="p">](</span> <span class="nx">match</span><span class="p">,</span> <span class="nx">curLoop</span><span class="p">,</span> <span class="nx">inplace</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">not</span><span class="p">,</span> <span class="nx">isXMLFilter</span> <span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">match</span> <span class="p">)</span> <span class="p">{</span>
						<span class="nx">anyFound</span> <span class="o">=</span> <span class="nx">found</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">match</span> <span class="o">===</span> <span class="kc">true</span> <span class="p">)</span> <span class="p">{</span>
						<span class="k">continue</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">match</span> <span class="p">)</span> <span class="p">{</span>
					<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="nx">item</span> <span class="o">=</span> <span class="nx">curLoop</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span> <span class="nx">item</span> <span class="p">)</span> <span class="p">{</span>
							<span class="nx">found</span> <span class="o">=</span> <span class="nx">filter</span><span class="p">(</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">match</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">curLoop</span> <span class="p">);</span>
							<span class="kd">var</span> <span class="nx">pass</span> <span class="o">=</span> <span class="nx">not</span> <span class="o">^</span> <span class="o">!!</span><span class="nx">found</span><span class="p">;</span>

							<span class="k">if</span> <span class="p">(</span> <span class="nx">inplace</span> <span class="o">&amp;&amp;</span> <span class="nx">found</span> <span class="o">!=</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
								<span class="k">if</span> <span class="p">(</span> <span class="nx">pass</span> <span class="p">)</span> <span class="p">{</span>
									<span class="nx">anyFound</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
								<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
									<span class="nx">curLoop</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
								<span class="p">}</span>
							<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">pass</span> <span class="p">)</span> <span class="p">{</span>
								<span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">item</span> <span class="p">);</span>
								<span class="nx">anyFound</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">found</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">inplace</span> <span class="p">)</span> <span class="p">{</span>
						<span class="nx">curLoop</span> <span class="o">=</span> <span class="nx">result</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="nx">expr</span> <span class="o">=</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span> <span class="nx">type</span> <span class="p">],</span> <span class="s2">&quot;&quot;</span> <span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">anyFound</span> <span class="p">)</span> <span class="p">{</span>
						<span class="k">return</span> <span class="p">[];</span>
					<span class="p">}</span>

					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">expr</span> <span class="o">==</span> <span class="nx">old</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span> <span class="nx">anyFound</span> <span class="o">==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">throw</span> <span class="s2">&quot;Syntax error, unrecognized expression: &quot;</span> <span class="o">+</span> <span class="nx">expr</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="nx">old</span> <span class="o">=</span> <span class="nx">expr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">curLoop</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">Expr</span> <span class="o">=</span> <span class="nx">Sizzle</span><span class="p">.</span><span class="nx">selectors</span> <span class="o">=</span> <span class="p">{</span>
	<span class="nx">order</span><span class="o">:</span> <span class="p">[</span> <span class="s2">&quot;ID&quot;</span><span class="p">,</span> <span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;TAG&quot;</span> <span class="p">],</span>
	<span class="nx">match</span><span class="o">:</span> <span class="p">{</span>
		<span class="nx">ID</span><span class="o">:</span> <span class="sr">/#((?:[\w\u00c0-\uFFFF-]|\\.)+)/</span><span class="p">,</span>
		<span class="nx">CLASS</span><span class="o">:</span> <span class="sr">/\.((?:[\w\u00c0-\uFFFF-]|\\.)+)/</span><span class="p">,</span>
		<span class="nx">NAME</span><span class="o">:</span> <span class="sr">/\[name=[&#39;&quot;]*((?:[\w\u00c0-\uFFFF-]|\\.)+)[&#39;&quot;]*\]/</span><span class="p">,</span>
		<span class="nx">ATTR</span><span class="o">:</span> <span class="sr">/\[\s*((?:[\w\u00c0-\uFFFF-]|\\.)+)\s*(?:(\S?=)\s*([&#39;&quot;]*)(.*?)\3|)\s*\]/</span><span class="p">,</span>
		<span class="nx">TAG</span><span class="o">:</span> <span class="sr">/^((?:[\w\u00c0-\uFFFF\*-]|\\.)+)/</span><span class="p">,</span>
		<span class="nx">CHILD</span><span class="o">:</span> <span class="sr">/:(only|nth|last|first)-child(?:\((even|odd|[\dn+-]*)\))?/</span><span class="p">,</span>
		<span class="nx">POS</span><span class="o">:</span> <span class="sr">/:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^-]|$)/</span><span class="p">,</span>
		<span class="nx">PSEUDO</span><span class="o">:</span> <span class="sr">/:((?:[\w\u00c0-\uFFFF-]|\\.)+)(?:\(([&#39;&quot;]*)((?:\([^\)]+\)|[^\2\(\)]*)+)\2\))?/</span>
	<span class="p">},</span>
	<span class="nx">leftMatch</span><span class="o">:</span> <span class="p">{},</span>
	<span class="nx">attrMap</span><span class="o">:</span> <span class="p">{</span>
		<span class="s2">&quot;class&quot;</span><span class="o">:</span> <span class="s2">&quot;className&quot;</span><span class="p">,</span>
		<span class="s2">&quot;for&quot;</span><span class="o">:</span> <span class="s2">&quot;htmlFor&quot;</span>
	<span class="p">},</span>
	<span class="nx">attrHandle</span><span class="o">:</span> <span class="p">{</span>
		<span class="nx">href</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
			<span class="k">return</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="nx">relative</span><span class="o">:</span> <span class="p">{</span>
		<span class="s2">&quot;+&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">checkSet</span><span class="p">,</span> <span class="nx">part</span><span class="p">,</span> <span class="nx">isXML</span><span class="p">){</span>
			<span class="kd">var</span> <span class="nx">isPartStr</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">part</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
				<span class="nx">isTag</span> <span class="o">=</span> <span class="nx">isPartStr</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="sr">/\W/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">part</span><span class="p">),</span>
				<span class="nx">isPartStrNotTag</span> <span class="o">=</span> <span class="nx">isPartStr</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isTag</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">isTag</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isXML</span> <span class="p">)</span> <span class="p">{</span>
				<span class="nx">part</span> <span class="o">=</span> <span class="nx">part</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">();</span>
			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">checkSet</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">elem</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="nx">elem</span> <span class="o">=</span> <span class="nx">checkSet</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">)</span> <span class="p">{</span>
					<span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="nx">elem</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">previousSibling</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">!==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{}</span>

					<span class="nx">checkSet</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">isPartStrNotTag</span> <span class="o">||</span> <span class="nx">elem</span> <span class="o">&amp;&amp;</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">===</span> <span class="nx">part</span> <span class="o">?</span>
						<span class="nx">elem</span> <span class="o">||</span> <span class="kc">false</span> <span class="o">:</span>
						<span class="nx">elem</span> <span class="o">===</span> <span class="nx">part</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">isPartStrNotTag</span> <span class="p">)</span> <span class="p">{</span>
				<span class="nx">Sizzle</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span> <span class="nx">part</span><span class="p">,</span> <span class="nx">checkSet</span><span class="p">,</span> <span class="kc">true</span> <span class="p">);</span>
			<span class="p">}</span>
		<span class="p">},</span>
		<span class="s2">&quot;&gt;&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">checkSet</span><span class="p">,</span> <span class="nx">part</span><span class="p">,</span> <span class="nx">isXML</span><span class="p">){</span>
			<span class="kd">var</span> <span class="nx">isPartStr</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">part</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">isPartStr</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="sr">/\W/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">part</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
				<span class="nx">part</span> <span class="o">=</span> <span class="nx">isXML</span> <span class="o">?</span> <span class="nx">part</span> <span class="o">:</span> <span class="nx">part</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">();</span>

				<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">checkSet</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
					<span class="kd">var</span> <span class="nx">elem</span> <span class="o">=</span> <span class="nx">checkSet</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">(</span> <span class="nx">elem</span> <span class="p">)</span> <span class="p">{</span>
						<span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
						<span class="nx">checkSet</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">===</span> <span class="nx">part</span> <span class="o">?</span> <span class="nx">parent</span> <span class="o">:</span> <span class="kc">false</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">checkSet</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
					<span class="kd">var</span> <span class="nx">elem</span> <span class="o">=</span> <span class="nx">checkSet</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">(</span> <span class="nx">elem</span> <span class="p">)</span> <span class="p">{</span>
						<span class="nx">checkSet</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">isPartStr</span> <span class="o">?</span>
							<span class="nx">elem</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">:</span>
							<span class="nx">elem</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">===</span> <span class="nx">part</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">isPartStr</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">Sizzle</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span> <span class="nx">part</span><span class="p">,</span> <span class="nx">checkSet</span><span class="p">,</span> <span class="kc">true</span> <span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">},</span>
		<span class="s2">&quot;&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">checkSet</span><span class="p">,</span> <span class="nx">part</span><span class="p">,</span> <span class="nx">isXML</span><span class="p">){</span>
			<span class="kd">var</span> <span class="nx">doneName</span> <span class="o">=</span> <span class="nx">done</span><span class="o">++</span><span class="p">,</span> <span class="nx">checkFn</span> <span class="o">=</span> <span class="nx">dirCheck</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="sr">/\W/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">part</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">nodeCheck</span> <span class="o">=</span> <span class="nx">part</span> <span class="o">=</span> <span class="nx">isXML</span> <span class="o">?</span> <span class="nx">part</span> <span class="o">:</span> <span class="nx">part</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">();</span>
				<span class="nx">checkFn</span> <span class="o">=</span> <span class="nx">dirNodeCheck</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="nx">checkFn</span><span class="p">(</span><span class="s2">&quot;parentNode&quot;</span><span class="p">,</span> <span class="nx">part</span><span class="p">,</span> <span class="nx">doneName</span><span class="p">,</span> <span class="nx">checkSet</span><span class="p">,</span> <span class="nx">nodeCheck</span><span class="p">,</span> <span class="nx">isXML</span><span class="p">);</span>
		<span class="p">},</span>
		<span class="s2">&quot;~&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">checkSet</span><span class="p">,</span> <span class="nx">part</span><span class="p">,</span> <span class="nx">isXML</span><span class="p">){</span>
			<span class="kd">var</span> <span class="nx">doneName</span> <span class="o">=</span> <span class="nx">done</span><span class="o">++</span><span class="p">,</span> <span class="nx">checkFn</span> <span class="o">=</span> <span class="nx">dirCheck</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">part</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="sr">/\W/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">part</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">nodeCheck</span> <span class="o">=</span> <span class="nx">part</span> <span class="o">=</span> <span class="nx">isXML</span> <span class="o">?</span> <span class="nx">part</span> <span class="o">:</span> <span class="nx">part</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">();</span>
				<span class="nx">checkFn</span> <span class="o">=</span> <span class="nx">dirNodeCheck</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="nx">checkFn</span><span class="p">(</span><span class="s2">&quot;previousSibling&quot;</span><span class="p">,</span> <span class="nx">part</span><span class="p">,</span> <span class="nx">doneName</span><span class="p">,</span> <span class="nx">checkSet</span><span class="p">,</span> <span class="nx">nodeCheck</span><span class="p">,</span> <span class="nx">isXML</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="nx">find</span><span class="o">:</span> <span class="p">{</span>
		<span class="nx">ID</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">isXML</span><span class="p">){</span>
			<span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">context</span><span class="p">.</span><span class="nx">getElementById</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isXML</span> <span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
				<span class="k">return</span> <span class="nx">m</span> <span class="o">?</span> <span class="p">[</span><span class="nx">m</span><span class="p">]</span> <span class="o">:</span> <span class="p">[];</span>
			<span class="p">}</span>
		<span class="p">},</span>
		<span class="nx">NAME</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">isXML</span><span class="p">){</span>
			<span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">context</span><span class="p">.</span><span class="nx">getElementsByName</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">results</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">getElementsByName</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

				<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span> <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
						<span class="nx">ret</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="k">return</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nx">ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">},</span>
		<span class="nx">TAG</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">context</span><span class="p">){</span>
			<span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="nx">preFilter</span><span class="o">:</span> <span class="p">{</span>
		<span class="nx">CLASS</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">curLoop</span><span class="p">,</span> <span class="nx">inplace</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">not</span><span class="p">,</span> <span class="nx">isXML</span><span class="p">){</span>
			<span class="nx">match</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\/g</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">isXML</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">match</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">elem</span><span class="p">;</span> <span class="p">(</span><span class="nx">elem</span> <span class="o">=</span> <span class="nx">curLoop</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span> <span class="nx">elem</span> <span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span> <span class="nx">not</span> <span class="o">^</span> <span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">className</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">className</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">inplace</span> <span class="p">)</span>
							<span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">elem</span> <span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">inplace</span> <span class="p">)</span> <span class="p">{</span>
						<span class="nx">curLoop</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">ID</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">){</span>
			<span class="k">return</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\/g</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
		<span class="p">},</span>
		<span class="nx">TAG</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">curLoop</span><span class="p">){</span>
			<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">curLoop</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="kc">false</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">){}</span>
			<span class="k">return</span> <span class="nx">curLoop</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">isXML</span><span class="p">(</span><span class="nx">curLoop</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">?</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">toUpperCase</span><span class="p">();</span>
		<span class="p">},</span>
		<span class="nx">CHILD</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">){</span>
			<span class="k">if</span> <span class="p">(</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;nth&quot;</span> <span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">test</span> <span class="o">=</span> <span class="sr">/(-?)(\d*)n((?:\+|-)?\d*)/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span>
					<span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;even&quot;</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;2n&quot;</span> <span class="o">||</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;odd&quot;</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;2n+1&quot;</span> <span class="o">||</span>
					<span class="o">!</span><span class="sr">/\D/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;0n+&quot;</span> <span class="o">+</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

				<span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">test</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="nx">test</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">0</span><span class="p">;</span>
				<span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nx">test</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">done</span><span class="o">++</span><span class="p">;</span>

			<span class="k">return</span> <span class="nx">match</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">ATTR</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">curLoop</span><span class="p">,</span> <span class="nx">inplace</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">not</span><span class="p">,</span> <span class="nx">isXML</span><span class="p">){</span>
			<span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\/g</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">isXML</span> <span class="o">&amp;&amp;</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">attrMap</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
				<span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">attrMap</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;~=&quot;</span> <span class="p">)</span> <span class="p">{</span>
				<span class="nx">match</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">match</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">return</span> <span class="nx">match</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">PSEUDO</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">curLoop</span><span class="p">,</span> <span class="nx">inplace</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">not</span><span class="p">){</span>
			<span class="k">if</span> <span class="p">(</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;not&quot;</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="nx">chunker</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span> <span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="sr">/^\w/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Sizzle</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">curLoop</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">Sizzle</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nx">curLoop</span><span class="p">,</span> <span class="nx">inplace</span><span class="p">,</span> <span class="kc">true</span> <span class="o">^</span> <span class="nx">not</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">inplace</span> <span class="p">)</span> <span class="p">{</span>
						<span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">ret</span> <span class="p">);</span>
					<span class="p">}</span>
					<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">match</span><span class="p">.</span><span class="nx">POS</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">match</span><span class="p">.</span><span class="nx">CHILD</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">return</span> <span class="nx">match</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">POS</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">){</span>
			<span class="nx">match</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span> <span class="kc">true</span> <span class="p">);</span>
			<span class="k">return</span> <span class="nx">match</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="nx">filters</span><span class="o">:</span> <span class="p">{</span>
		<span class="nx">enabled</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
			<span class="k">return</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">===</span> <span class="kc">false</span> <span class="o">&amp;&amp;</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="s2">&quot;hidden&quot;</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">disabled</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
			<span class="k">return</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">===</span> <span class="kc">true</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">checked</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
			<span class="k">return</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">checked</span> <span class="o">===</span> <span class="kc">true</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">selected</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
			<span class="nx">elem</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">selectedIndex</span><span class="p">;</span>
			<span class="k">return</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">selected</span> <span class="o">===</span> <span class="kc">true</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">parent</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
			<span class="k">return</span> <span class="o">!!</span><span class="nx">elem</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">empty</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
			<span class="k">return</span> <span class="o">!</span><span class="nx">elem</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">has</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">match</span><span class="p">){</span>
			<span class="k">return</span> <span class="o">!!</span><span class="nx">Sizzle</span><span class="p">(</span> <span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nx">elem</span> <span class="p">).</span><span class="nx">length</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">header</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
			<span class="k">return</span> <span class="sr">/h\d/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">nodeName</span> <span class="p">);</span>
		<span class="p">},</span>
		<span class="nx">text</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
			<span class="k">return</span> <span class="s2">&quot;text&quot;</span> <span class="o">===</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">radio</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
			<span class="k">return</span> <span class="s2">&quot;radio&quot;</span> <span class="o">===</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">checkbox</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
			<span class="k">return</span> <span class="s2">&quot;checkbox&quot;</span> <span class="o">===</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">file</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
			<span class="k">return</span> <span class="s2">&quot;file&quot;</span> <span class="o">===</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">password</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
			<span class="k">return</span> <span class="s2">&quot;password&quot;</span> <span class="o">===</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">submit</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
			<span class="k">return</span> <span class="s2">&quot;submit&quot;</span> <span class="o">===</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">image</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
			<span class="k">return</span> <span class="s2">&quot;image&quot;</span> <span class="o">===</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">reset</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
			<span class="k">return</span> <span class="s2">&quot;reset&quot;</span> <span class="o">===</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">button</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
			<span class="k">return</span> <span class="s2">&quot;button&quot;</span> <span class="o">===</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">type</span> <span class="o">||</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">===</span> <span class="s2">&quot;BUTTON&quot;</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">input</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
			<span class="k">return</span> <span class="sr">/input|select|textarea|button/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="nx">setFilters</span><span class="o">:</span> <span class="p">{</span>
		<span class="nx">first</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">i</span><span class="p">){</span>
			<span class="k">return</span> <span class="nx">i</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">last</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">match</span><span class="p">,</span> <span class="nx">array</span><span class="p">){</span>
			<span class="k">return</span> <span class="nx">i</span> <span class="o">===</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">even</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">i</span><span class="p">){</span>
			<span class="k">return</span> <span class="nx">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">odd</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">i</span><span class="p">){</span>
			<span class="k">return</span> <span class="nx">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">===</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">lt</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">match</span><span class="p">){</span>
			<span class="k">return</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">gt</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">match</span><span class="p">){</span>
			<span class="k">return</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">nth</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">match</span><span class="p">){</span>
			<span class="k">return</span> <span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="mi">0</span> <span class="o">==</span> <span class="nx">i</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">eq</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">match</span><span class="p">){</span>
			<span class="k">return</span> <span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="mi">0</span> <span class="o">==</span> <span class="nx">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="nx">filter</span><span class="o">:</span> <span class="p">{</span>
		<span class="nx">PSEUDO</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">match</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">array</span><span class="p">){</span>
			<span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">filter</span> <span class="o">=</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">filters</span><span class="p">[</span> <span class="nx">name</span> <span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">filter</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">filter</span><span class="p">(</span> <span class="nx">elem</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">match</span><span class="p">,</span> <span class="nx">array</span> <span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">name</span> <span class="o">===</span> <span class="s2">&quot;contains&quot;</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">||</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">name</span> <span class="o">===</span> <span class="s2">&quot;not&quot;</span> <span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">not</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

				<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">not</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span> <span class="nx">not</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">elem</span> <span class="p">)</span> <span class="p">{</span>
						<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">},</span>
		<span class="nx">CHILD</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">match</span><span class="p">){</span>
			<span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="s1">&#39;only&#39;</span><span class="o">:</span>
				<span class="k">case</span> <span class="s1">&#39;first&#39;</span><span class="o">:</span>
					<span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">previousSibling</span><span class="p">)</span> <span class="p">)</span>  <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span> <span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;first&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
					<span class="nx">node</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">;</span>
				<span class="k">case</span> <span class="s1">&#39;last&#39;</span><span class="o">:</span>
					<span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">)</span> <span class="p">)</span>  <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
				<span class="k">case</span> <span class="s1">&#39;nth&#39;</span><span class="o">:</span>
					<span class="kd">var</span> <span class="nx">first</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">last</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

					<span class="k">if</span> <span class="p">(</span> <span class="nx">first</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">last</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
						<span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="kd">var</span> <span class="nx">doneName</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
						<span class="nx">parent</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span> <span class="nx">parent</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">parent</span><span class="p">.</span><span class="nx">sizcache</span> <span class="o">!==</span> <span class="nx">doneName</span> <span class="o">||</span> <span class="o">!</span><span class="nx">elem</span><span class="p">.</span><span class="nx">nodeIndex</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
						<span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="k">for</span> <span class="p">(</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">;</span> <span class="nx">node</span><span class="p">;</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nextSibling</span> <span class="p">)</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
								<span class="nx">node</span><span class="p">.</span><span class="nx">nodeIndex</span> <span class="o">=</span> <span class="o">++</span><span class="nx">count</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="p">}</span>
						<span class="nx">parent</span><span class="p">.</span><span class="nx">sizcache</span> <span class="o">=</span> <span class="nx">doneName</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="kd">var</span> <span class="nx">diff</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">nodeIndex</span> <span class="o">-</span> <span class="nx">last</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span> <span class="nx">first</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
						<span class="k">return</span> <span class="nx">diff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="k">return</span> <span class="p">(</span> <span class="nx">diff</span> <span class="o">%</span> <span class="nx">first</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">diff</span> <span class="o">/</span> <span class="nx">first</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">);</span>
					<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">},</span>
		<span class="nx">ID</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">match</span><span class="p">){</span>
			<span class="k">return</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">match</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">TAG</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">match</span><span class="p">){</span>
			<span class="k">return</span> <span class="p">(</span><span class="nx">match</span> <span class="o">===</span> <span class="s2">&quot;*&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">===</span> <span class="nx">match</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">CLASS</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">match</span><span class="p">){</span>
			<span class="k">return</span> <span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">className</span> <span class="o">||</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span> <span class="nx">match</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">ATTR</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">match</span><span class="p">){</span>
			<span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				<span class="nx">result</span> <span class="o">=</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">attrHandle</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">?</span>
					<span class="nx">Expr</span><span class="p">.</span><span class="nx">attrHandle</span><span class="p">[</span> <span class="nx">name</span> <span class="p">](</span> <span class="nx">elem</span> <span class="p">)</span> <span class="o">:</span>
					<span class="nx">elem</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span>
						<span class="nx">elem</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">:</span>
						<span class="nx">elem</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span> <span class="nx">name</span> <span class="p">),</span>
				<span class="nx">value</span> <span class="o">=</span> <span class="nx">result</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
				<span class="nx">type</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
				<span class="nx">check</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

			<span class="k">return</span> <span class="nx">result</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span>
				<span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;!=&quot;</span> <span class="o">:</span>
				<span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;=&quot;</span> <span class="o">?</span>
				<span class="nx">value</span> <span class="o">===</span> <span class="nx">check</span> <span class="o">:</span>
				<span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;*=&quot;</span> <span class="o">?</span>
				<span class="nx">value</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">check</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">:</span>
				<span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;~=&quot;</span> <span class="o">?</span>
				<span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">value</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">check</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">:</span>
				<span class="o">!</span><span class="nx">check</span> <span class="o">?</span>
				<span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="nx">result</span> <span class="o">!==</span> <span class="kc">false</span> <span class="o">:</span>
				<span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;!=&quot;</span> <span class="o">?</span>
				<span class="nx">value</span> <span class="o">!=</span> <span class="nx">check</span> <span class="o">:</span>
				<span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;^=&quot;</span> <span class="o">?</span>
				<span class="nx">value</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">check</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">:</span>
				<span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;$=&quot;</span> <span class="o">?</span>
				<span class="nx">value</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">check</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">===</span> <span class="nx">check</span> <span class="o">:</span>
				<span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;|=&quot;</span> <span class="o">?</span>
				<span class="nx">value</span> <span class="o">===</span> <span class="nx">check</span> <span class="o">||</span> <span class="nx">value</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">check</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">===</span> <span class="nx">check</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">:</span>
				<span class="kc">false</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">POS</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">match</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">array</span><span class="p">){</span>
			<span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">filter</span> <span class="o">=</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">setFilters</span><span class="p">[</span> <span class="nx">name</span> <span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">filter</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">filter</span><span class="p">(</span> <span class="nx">elem</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">match</span><span class="p">,</span> <span class="nx">array</span> <span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">origPOS</span> <span class="o">=</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">match</span><span class="p">.</span><span class="nx">POS</span><span class="p">;</span>

<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">type</span> <span class="k">in</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">match</span> <span class="p">)</span> <span class="p">{</span>
	<span class="nx">Expr</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span> <span class="nx">type</span> <span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span> <span class="nx">type</span> <span class="p">].</span><span class="nx">source</span> <span class="o">+</span> <span class="sr">/(?![^\[]*\])(?![^\(]*\))/</span><span class="p">.</span><span class="nx">source</span> <span class="p">);</span>
	<span class="nx">Expr</span><span class="p">.</span><span class="nx">leftMatch</span><span class="p">[</span> <span class="nx">type</span> <span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span> <span class="sr">/(^(?:.|\r|\n)*?)/</span><span class="p">.</span><span class="nx">source</span> <span class="o">+</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span> <span class="nx">type</span> <span class="p">].</span><span class="nx">source</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">makeArray</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">array</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">array</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="nx">results</span> <span class="p">)</span> <span class="p">{</span>
		<span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">results</span><span class="p">,</span> <span class="nx">array</span> <span class="p">);</span>
		<span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">array</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">try</span> <span class="p">{</span>
	<span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

<span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
	<span class="nx">makeArray</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">results</span> <span class="o">||</span> <span class="p">[];</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">array</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;[object Array]&quot;</span> <span class="p">)</span> <span class="p">{</span>
			<span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">ret</span><span class="p">,</span> <span class="nx">array</span> <span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="s2">&quot;number&quot;</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">ret</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">ret</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">sortOrder</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">compareDocumentPosition</span> <span class="p">)</span> <span class="p">{</span>
	<span class="nx">sortOrder</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">a</span><span class="p">.</span><span class="nx">compareDocumentPosition</span> <span class="o">||</span> <span class="o">!</span><span class="nx">b</span><span class="p">.</span><span class="nx">compareDocumentPosition</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span> <span class="nx">a</span> <span class="o">==</span> <span class="nx">b</span> <span class="p">)</span> <span class="p">{</span>
				<span class="nx">hasDuplicate</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">compareDocumentPosition</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">4</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="nx">a</span> <span class="o">===</span> <span class="nx">b</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span> <span class="nx">ret</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
			<span class="nx">hasDuplicate</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="s2">&quot;sourceIndex&quot;</span> <span class="k">in</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span> <span class="p">)</span> <span class="p">{</span>
	<span class="nx">sortOrder</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">a</span><span class="p">.</span><span class="nx">sourceIndex</span> <span class="o">||</span> <span class="o">!</span><span class="nx">b</span><span class="p">.</span><span class="nx">sourceIndex</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span> <span class="nx">a</span> <span class="o">==</span> <span class="nx">b</span> <span class="p">)</span> <span class="p">{</span>
				<span class="nx">hasDuplicate</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">sourceIndex</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">sourceIndex</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span> <span class="nx">ret</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
			<span class="nx">hasDuplicate</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createRange</span> <span class="p">)</span> <span class="p">{</span>
	<span class="nx">sortOrder</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">a</span><span class="p">.</span><span class="nx">ownerDocument</span> <span class="o">||</span> <span class="o">!</span><span class="nx">b</span><span class="p">.</span><span class="nx">ownerDocument</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span> <span class="nx">a</span> <span class="o">==</span> <span class="nx">b</span> <span class="p">)</span> <span class="p">{</span>
				<span class="nx">hasDuplicate</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="kd">var</span> <span class="nx">aRange</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">ownerDocument</span><span class="p">.</span><span class="nx">createRange</span><span class="p">(),</span> <span class="nx">bRange</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">ownerDocument</span><span class="p">.</span><span class="nx">createRange</span><span class="p">();</span>
		<span class="nx">aRange</span><span class="p">.</span><span class="nx">setStart</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="nx">aRange</span><span class="p">.</span><span class="nx">setEnd</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="nx">bRange</span><span class="p">.</span><span class="nx">setStart</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="nx">bRange</span><span class="p">.</span><span class="nx">setEnd</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">aRange</span><span class="p">.</span><span class="nx">compareBoundaryPoints</span><span class="p">(</span><span class="nx">Range</span><span class="p">.</span><span class="nx">START_TO_END</span><span class="p">,</span> <span class="nx">bRange</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span> <span class="nx">ret</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
			<span class="nx">hasDuplicate</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">}</span>

<span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
	<span class="kd">var</span> <span class="nx">form</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">),</span>
		<span class="nx">id</span> <span class="o">=</span> <span class="s2">&quot;script&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">).</span><span class="nx">getTime</span><span class="p">();</span>
	<span class="nx">form</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&lt;a name=&#39;&quot;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot;&#39;/&gt;&quot;</span><span class="p">;</span>

	<span class="kd">var</span> <span class="nx">root</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">;</span>
	<span class="nx">root</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span> <span class="nx">form</span><span class="p">,</span> <span class="nx">root</span><span class="p">.</span><span class="nx">firstChild</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="o">!!</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span> <span class="nx">id</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="nx">Expr</span><span class="p">.</span><span class="nx">find</span><span class="p">.</span><span class="nx">ID</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">isXML</span><span class="p">){</span>
			<span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">context</span><span class="p">.</span><span class="nx">getElementById</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isXML</span> <span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
				<span class="k">return</span> <span class="nx">m</span> <span class="o">?</span> <span class="nx">m</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">m</span><span class="p">.</span><span class="nx">getAttributeNode</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">m</span><span class="p">.</span><span class="nx">getAttributeNode</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">).</span><span class="nx">nodeValue</span> <span class="o">===</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">?</span> <span class="p">[</span><span class="nx">m</span><span class="p">]</span> <span class="o">:</span> <span class="kc">undefined</span> <span class="o">:</span> <span class="p">[];</span>
			<span class="p">}</span>
		<span class="p">};</span>

		<span class="nx">Expr</span><span class="p">.</span><span class="nx">filter</span><span class="p">.</span><span class="nx">ID</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">match</span><span class="p">){</span>
			<span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">getAttributeNode</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">getAttributeNode</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeValue</span> <span class="o">===</span> <span class="nx">match</span><span class="p">;</span>
		<span class="p">};</span>
	<span class="p">}</span>

	<span class="nx">root</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span> <span class="nx">form</span> <span class="p">);</span>
	<span class="nx">root</span> <span class="o">=</span> <span class="nx">form</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// release memory in IE</span>
<span class="p">})();</span>

<span class="p">(</span><span class="kd">function</span><span class="p">(){</span>

	<span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">);</span>
	<span class="nx">div</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createComment</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="nx">div</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
		<span class="nx">Expr</span><span class="p">.</span><span class="nx">find</span><span class="p">.</span><span class="nx">TAG</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">context</span><span class="p">){</span>
			<span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;*&quot;</span> <span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">tmp</span> <span class="o">=</span> <span class="p">[];</span>

				<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span> <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
						<span class="nx">tmp</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="nx">results</span> <span class="o">=</span> <span class="nx">tmp</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
		<span class="p">};</span>
	<span class="p">}</span>

	<span class="nx">div</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&lt;a href=&#39;#&#39;&gt;&lt;/a&gt;&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span> <span class="nx">div</span><span class="p">.</span><span class="nx">firstChild</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">div</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">.</span><span class="nx">getAttribute</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">&amp;&amp;</span>
			<span class="nx">div</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span> <span class="o">!==</span> <span class="s2">&quot;#&quot;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="nx">Expr</span><span class="p">.</span><span class="nx">attrHandle</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
			<span class="k">return</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">};</span>
	<span class="p">}</span>

	<span class="nx">div</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// release memory in IE</span>
<span class="p">})();</span>

<span class="k">if</span> <span class="p">(</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span> <span class="p">)</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
	<span class="kd">var</span> <span class="nx">oldSizzle</span> <span class="o">=</span> <span class="nx">Sizzle</span><span class="p">,</span> <span class="nx">div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">);</span>
	<span class="nx">div</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&lt;p class=&#39;TEST&#39;&gt;&lt;/p&gt;&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="nx">div</span><span class="p">.</span><span class="nx">querySelectorAll</span> <span class="o">&amp;&amp;</span> <span class="nx">div</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s2">&quot;.TEST&quot;</span><span class="p">).</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nx">Sizzle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">extra</span><span class="p">,</span> <span class="nx">seed</span><span class="p">){</span>
		<span class="nx">context</span> <span class="o">=</span> <span class="nx">context</span> <span class="o">||</span> <span class="nb">document</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">seed</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">9</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isXML</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">try</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">makeArray</span><span class="p">(</span> <span class="nx">context</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="nx">query</span><span class="p">),</span> <span class="nx">extra</span> <span class="p">);</span>
			<span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="nx">oldSizzle</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">extra</span><span class="p">,</span> <span class="nx">seed</span><span class="p">);</span>
	<span class="p">};</span>

	<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">oldSizzle</span> <span class="p">)</span> <span class="p">{</span>
		<span class="nx">Sizzle</span><span class="p">[</span> <span class="nx">prop</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">oldSizzle</span><span class="p">[</span> <span class="nx">prop</span> <span class="p">];</span>
	<span class="p">}</span>

	<span class="nx">div</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// release memory in IE</span>
<span class="p">})();</span>

<span class="k">if</span> <span class="p">(</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByClassName</span> <span class="o">&amp;&amp;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">getElementsByClassName</span> <span class="p">)</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
	<span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">);</span>
	<span class="nx">div</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&lt;div class=&#39;test e&#39;&gt;&lt;/div&gt;&lt;div class=&#39;test&#39;&gt;&lt;/div&gt;&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="nx">div</span><span class="p">.</span><span class="nx">getElementsByClassName</span><span class="p">(</span><span class="s2">&quot;e&quot;</span><span class="p">).</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="nx">div</span><span class="p">.</span><span class="nx">lastChild</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s2">&quot;e&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="nx">div</span><span class="p">.</span><span class="nx">getElementsByClassName</span><span class="p">(</span><span class="s2">&quot;e&quot;</span><span class="p">).</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="nx">Expr</span><span class="p">.</span><span class="nx">order</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;CLASS&quot;</span><span class="p">);</span>
	<span class="nx">Expr</span><span class="p">.</span><span class="nx">find</span><span class="p">.</span><span class="nx">CLASS</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">isXML</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">context</span><span class="p">.</span><span class="nx">getElementsByClassName</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isXML</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">getElementsByClassName</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">};</span>

	<span class="nx">div</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// release memory in IE</span>
<span class="p">})();</span>

<span class="kd">function</span> <span class="nx">dirNodeCheck</span><span class="p">(</span> <span class="nx">dir</span><span class="p">,</span> <span class="nx">cur</span><span class="p">,</span> <span class="nx">doneName</span><span class="p">,</span> <span class="nx">checkSet</span><span class="p">,</span> <span class="nx">nodeCheck</span><span class="p">,</span> <span class="nx">isXML</span> <span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">sibDir</span> <span class="o">=</span> <span class="nx">dir</span> <span class="o">==</span> <span class="s2">&quot;previousSibling&quot;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isXML</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">checkSet</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">elem</span> <span class="o">=</span> <span class="nx">checkSet</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span> <span class="nx">elem</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span> <span class="nx">sibDir</span> <span class="o">&amp;&amp;</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">){</span>
				<span class="nx">elem</span><span class="p">.</span><span class="nx">sizcache</span> <span class="o">=</span> <span class="nx">doneName</span><span class="p">;</span>
				<span class="nx">elem</span><span class="p">.</span><span class="nx">sizset</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="nx">elem</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">[</span><span class="nx">dir</span><span class="p">];</span>
			<span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">(</span> <span class="nx">elem</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">sizcache</span> <span class="o">===</span> <span class="nx">doneName</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">match</span> <span class="o">=</span> <span class="nx">checkSet</span><span class="p">[</span><span class="nx">elem</span><span class="p">.</span><span class="nx">sizset</span><span class="p">];</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isXML</span> <span class="p">){</span>
					<span class="nx">elem</span><span class="p">.</span><span class="nx">sizcache</span> <span class="o">=</span> <span class="nx">doneName</span><span class="p">;</span>
					<span class="nx">elem</span><span class="p">.</span><span class="nx">sizset</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">===</span> <span class="nx">cur</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">match</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="nx">elem</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">[</span><span class="nx">dir</span><span class="p">];</span>
			<span class="p">}</span>

			<span class="nx">checkSet</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">match</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">dirCheck</span><span class="p">(</span> <span class="nx">dir</span><span class="p">,</span> <span class="nx">cur</span><span class="p">,</span> <span class="nx">doneName</span><span class="p">,</span> <span class="nx">checkSet</span><span class="p">,</span> <span class="nx">nodeCheck</span><span class="p">,</span> <span class="nx">isXML</span> <span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">sibDir</span> <span class="o">=</span> <span class="nx">dir</span> <span class="o">==</span> <span class="s2">&quot;previousSibling&quot;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isXML</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">checkSet</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">elem</span> <span class="o">=</span> <span class="nx">checkSet</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span> <span class="nx">elem</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span> <span class="nx">sibDir</span> <span class="o">&amp;&amp;</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
				<span class="nx">elem</span><span class="p">.</span><span class="nx">sizcache</span> <span class="o">=</span> <span class="nx">doneName</span><span class="p">;</span>
				<span class="nx">elem</span><span class="p">.</span><span class="nx">sizset</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="nx">elem</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">[</span><span class="nx">dir</span><span class="p">];</span>
			<span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">(</span> <span class="nx">elem</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">sizcache</span> <span class="o">===</span> <span class="nx">doneName</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">match</span> <span class="o">=</span> <span class="nx">checkSet</span><span class="p">[</span><span class="nx">elem</span><span class="p">.</span><span class="nx">sizset</span><span class="p">];</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">isXML</span> <span class="p">)</span> <span class="p">{</span>
						<span class="nx">elem</span><span class="p">.</span><span class="nx">sizcache</span> <span class="o">=</span> <span class="nx">doneName</span><span class="p">;</span>
						<span class="nx">elem</span><span class="p">.</span><span class="nx">sizset</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">cur</span> <span class="o">!==</span> <span class="s2">&quot;string&quot;</span> <span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span> <span class="nx">elem</span> <span class="o">===</span> <span class="nx">cur</span> <span class="p">)</span> <span class="p">{</span>
							<span class="nx">match</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Sizzle</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span> <span class="nx">cur</span><span class="p">,</span> <span class="p">[</span><span class="nx">elem</span><span class="p">]</span> <span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
						<span class="nx">match</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="nx">elem</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">[</span><span class="nx">dir</span><span class="p">];</span>
			<span class="p">}</span>

			<span class="nx">checkSet</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">match</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">contains</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">compareDocumentPosition</span> <span class="o">?</span>  <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">){</span>
	<span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">compareDocumentPosition</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">16</span><span class="p">;</span>
<span class="p">}</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">){</span>
	<span class="k">return</span> <span class="nx">a</span> <span class="o">!==</span> <span class="nx">b</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">contains</span> <span class="o">?</span> <span class="nx">a</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">:</span> <span class="kc">true</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">isXML</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
	<span class="k">return</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">9</span> <span class="o">&amp;&amp;</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">!==</span> <span class="s2">&quot;HTML&quot;</span> <span class="o">||</span>
		<span class="o">!!</span><span class="nx">elem</span><span class="p">.</span><span class="nx">ownerDocument</span> <span class="o">&amp;&amp;</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">ownerDocument</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">!==</span> <span class="s2">&quot;HTML&quot;</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">posProcess</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span> <span class="nx">context</span><span class="p">){</span>
	<span class="kd">var</span> <span class="nx">tmpSet</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">later</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">match</span><span class="p">,</span>
		<span class="nx">root</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">?</span> <span class="p">[</span><span class="nx">context</span><span class="p">]</span> <span class="o">:</span> <span class="nx">context</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="nx">match</span> <span class="o">=</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">match</span><span class="p">.</span><span class="nx">PSEUDO</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span> <span class="nx">selector</span> <span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
		<span class="nx">later</span> <span class="o">+=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="nx">selector</span> <span class="o">=</span> <span class="nx">selector</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">match</span><span class="p">.</span><span class="nx">PSEUDO</span><span class="p">,</span> <span class="s2">&quot;&quot;</span> <span class="p">);</span>
	<span class="p">}</span>

	<span class="nx">selector</span> <span class="o">=</span> <span class="nx">Expr</span><span class="p">.</span><span class="nx">relative</span><span class="p">[</span><span class="nx">selector</span><span class="p">]</span> <span class="o">?</span> <span class="nx">selector</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span> <span class="o">:</span> <span class="nx">selector</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
		<span class="nx">Sizzle</span><span class="p">(</span> <span class="nx">selector</span><span class="p">,</span> <span class="nx">root</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">tmpSet</span> <span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">Sizzle</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span> <span class="nx">later</span><span class="p">,</span> <span class="nx">tmpSet</span> <span class="p">);</span>
<span class="p">};</span>


<span class="nb">window</span><span class="p">.</span><span class="nx">Sizzle</span> <span class="o">=</span> <span class="nx">Sizzle</span><span class="p">;</span>

<span class="p">})();</span>

<span class="p">;(</span><span class="kd">function</span><span class="p">(</span><span class="nx">engine</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">extendElements</span> <span class="o">=</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">Selector</span><span class="p">.</span><span class="nx">extendElements</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">select</span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span> <span class="nx">scope</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">extendElements</span><span class="p">(</span><span class="nx">engine</span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span> <span class="nx">scope</span> <span class="o">||</span> <span class="nb">document</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">match</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">selector</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">matches</span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span> <span class="p">[</span><span class="nx">element</span><span class="p">]).</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">Prototype</span><span class="p">.</span><span class="nx">Selector</span><span class="p">.</span><span class="nx">engine</span> <span class="o">=</span> <span class="nx">engine</span><span class="p">;</span>
  <span class="nx">Prototype</span><span class="p">.</span><span class="nx">Selector</span><span class="p">.</span><span class="nx">select</span> <span class="o">=</span> <span class="nx">select</span><span class="p">;</span>
  <span class="nx">Prototype</span><span class="p">.</span><span class="nx">Selector</span><span class="p">.</span><span class="nx">match</span> <span class="o">=</span> <span class="nx">match</span><span class="p">;</span>
<span class="p">})(</span><span class="nx">Sizzle</span><span class="p">);</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">Sizzle</span> <span class="o">=</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">_original_property</span><span class="p">;</span>
<span class="k">delete</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">_original_property</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">Form</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">reset</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">form</span><span class="p">);</span>
    <span class="nx">form</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">form</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">serializeElements</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elements</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span> <span class="o">!=</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">hash</span><span class="o">:</span> <span class="o">!!</span><span class="nx">options</span> <span class="p">};</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">hash</span><span class="p">))</span> <span class="nx">options</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">submitted</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">submit</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">submit</span><span class="p">,</span> <span class="nx">accumulator</span><span class="p">,</span> <span class="nx">initial</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">initial</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="nx">accumulator</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">]))</span> <span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">]];</span>
          <span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
      <span class="p">};</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">initial</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="nx">accumulator</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">result</span> <span class="o">+</span> <span class="p">(</span><span class="nx">result</span> <span class="o">?</span> <span class="s1">&#39;&amp;&#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">elements</span><span class="p">.</span><span class="nx">inject</span><span class="p">(</span><span class="nx">initial</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">element</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">&amp;&amp;</span> <span class="nx">element</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">key</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">getValue</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">element</span><span class="p">.</span><span class="nx">type</span> <span class="o">!=</span> <span class="s1">&#39;file&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">type</span> <span class="o">!=</span> <span class="s1">&#39;submit&#39;</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="nx">submitted</span> <span class="o">&amp;&amp;</span>
            <span class="nx">submit</span> <span class="o">!==</span> <span class="kc">false</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nx">submit</span> <span class="o">||</span> <span class="nx">key</span> <span class="o">==</span> <span class="nx">submit</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">submitted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">))))</span> <span class="p">{</span>
          <span class="nx">result</span> <span class="o">=</span> <span class="nx">accumulator</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">Form</span><span class="p">.</span><span class="nx">Methods</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">serialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">form</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Form</span><span class="p">.</span><span class="nx">serializeElements</span><span class="p">(</span><span class="nx">Form</span><span class="p">.</span><span class="nx">getElements</span><span class="p">(</span><span class="nx">form</span><span class="p">),</span> <span class="nx">options</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">getElements</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">elements</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">form</span><span class="p">).</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">),</span>
        <span class="nx">element</span><span class="p">,</span>
        <span class="nx">arr</span> <span class="o">=</span> <span class="p">[</span> <span class="p">],</span>
        <span class="nx">serializers</span> <span class="o">=</span> <span class="nx">Form</span><span class="p">.</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Serializers</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">elements</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">arr</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">inject</span><span class="p">([],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elements</span><span class="p">,</span> <span class="nx">child</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">serializers</span><span class="p">[</span><span class="nx">child</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()])</span>
        <span class="nx">elements</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">child</span><span class="p">));</span>
      <span class="k">return</span> <span class="nx">elements</span><span class="p">;</span>
    <span class="p">})</span>
  <span class="p">},</span>

  <span class="nx">getInputs</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">form</span><span class="p">,</span> <span class="nx">typeName</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">form</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">inputs</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">typeName</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">name</span><span class="p">)</span> <span class="k">return</span> <span class="nx">$A</span><span class="p">(</span><span class="nx">inputs</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">extend</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">matchingInputs</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">inputs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">input</span> <span class="o">=</span> <span class="nx">inputs</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">((</span><span class="nx">typeName</span> <span class="o">&amp;&amp;</span> <span class="nx">input</span><span class="p">.</span><span class="nx">type</span> <span class="o">!=</span> <span class="nx">typeName</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">name</span> <span class="o">&amp;&amp;</span> <span class="nx">input</span><span class="p">.</span><span class="nx">name</span> <span class="o">!=</span> <span class="nx">name</span><span class="p">))</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="nx">matchingInputs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">input</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">matchingInputs</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">disable</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">form</span><span class="p">);</span>
    <span class="nx">Form</span><span class="p">.</span><span class="nx">getElements</span><span class="p">(</span><span class="nx">form</span><span class="p">).</span><span class="nx">invoke</span><span class="p">(</span><span class="s1">&#39;disable&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">form</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">enable</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">form</span><span class="p">);</span>
    <span class="nx">Form</span><span class="p">.</span><span class="nx">getElements</span><span class="p">(</span><span class="nx">form</span><span class="p">).</span><span class="nx">invoke</span><span class="p">(</span><span class="s1">&#39;enable&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">form</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">findFirstElement</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">elements</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">form</span><span class="p">).</span><span class="nx">getElements</span><span class="p">().</span><span class="nx">findAll</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s1">&#39;hidden&#39;</span> <span class="o">!=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">type</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">element</span><span class="p">.</span><span class="nx">disabled</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">firstByIndex</span> <span class="o">=</span> <span class="nx">elements</span><span class="p">.</span><span class="nx">findAll</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">element</span><span class="p">.</span><span class="nx">hasAttribute</span><span class="p">(</span><span class="s1">&#39;tabIndex&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">element</span><span class="p">.</span><span class="nx">tabIndex</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}).</span><span class="nx">sortBy</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">element</span><span class="p">.</span><span class="nx">tabIndex</span> <span class="p">}).</span><span class="nx">first</span><span class="p">();</span>

    <span class="k">return</span> <span class="nx">firstByIndex</span> <span class="o">?</span> <span class="nx">firstByIndex</span> <span class="o">:</span> <span class="nx">elements</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="sr">/^(?:input|select|textarea)$/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">tagName</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">},</span>

  <span class="nx">focusFirstElement</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">form</span><span class="p">);</span>
    <span class="nx">form</span><span class="p">.</span><span class="nx">findFirstElement</span><span class="p">().</span><span class="nx">activate</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">form</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">request</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">form</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">form</span><span class="p">),</span> <span class="nx">options</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">options</span> <span class="o">||</span> <span class="p">{</span> <span class="p">});</span>

    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">parameters</span><span class="p">,</span> <span class="nx">action</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">readAttribute</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">blank</span><span class="p">())</span> <span class="nx">action</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">parameters</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">params</span><span class="p">))</span> <span class="nx">params</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">toQueryParams</span><span class="p">();</span>
      <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">parameters</span><span class="p">,</span> <span class="nx">params</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">form</span><span class="p">.</span><span class="nx">hasAttribute</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">method</span><span class="p">)</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">method</span><span class="p">;</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nx">Ajax</span><span class="p">.</span><span class="nx">Request</span><span class="p">(</span><span class="nx">action</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*--------------------------------------------------------------------------*/</span>


<span class="nx">Form</span><span class="p">.</span><span class="nx">Element</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">focus</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">focus</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">select</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">select</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">Form</span><span class="p">.</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span> <span class="o">=</span> <span class="p">{</span>

  <span class="nx">serialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">element</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">&amp;&amp;</span> <span class="nx">element</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getValue</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">!=</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">pair</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
        <span class="nx">pair</span><span class="p">[</span><span class="nx">element</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">toQueryString</span><span class="p">(</span><span class="nx">pair</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">getValue</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">method</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">Form</span><span class="p">.</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Serializers</span><span class="p">[</span><span class="nx">method</span><span class="p">](</span><span class="nx">element</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">setValue</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">method</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
    <span class="nx">Form</span><span class="p">.</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Serializers</span><span class="p">[</span><span class="nx">method</span><span class="p">](</span><span class="nx">element</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">clear</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">present</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">value</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">activate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">select</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;input&#39;</span> <span class="o">||</span>
          <span class="o">!</span><span class="p">(</span><span class="sr">/^(?:button|reset|submit)$/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">type</span><span class="p">))))</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">select</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">disable</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">enable</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*--------------------------------------------------------------------------*/</span>

<span class="kd">var</span> <span class="nx">Field</span> <span class="o">=</span> <span class="nx">Form</span><span class="p">.</span><span class="nx">Element</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">$F</span> <span class="o">=</span> <span class="nx">Form</span><span class="p">.</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">getValue</span><span class="p">;</span>

<span class="cm">/*--------------------------------------------------------------------------*/</span>

<span class="nx">Form</span><span class="p">.</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Serializers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">input</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s1">&#39;checkbox&#39;</span><span class="o">:</span>
      <span class="k">case</span> <span class="s1">&#39;radio&#39;</span><span class="o">:</span>
        <span class="k">return</span> <span class="nx">Form</span><span class="p">.</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Serializers</span><span class="p">.</span><span class="nx">inputSelector</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
      <span class="k">default</span><span class="o">:</span>
        <span class="k">return</span> <span class="nx">Form</span><span class="p">.</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Serializers</span><span class="p">.</span><span class="nx">textarea</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">inputSelector</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="k">return</span> <span class="nx">element</span><span class="p">.</span><span class="nx">checked</span> <span class="o">?</span> <span class="nx">element</span><span class="p">.</span><span class="nx">value</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">else</span> <span class="nx">element</span><span class="p">.</span><span class="nx">checked</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">value</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">textarea</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="k">return</span> <span class="nx">element</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="k">else</span> <span class="nx">element</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">select</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">[</span><span class="nx">element</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;select-one&#39;</span> <span class="o">?</span>
        <span class="s1">&#39;selectOne&#39;</span> <span class="o">:</span> <span class="s1">&#39;selectMany&#39;</span><span class="p">](</span><span class="nx">element</span><span class="p">);</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">opt</span><span class="p">,</span> <span class="nx">currentValue</span><span class="p">,</span> <span class="nx">single</span> <span class="o">=</span> <span class="o">!</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">opt</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">currentValue</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">optionValue</span><span class="p">(</span><span class="nx">opt</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">single</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">currentValue</span> <span class="o">==</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">opt</span><span class="p">.</span><span class="nx">selected</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="k">return</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">selected</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="nx">currentValue</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">selectOne</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">selectedIndex</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">optionValue</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="nx">index</span><span class="p">])</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">selectMany</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">values</span> <span class="o">=</span> <span class="p">[];</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">opt</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">opt</span><span class="p">.</span><span class="nx">selected</span><span class="p">)</span> <span class="nx">values</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">optionValue</span><span class="p">(</span><span class="nx">opt</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">values</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">optionValue</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">opt</span><span class="p">).</span><span class="nx">hasAttribute</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">value</span> <span class="o">:</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">text</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*--------------------------------------------------------------------------*/</span>


<span class="nx">Abstract</span><span class="p">.</span><span class="nx">TimedObserver</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">PeriodicalExecuter</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$super</span><span class="p">,</span> <span class="nx">element</span><span class="p">,</span> <span class="nx">frequency</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$super</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">frequency</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">element</span>   <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">lastValue</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getValue</span><span class="p">();</span>
  <span class="p">},</span>

  <span class="nx">execute</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getValue</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lastValue</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">?</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">lastValue</span> <span class="o">!=</span> <span class="nx">value</span> <span class="o">:</span> <span class="nb">String</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lastValue</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">String</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">callback</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">lastValue</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Form</span><span class="p">.</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Observer</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">Abstract</span><span class="p">.</span><span class="nx">TimedObserver</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">getValue</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Form</span><span class="p">.</span><span class="nx">Element</span><span class="p">.</span><span class="nx">getValue</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Form</span><span class="p">.</span><span class="nx">Observer</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">Abstract</span><span class="p">.</span><span class="nx">TimedObserver</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">getValue</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="cm">/*--------------------------------------------------------------------------*/</span>

<span class="nx">Abstract</span><span class="p">.</span><span class="nx">EventObserver</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">element</span>  <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">callback</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">lastValue</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getValue</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;form&#39;</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">registerFormCallbacks</span><span class="p">();</span>
    <span class="k">else</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">registerCallback</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">onElementEvent</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getValue</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lastValue</span> <span class="o">!=</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">callback</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">lastValue</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">registerFormCallbacks</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">Form</span><span class="p">.</span><span class="nx">getElements</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">registerCallback</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">registerCallback</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">switch</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">case</span> <span class="s1">&#39;checkbox&#39;</span><span class="o">:</span>
        <span class="k">case</span> <span class="s1">&#39;radio&#39;</span><span class="o">:</span>
          <span class="nx">Event</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">onElementEvent</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
          <span class="nx">Event</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">onElementEvent</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Form</span><span class="p">.</span><span class="nx">Element</span><span class="p">.</span><span class="nx">EventObserver</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">Abstract</span><span class="p">.</span><span class="nx">EventObserver</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">getValue</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Form</span><span class="p">.</span><span class="nx">Element</span><span class="p">.</span><span class="nx">getValue</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Form</span><span class="p">.</span><span class="nx">EventObserver</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">Abstract</span><span class="p">.</span><span class="nx">EventObserver</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">getValue</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">Event</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">KEY_BACKSPACE</span><span class="o">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="nx">KEY_TAB</span><span class="o">:</span>       <span class="mi">9</span><span class="p">,</span>
    <span class="nx">KEY_RETURN</span><span class="o">:</span>   <span class="mi">13</span><span class="p">,</span>
    <span class="nx">KEY_ESC</span><span class="o">:</span>      <span class="mi">27</span><span class="p">,</span>
    <span class="nx">KEY_LEFT</span><span class="o">:</span>     <span class="mi">37</span><span class="p">,</span>
    <span class="nx">KEY_UP</span><span class="o">:</span>       <span class="mi">38</span><span class="p">,</span>
    <span class="nx">KEY_RIGHT</span><span class="o">:</span>    <span class="mi">39</span><span class="p">,</span>
    <span class="nx">KEY_DOWN</span><span class="o">:</span>     <span class="mi">40</span><span class="p">,</span>
    <span class="nx">KEY_DELETE</span><span class="o">:</span>   <span class="mi">46</span><span class="p">,</span>
    <span class="nx">KEY_HOME</span><span class="o">:</span>     <span class="mi">36</span><span class="p">,</span>
    <span class="nx">KEY_END</span><span class="o">:</span>      <span class="mi">35</span><span class="p">,</span>
    <span class="nx">KEY_PAGEUP</span><span class="o">:</span>   <span class="mi">33</span><span class="p">,</span>
    <span class="nx">KEY_PAGEDOWN</span><span class="o">:</span> <span class="mi">34</span><span class="p">,</span>
    <span class="nx">KEY_INSERT</span><span class="o">:</span>   <span class="mi">45</span><span class="p">,</span>

    <span class="nx">cache</span><span class="o">:</span> <span class="p">{}</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">docEl</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">MOUSEENTER_MOUSELEAVE_EVENTS_SUPPORTED</span> <span class="o">=</span> <span class="s1">&#39;onmouseenter&#39;</span> <span class="k">in</span> <span class="nx">docEl</span>
    <span class="o">&amp;&amp;</span> <span class="s1">&#39;onmouseleave&#39;</span> <span class="k">in</span> <span class="nx">docEl</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">IE_LEGACY_EVENT_SYSTEM</span> <span class="o">=</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">attachEvent</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">_isButton</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">IE_LEGACY_EVENT_SYSTEM</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">buttonMap</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="o">:</span> <span class="mi">2</span> <span class="p">};</span>
    <span class="nx">_isButton</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">event</span><span class="p">.</span><span class="nx">button</span> <span class="o">===</span> <span class="nx">buttonMap</span><span class="p">[</span><span class="nx">code</span><span class="p">];</span>
    <span class="p">};</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">Prototype</span><span class="p">.</span><span class="nx">Browser</span><span class="p">.</span><span class="nx">WebKit</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">_isButton</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">switch</span> <span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span> <span class="k">return</span> <span class="nx">event</span><span class="p">.</span><span class="nx">which</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">event</span><span class="p">.</span><span class="nx">metaKey</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="k">return</span> <span class="nx">event</span><span class="p">.</span><span class="nx">which</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">event</span><span class="p">.</span><span class="nx">metaKey</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">_isButton</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">event</span><span class="p">.</span><span class="nx">which</span> <span class="o">?</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">which</span> <span class="o">===</span> <span class="nx">code</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">button</span> <span class="o">===</span> <span class="nx">code</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">isLeftClick</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span>   <span class="p">{</span> <span class="k">return</span> <span class="nx">_isButton</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">isMiddleClick</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">_isButton</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">isRightClick</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span>  <span class="p">{</span> <span class="k">return</span> <span class="nx">_isButton</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">element</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">event</span> <span class="o">=</span> <span class="nx">Event</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span>
     <span class="nx">currentTarget</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">currentTarget</span> <span class="o">&amp;&amp;</span> <span class="nx">currentTarget</span><span class="p">.</span><span class="nx">tagName</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;load&#39;</span> <span class="o">||</span> <span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;error&#39;</span> <span class="o">||</span>
        <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;click&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">currentTarget</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;input&#39;</span>
          <span class="o">&amp;&amp;</span> <span class="nx">currentTarget</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;radio&#39;</span><span class="p">))</span>
            <span class="nx">node</span> <span class="o">=</span> <span class="nx">currentTarget</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">==</span> <span class="nx">Node</span><span class="p">.</span><span class="nx">TEXT_NODE</span><span class="p">)</span>
      <span class="nx">node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">findElement</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">expression</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">Event</span><span class="p">.</span><span class="nx">element</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">expression</span><span class="p">)</span> <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isElement</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">Selector</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">expression</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">element</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">pointer</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">pointerX</span><span class="p">(</span><span class="nx">event</span><span class="p">),</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">pointerY</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">pointerX</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">docElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">,</span>
     <span class="nx">body</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span> <span class="o">||</span> <span class="p">{</span> <span class="nx">scrollLeft</span><span class="o">:</span> <span class="mi">0</span> <span class="p">};</span>

    <span class="k">return</span> <span class="nx">event</span><span class="p">.</span><span class="nx">pageX</span> <span class="o">||</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">clientX</span> <span class="o">+</span>
      <span class="p">(</span><span class="nx">docElement</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">||</span> <span class="nx">body</span><span class="p">.</span><span class="nx">scrollLeft</span><span class="p">)</span> <span class="o">-</span>
      <span class="p">(</span><span class="nx">docElement</span><span class="p">.</span><span class="nx">clientLeft</span> <span class="o">||</span> <span class="mi">0</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">pointerY</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">docElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">,</span>
     <span class="nx">body</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span> <span class="o">||</span> <span class="p">{</span> <span class="nx">scrollTop</span><span class="o">:</span> <span class="mi">0</span> <span class="p">};</span>

    <span class="k">return</span>  <span class="nx">event</span><span class="p">.</span><span class="nx">pageY</span> <span class="o">||</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">clientY</span> <span class="o">+</span>
       <span class="p">(</span><span class="nx">docElement</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">||</span> <span class="nx">body</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">)</span> <span class="o">-</span>
       <span class="p">(</span><span class="nx">docElement</span><span class="p">.</span><span class="nx">clientTop</span> <span class="o">||</span> <span class="mi">0</span><span class="p">));</span>
  <span class="p">}</span>


  <span class="kd">function</span> <span class="nx">stop</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Event</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>

    <span class="nx">event</span><span class="p">.</span><span class="nx">stopped</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">Event</span><span class="p">.</span><span class="nx">Methods</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">isLeftClick</span><span class="o">:</span> <span class="nx">isLeftClick</span><span class="p">,</span>
    <span class="nx">isMiddleClick</span><span class="o">:</span> <span class="nx">isMiddleClick</span><span class="p">,</span>
    <span class="nx">isRightClick</span><span class="o">:</span> <span class="nx">isRightClick</span><span class="p">,</span>

    <span class="nx">element</span><span class="o">:</span> <span class="nx">element</span><span class="p">,</span>
    <span class="nx">findElement</span><span class="o">:</span> <span class="nx">findElement</span><span class="p">,</span>

    <span class="nx">pointer</span><span class="o">:</span> <span class="nx">pointer</span><span class="p">,</span>
    <span class="nx">pointerX</span><span class="o">:</span> <span class="nx">pointerX</span><span class="p">,</span>
    <span class="nx">pointerY</span><span class="o">:</span> <span class="nx">pointerY</span><span class="p">,</span>

    <span class="nx">stop</span><span class="o">:</span> <span class="nx">stop</span>
  <span class="p">};</span>


  <span class="kd">var</span> <span class="nx">methods</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">Event</span><span class="p">.</span><span class="nx">Methods</span><span class="p">).</span><span class="nx">inject</span><span class="p">({</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">m</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Event</span><span class="p">.</span><span class="nx">Methods</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">methodize</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">m</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">IE_LEGACY_EVENT_SYSTEM</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">_relatedTarget</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">element</span><span class="p">;</span>
      <span class="k">switch</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="s1">&#39;mouseover&#39;</span><span class="o">:</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">fromElement</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s1">&#39;mouseout&#39;</span><span class="o">:</span>  <span class="nx">element</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">toElement</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">methods</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">stopPropagation</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">cancelBubble</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">},</span>
      <span class="nx">preventDefault</span><span class="o">:</span>  <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">returnValue</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">},</span>
      <span class="nx">inspect</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="s1">&#39;[object Event]&#39;</span> <span class="p">}</span>
    <span class="p">});</span>

    <span class="nx">Event</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">event</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">_extendedByPrototype</span><span class="p">)</span> <span class="k">return</span> <span class="nx">event</span><span class="p">;</span>

      <span class="nx">event</span><span class="p">.</span><span class="nx">_extendedByPrototype</span> <span class="o">=</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">emptyFunction</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">pointer</span> <span class="o">=</span> <span class="nx">Event</span><span class="p">.</span><span class="nx">pointer</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>

      <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">target</span><span class="o">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">srcElement</span> <span class="o">||</span> <span class="nx">element</span><span class="p">,</span>
        <span class="nx">relatedTarget</span><span class="o">:</span> <span class="nx">_relatedTarget</span><span class="p">(</span><span class="nx">event</span><span class="p">),</span>
        <span class="nx">pageX</span><span class="o">:</span>  <span class="nx">pointer</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>
        <span class="nx">pageY</span><span class="o">:</span>  <span class="nx">pointer</span><span class="p">.</span><span class="nx">y</span>
      <span class="p">});</span>

      <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">methods</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">Event</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Event</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createEvent</span><span class="p">(</span><span class="s1">&#39;HTMLEvents&#39;</span><span class="p">).</span><span class="nx">__proto__</span><span class="p">;</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Event</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">methods</span><span class="p">);</span>
    <span class="nx">Event</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">K</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">_createResponder</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">registry</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">retrieve</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;prototype_event_registry&#39;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">registry</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">CACHE</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
      <span class="nx">registry</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">retrieve</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;prototype_event_registry&#39;</span><span class="p">,</span> <span class="nx">$H</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">respondersForEvent</span> <span class="o">=</span> <span class="nx">registry</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">eventName</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">respondersForEvent</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">respondersForEvent</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="nx">registry</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">eventName</span><span class="p">,</span> <span class="nx">respondersForEvent</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">respondersForEvent</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="s1">&#39;handler&#39;</span><span class="p">).</span><span class="nx">include</span><span class="p">(</span><span class="nx">handler</span><span class="p">))</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">responder</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">eventName</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">responder</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">eventName</span><span class="p">))</span>
          <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">eventName</span> <span class="o">!==</span> <span class="nx">eventName</span><span class="p">)</span>
          <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

        <span class="nx">Event</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">element</span><span class="p">);</span>
        <span class="nx">handler</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">event</span><span class="p">);</span>
      <span class="p">};</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">MOUSEENTER_MOUSELEAVE_EVENTS_SUPPORTED</span> <span class="o">&amp;&amp;</span>
       <span class="p">(</span><span class="nx">eventName</span> <span class="o">===</span> <span class="s2">&quot;mouseenter&quot;</span> <span class="o">||</span> <span class="nx">eventName</span> <span class="o">===</span> <span class="s2">&quot;mouseleave&quot;</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">eventName</span> <span class="o">===</span> <span class="s2">&quot;mouseenter&quot;</span> <span class="o">||</span> <span class="nx">eventName</span> <span class="o">===</span> <span class="s2">&quot;mouseleave&quot;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">responder</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">Event</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">element</span><span class="p">);</span>

            <span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">relatedTarget</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span><span class="nx">parent</span> <span class="o">&amp;&amp;</span> <span class="nx">parent</span> <span class="o">!==</span> <span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">try</span> <span class="p">{</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span> <span class="p">}</span>
              <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">element</span><span class="p">;</span> <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">parent</span> <span class="o">===</span> <span class="nx">element</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

            <span class="nx">handler</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">event</span><span class="p">);</span>
          <span class="p">};</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">responder</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">Event</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">element</span><span class="p">);</span>
          <span class="nx">handler</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">event</span><span class="p">);</span>
        <span class="p">};</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">responder</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="nx">handler</span><span class="p">;</span>
    <span class="nx">respondersForEvent</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">responder</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">responder</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">_destroyCache</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">CACHE</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">Event</span><span class="p">.</span><span class="nx">stopObserving</span><span class="p">(</span><span class="nx">CACHE</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="nx">CACHE</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">CACHE</span> <span class="o">=</span> <span class="p">[];</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">Prototype</span><span class="p">.</span><span class="nx">Browser</span><span class="p">.</span><span class="nx">IE</span><span class="p">)</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s1">&#39;onunload&#39;</span><span class="p">,</span> <span class="nx">_destroyCache</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">Prototype</span><span class="p">.</span><span class="nx">Browser</span><span class="p">.</span><span class="nx">WebKit</span><span class="p">)</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;unload&#39;</span><span class="p">,</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">emptyFunction</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>


  <span class="kd">var</span> <span class="nx">_getDOMEventName</span> <span class="o">=</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">K</span><span class="p">,</span>
      <span class="nx">translations</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">mouseenter</span><span class="o">:</span> <span class="s2">&quot;mouseover&quot;</span><span class="p">,</span> <span class="nx">mouseleave</span><span class="o">:</span> <span class="s2">&quot;mouseout&quot;</span> <span class="p">};</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">MOUSEENTER_MOUSELEAVE_EVENTS_SUPPORTED</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">_getDOMEventName</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">eventName</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="nx">translations</span><span class="p">[</span><span class="nx">eventName</span><span class="p">]</span> <span class="o">||</span> <span class="nx">eventName</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">observe</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">responder</span> <span class="o">=</span> <span class="nx">_createResponder</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">handler</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">responder</span><span class="p">)</span> <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">eventName</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">)</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;dataavailable&quot;</span><span class="p">,</span> <span class="nx">responder</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s2">&quot;ondataavailable&quot;</span><span class="p">,</span> <span class="nx">responder</span><span class="p">);</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s2">&quot;onlosecapture&quot;</span><span class="p">,</span> <span class="nx">responder</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">actualEventName</span> <span class="o">=</span> <span class="nx">_getDOMEventName</span><span class="p">(</span><span class="nx">eventName</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">)</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">actualEventName</span><span class="p">,</span> <span class="nx">responder</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="k">else</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s2">&quot;on&quot;</span> <span class="o">+</span> <span class="nx">actualEventName</span><span class="p">,</span> <span class="nx">responder</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">stopObserving</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">registry</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">retrieve</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;prototype_event_registry&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">registry</span><span class="p">)</span> <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">eventName</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">registry</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pair</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">eventName</span> <span class="o">=</span> <span class="nx">pair</span><span class="p">.</span><span class="nx">key</span><span class="p">;</span>
        <span class="nx">stopObserving</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">eventName</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">responders</span> <span class="o">=</span> <span class="nx">registry</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">eventName</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">responders</span><span class="p">)</span> <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">responders</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">stopObserving</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">handler</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">responder</span> <span class="o">=</span> <span class="nx">responders</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="nx">handler</span> <span class="o">===</span> <span class="nx">handler</span><span class="p">;</span> <span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">responder</span><span class="p">)</span> <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">eventName</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">)</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s2">&quot;dataavailable&quot;</span><span class="p">,</span> <span class="nx">responder</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">detachEvent</span><span class="p">(</span><span class="s2">&quot;ondataavailable&quot;</span><span class="p">,</span> <span class="nx">responder</span><span class="p">);</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">detachEvent</span><span class="p">(</span><span class="s2">&quot;onlosecapture&quot;</span><span class="p">,</span> <span class="nx">responder</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">actualEventName</span> <span class="o">=</span> <span class="nx">_getDOMEventName</span><span class="p">(</span><span class="nx">eventName</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">)</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">actualEventName</span><span class="p">,</span> <span class="nx">responder</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="k">else</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">detachEvent</span><span class="p">(</span><span class="s1">&#39;on&#39;</span> <span class="o">+</span> <span class="nx">actualEventName</span><span class="p">,</span> <span class="nx">responder</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">registry</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">eventName</span><span class="p">,</span> <span class="nx">responders</span><span class="p">.</span><span class="nx">without</span><span class="p">(</span><span class="nx">responder</span><span class="p">));</span>

    <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">fire</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">memo</span><span class="p">,</span> <span class="nx">bubble</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">bubble</span><span class="p">))</span>
      <span class="nx">bubble</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">element</span> <span class="o">==</span> <span class="nb">document</span> <span class="o">&amp;&amp;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createEvent</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">element</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">)</span>
      <span class="nx">element</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">event</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createEvent</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">event</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createEvent</span><span class="p">(</span><span class="s1">&#39;HTMLEvents&#39;</span><span class="p">);</span>
      <span class="nx">event</span><span class="p">.</span><span class="nx">initEvent</span><span class="p">(</span><span class="s1">&#39;dataavailable&#39;</span><span class="p">,</span> <span class="nx">bubble</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">event</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createEventObject</span><span class="p">();</span>
      <span class="nx">event</span><span class="p">.</span><span class="nx">eventType</span> <span class="o">=</span> <span class="nx">bubble</span> <span class="o">?</span> <span class="s1">&#39;ondataavailable&#39;</span> <span class="o">:</span> <span class="s1">&#39;onlosecapture&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">event</span><span class="p">.</span><span class="nx">eventName</span> <span class="o">=</span> <span class="nx">eventName</span><span class="p">;</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">memo</span> <span class="o">=</span> <span class="nx">memo</span> <span class="o">||</span> <span class="p">{</span> <span class="p">};</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createEvent</span><span class="p">)</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
    <span class="k">else</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">fireEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">eventType</span><span class="p">,</span> <span class="nx">event</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">Event</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">Event</span><span class="p">.</span><span class="nx">Handler</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">selector</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">element</span>   <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">eventName</span> <span class="o">=</span> <span class="nx">eventName</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">selector</span>  <span class="o">=</span> <span class="nx">selector</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">callback</span>  <span class="o">=</span> <span class="nx">callback</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">handler</span>   <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleEvent</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">Event</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">eventName</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">handler</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">stop</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">Event</span><span class="p">.</span><span class="nx">stopObserving</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">eventName</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">handler</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">handleEvent</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">selector</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">element</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="kd">function</span> <span class="nx">on</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">selector</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">callback</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">callback</span> <span class="o">=</span> <span class="nx">selector</span><span class="p">,</span> <span class="nx">selector</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nx">Event</span><span class="p">.</span><span class="nx">Handler</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">selector</span><span class="p">,</span> <span class="nx">callback</span><span class="p">).</span><span class="nx">start</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Event</span><span class="p">,</span> <span class="nx">Event</span><span class="p">.</span><span class="nx">Methods</span><span class="p">);</span>

  <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Event</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">fire</span><span class="o">:</span>          <span class="nx">fire</span><span class="p">,</span>
    <span class="nx">observe</span><span class="o">:</span>       <span class="nx">observe</span><span class="p">,</span>
    <span class="nx">stopObserving</span><span class="o">:</span> <span class="nx">stopObserving</span><span class="p">,</span>
    <span class="nx">on</span><span class="o">:</span>            <span class="nx">on</span>
  <span class="p">});</span>

  <span class="nx">Element</span><span class="p">.</span><span class="nx">addMethods</span><span class="p">({</span>
    <span class="nx">fire</span><span class="o">:</span>          <span class="nx">fire</span><span class="p">,</span>

    <span class="nx">observe</span><span class="o">:</span>       <span class="nx">observe</span><span class="p">,</span>

    <span class="nx">stopObserving</span><span class="o">:</span> <span class="nx">stopObserving</span><span class="p">,</span>

    <span class="nx">on</span><span class="o">:</span>            <span class="nx">on</span>
  <span class="p">});</span>

  <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">fire</span><span class="o">:</span>          <span class="nx">fire</span><span class="p">.</span><span class="nx">methodize</span><span class="p">(),</span>

    <span class="nx">observe</span><span class="o">:</span>       <span class="nx">observe</span><span class="p">.</span><span class="nx">methodize</span><span class="p">(),</span>

    <span class="nx">stopObserving</span><span class="o">:</span> <span class="nx">stopObserving</span><span class="p">.</span><span class="nx">methodize</span><span class="p">(),</span>

    <span class="nx">on</span><span class="o">:</span>            <span class="nx">on</span><span class="p">.</span><span class="nx">methodize</span><span class="p">(),</span>

    <span class="nx">loaded</span><span class="o">:</span>        <span class="kc">false</span>
  <span class="p">});</span>

  <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">Event</span><span class="p">)</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">Event</span><span class="p">,</span> <span class="nx">Event</span><span class="p">);</span>
  <span class="k">else</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Event</span> <span class="o">=</span> <span class="nx">Event</span><span class="p">;</span>
<span class="p">})();</span>

<span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="cm">/* Support for the DOMContentLoaded event is based on work by Dan Webb,</span>
<span class="cm">     Matthias Miller, Dean Edwards, John Resig, and Diego Perini. */</span>

  <span class="kd">var</span> <span class="nx">timer</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">fireContentLoadedEvent</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">loaded</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">timer</span><span class="p">)</span> <span class="nb">window</span><span class="p">.</span><span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">timer</span><span class="p">);</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">loaded</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="s1">&#39;dom:loaded&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">checkReadyState</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="s1">&#39;complete&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">stopObserving</span><span class="p">(</span><span class="s1">&#39;readystatechange&#39;</span><span class="p">,</span> <span class="nx">checkReadyState</span><span class="p">);</span>
      <span class="nx">fireContentLoadedEvent</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">pollDoScroll</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">doScroll</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">timer</span> <span class="o">=</span> <span class="nx">pollDoScroll</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">fireContentLoadedEvent</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;DOMContentLoaded&#39;</span><span class="p">,</span> <span class="nx">fireContentLoadedEvent</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class="s1">&#39;readystatechange&#39;</span><span class="p">,</span> <span class="nx">checkReadyState</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">window</span> <span class="o">==</span> <span class="nx">top</span><span class="p">)</span>
      <span class="nx">timer</span> <span class="o">=</span> <span class="nx">pollDoScroll</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">Event</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="nx">fireContentLoadedEvent</span><span class="p">);</span>
<span class="p">})();</span>

<span class="nx">Element</span><span class="p">.</span><span class="nx">addMethods</span><span class="p">();</span>

<span class="cm">/*------------------------------- DEPRECATED -------------------------------*/</span>

<span class="nx">Hash</span><span class="p">.</span><span class="nx">toQueryString</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">toQueryString</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">Toggle</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">display</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">toggle</span> <span class="p">};</span>

<span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">childOf</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">descendantOf</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">Insertion</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">Before</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="p">{</span><span class="nx">before</span><span class="o">:</span><span class="nx">content</span><span class="p">});</span>
  <span class="p">},</span>

  <span class="nx">Top</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="p">{</span><span class="nx">top</span><span class="o">:</span><span class="nx">content</span><span class="p">});</span>
  <span class="p">},</span>

  <span class="nx">Bottom</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="p">{</span><span class="nx">bottom</span><span class="o">:</span><span class="nx">content</span><span class="p">});</span>
  <span class="p">},</span>

  <span class="nx">After</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="p">{</span><span class="nx">after</span><span class="o">:</span><span class="nx">content</span><span class="p">});</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">$continue</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;&quot;throw $continue&quot; is deprecated, use &quot;return&quot; instead&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">Position</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">includeScrollOffsets</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>

  <span class="nx">prepare</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">deltaX</span> <span class="o">=</span>  <span class="nb">window</span><span class="p">.</span><span class="nx">pageXOffset</span>
                <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">scrollLeft</span>
                <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">scrollLeft</span>
                <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">deltaY</span> <span class="o">=</span>  <span class="nb">window</span><span class="p">.</span><span class="nx">pageYOffset</span>
                <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">scrollTop</span>
                <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">scrollTop</span>
                <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">within</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">includeScrollOffsets</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">withinIncludingScrolloffsets</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xcomp</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ycomp</span> <span class="o">=</span> <span class="nx">y</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">offset</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">cumulativeOffset</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">(</span><span class="nx">y</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
            <span class="nx">y</span> <span class="o">&lt;</span>  <span class="k">this</span><span class="p">.</span><span class="nx">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">element</span><span class="p">.</span><span class="nx">offsetHeight</span> <span class="o">&amp;&amp;</span>
            <span class="nx">x</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
            <span class="nx">x</span> <span class="o">&lt;</span>  <span class="k">this</span><span class="p">.</span><span class="nx">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">element</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">withinIncludingScrolloffsets</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">offsetcache</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">cumulativeScrollOffset</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">xcomp</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">offsetcache</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">deltaX</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ycomp</span> <span class="o">=</span> <span class="nx">y</span> <span class="o">+</span> <span class="nx">offsetcache</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">deltaY</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">offset</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">cumulativeOffset</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ycomp</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">ycomp</span> <span class="o">&lt;</span>  <span class="k">this</span><span class="p">.</span><span class="nx">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">element</span><span class="p">.</span><span class="nx">offsetHeight</span> <span class="o">&amp;&amp;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">xcomp</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">xcomp</span> <span class="o">&lt;</span>  <span class="k">this</span><span class="p">.</span><span class="nx">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">element</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">overlap</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mode</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">==</span> <span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">element</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">)</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">ycomp</span><span class="p">)</span> <span class="o">/</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">==</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">element</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">)</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">xcomp</span><span class="p">)</span> <span class="o">/</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">;</span>
  <span class="p">},</span>


  <span class="nx">cumulativeOffset</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">cumulativeOffset</span><span class="p">,</span>

  <span class="nx">positionedOffset</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">positionedOffset</span><span class="p">,</span>

  <span class="nx">absolutize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Position</span><span class="p">.</span><span class="nx">prepare</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">absolutize</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">relativize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Position</span><span class="p">.</span><span class="nx">prepare</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">relativize</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">realOffset</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">cumulativeScrollOffset</span><span class="p">,</span>

  <span class="nx">offsetParent</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">getOffsetParent</span><span class="p">,</span>

  <span class="nx">page</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">.</span><span class="nx">viewportOffset</span><span class="p">,</span>

  <span class="nx">clone</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{</span> <span class="p">};</span>
    <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">clonePosition</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*--------------------------------------------------------------------------*/</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByClassName</span><span class="p">)</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByClassName</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">instanceMethods</span><span class="p">){</span>
  <span class="kd">function</span> <span class="nx">iter</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">name</span><span class="p">.</span><span class="nx">blank</span><span class="p">()</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="s2">&quot;[contains(concat(&#39; &#39;, @class, &#39; &#39;), &#39; &quot;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot; &#39;)]&quot;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">instanceMethods</span><span class="p">.</span><span class="nx">getElementsByClassName</span> <span class="o">=</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">BrowserFeatures</span><span class="p">.</span><span class="nx">XPath</span> <span class="o">?</span>
  <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">className</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">className</span> <span class="o">=</span> <span class="nx">className</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">strip</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">cond</span> <span class="o">=</span> <span class="sr">/\s/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">className</span><span class="p">)</span> <span class="o">?</span> <span class="nx">$w</span><span class="p">(</span><span class="nx">className</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">iter</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="nx">iter</span><span class="p">(</span><span class="nx">className</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">cond</span> <span class="o">?</span> <span class="nb">document</span><span class="p">.</span><span class="nx">_getElementsByXPath</span><span class="p">(</span><span class="s1">&#39;.//*&#39;</span> <span class="o">+</span> <span class="nx">cond</span><span class="p">,</span> <span class="nx">element</span><span class="p">)</span> <span class="o">:</span> <span class="p">[];</span>
  <span class="p">}</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">className</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">className</span> <span class="o">=</span> <span class="nx">className</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">strip</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">elements</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">classNames</span> <span class="o">=</span> <span class="p">(</span><span class="sr">/\s/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">className</span><span class="p">)</span> <span class="o">?</span> <span class="nx">$w</span><span class="p">(</span><span class="nx">className</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">classNames</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">className</span><span class="p">)</span> <span class="k">return</span> <span class="nx">elements</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">nodes</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">);</span>
    <span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">className</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">child</span><span class="p">,</span> <span class="nx">cn</span><span class="p">;</span> <span class="nx">child</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">className</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">cn</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">child</span><span class="p">.</span><span class="nx">className</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">cn</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="nx">className</span><span class="p">)</span> <span class="o">||</span>
          <span class="p">(</span><span class="nx">classNames</span> <span class="o">&amp;&amp;</span> <span class="nx">classNames</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">!</span><span class="nx">name</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">blank</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">cn</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="p">);</span>
          <span class="p">}))))</span>
        <span class="nx">elements</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">child</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">elements</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">className</span><span class="p">,</span> <span class="nx">parentElement</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="nx">parentElement</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">).</span><span class="nx">getElementsByClassName</span><span class="p">(</span><span class="nx">className</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">}(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">Methods</span><span class="p">);</span>

<span class="cm">/*--------------------------------------------------------------------------*/</span>

<span class="nx">Element</span><span class="p">.</span><span class="nx">ClassNames</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">ClassNames</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">_each</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">iterator</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">className</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">).</span><span class="nx">select</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">name</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}).</span><span class="nx">_each</span><span class="p">(</span><span class="nx">iterator</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">className</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="nx">className</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">add</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">classNameToAdd</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="nx">classNameToAdd</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">$A</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span><span class="nx">classNameToAdd</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">));</span>
  <span class="p">},</span>

  <span class="nx">remove</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">classNameToRemove</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="nx">classNameToRemove</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">$A</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">without</span><span class="p">(</span><span class="nx">classNameToRemove</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">));</span>
  <span class="p">},</span>

  <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">$A</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">ClassNames</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">Enumerable</span><span class="p">);</span>

<span class="cm">/*--------------------------------------------------------------------------*/</span>

<span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">Selector</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">expression</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">expression</span> <span class="o">=</span> <span class="nx">expression</span><span class="p">.</span><span class="nx">strip</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">findElements</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">rootElement</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">Selector</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span> <span class="nx">rootElement</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">match</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">Selector</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">expression</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">expression</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">inspect</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">&quot;#&lt;Selector: &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">expression</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Selector</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">matchElements</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elements</span><span class="p">,</span> <span class="nx">expression</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">Selector</span><span class="p">.</span><span class="nx">match</span><span class="p">,</span>
          <span class="nx">results</span> <span class="o">=</span> <span class="p">[];</span>

      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">elements</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">elements</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">match</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">expression</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">element</span><span class="p">));</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">findElement</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elements</span><span class="p">,</span> <span class="nx">expression</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">index</span> <span class="o">=</span> <span class="nx">index</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">matchIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">element</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">elements</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">element</span> <span class="o">=</span> <span class="nx">elements</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">Prototype</span><span class="p">.</span><span class="nx">Selector</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">expression</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">index</span> <span class="o">===</span> <span class="nx">matchIndex</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>

    <span class="nx">findChildElements</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">expressions</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">selector</span> <span class="o">=</span> <span class="nx">expressions</span><span class="p">.</span><span class="nx">toArray</span><span class="p">().</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">Prototype</span><span class="p">.</span><span class="nx">Selector</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span> <span class="nx">element</span> <span class="o">||</span> <span class="nb">document</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">})();</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 